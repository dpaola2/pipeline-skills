# Deficient Line Item Report Feature Flag - Discovery Report

> **Generated by:** Pipeline Stage 1 (Discovery)
> **Date:** February 6, 2026
> **PRD:** `projects/deficient-line-items-report-feature-flag/prd.md`
> **Linear:** TBD

---

## 1. PRD Understanding

### Feature Summary

Add an account-level boolean feature flag (`deficient_line_items_report_enabled`) to gate access to the Deficient Line Item Report. The flag defaults to disabled. When disabled, the report is invisible in the Reports menu and all routes return 404. The flag is managed by OrangeQC staff, not self-service.

### Entities Identified

| Entity | PRD Reference | Existing? | Current Location |
|--------|--------------|-----------|-----------------|
| Account (feature flag column) | FLAG-001 | Partially — table exists, column does not | `db/schema.rb` lines 42-102 |
| Reports::DeficientLineItemsController | FLAG-003 | Yes (on pipeline branch) | `app/controllers/reports/deficient_line_items_controller.rb` |
| Reports::DeficientLineItemSettingsController | FLAG-004 | Yes (on pipeline branch) | `app/controllers/reports/deficient_line_item_settings_controller.rb` |
| Reports index view | FLAG-002 | Yes (modified on pipeline branch) | `app/views/reports/index.html.erb` |
| DefaultAccountFactory | FLAG-005 | Yes | `app/services/factories/default_account_factory.rb` |

### Platforms Affected

- [x] Rails (Web Admin)
- [ ] Rails (API)
- [ ] iOS
- [ ] Android

N/A — Level 1 project. Web-only, no API or mobile impact.

---

## 2. Current State: Rails

### Related Models

| Model | File | Key Associations | Notes |
|-------|------|------------------|-------|
| Account | `app/models/account.rb` | `has_many :users`, `has_one :company` | 17 boolean feature flags already exist on this table. No explicit feature flag methods — Rails auto-generates `?` predicates from boolean columns. |
| ReportSetting | `app/models/report_setting.rb` (pipeline branch) | `belongs_to :user` | User-level report threshold settings. Unaffected by this change. |

### Current Schema (Accounts Table — Feature Flag Columns)

```sql
-- From db/schema.rb, accounts table (lines 42-102)
-- Showing only the boolean feature flag columns:
t.boolean "tickets_enabled", default: true
t.boolean "surveys_enabled", default: false
t.boolean "web_inspections_enabled", default: true
t.boolean "private_inspections_enabled", default: false
t.boolean "mobile_ticket_access", default: false
t.boolean "api_access", default: false
t.boolean "flag_deficient_inspections", default: false
t.boolean "scheduled_inspections_enabled", default: false
t.boolean "template_library_enabled", default: false
t.boolean "ticket_tasks_enabled", default: false, null: false
t.boolean "ticket_backlog_status_enabled", default: false, null: false
t.boolean "qr_codes_enabled", default: false
t.boolean "visit_tracking_enabled", default: false, null: false
t.boolean "service_validations_enabled", default: false, null: false
t.boolean "accessibility_features_enabled", default: false
t.boolean "tailwind_enabled", default: false
t.boolean "landing_pages_enabled", default: false
```

### Related Controllers

| Controller | File | Actions | Auth Pattern |
|-----------|------|---------|--------------|
| Reports::DeficientLineItemsController | `app/controllers/reports/deficient_line_items_controller.rb` (pipeline branch) | `index`, `show` | `before_action :require_read_inspections_permission` |
| Reports::DeficientLineItemSettingsController | `app/controllers/reports/deficient_line_item_settings_controller.rb` (pipeline branch) | `update` | Inherits from `Reports::BaseController` |
| Account::FeaturesController | `app/controllers/account/features_controller.rb` | `show`, `update` | Inherits from `Account::BaseController` |

### Reports::BaseController Pattern

`Reports::BaseController` provides shared before_actions including `require_read_reports_permission`, `set_default_date_range` (45-day default), and `redirect_if_account_expired`. The deficient line items controller uses `require_read_inspections_permission` instead of the reports-level permission.

### Reports Index View (Pipeline Branch)

The deficient line items report entry was added to `reports/index.html.erb` with only a user permission check:

```erb
<% if current_user.can?(:read, :inspections) %>
  <%= link_to reports_deficient_line_items_path, class: "list-group-item" do %>
    ...
  <% end %>
<% end %>
```

Other reports use **dual gating** (account flag + user permission):

```erb
<% if current_account.tickets_enabled && current_user.can?(:read, :tickets) %>
  <!-- Tickets Report -->
<% end %>

<% if current_user.can?(:read, :inspections) && current_account.list_report? %>
  <!-- List Report -->
<% end %>
```

The deficient line items entry is missing the account-level gate. This PRD adds it.

### Account Features Controller Pattern

`Account::FeaturesController#update` (lines 10-35) assigns feature flags conditionally:

```ruby
# Always-togglable flags:
account.tickets_enabled = params[:account][:tickets_enabled]

# Conditionally-togglable flags (only if already enabled):
if current_account.ticket_tasks_enabled?
  account.ticket_tasks_enabled = params[:account][:ticket_tasks_enabled]
end
```

**Note:** The PRD specifies this flag is NOT exposed on the Account Features page. It is managed by OrangeQC staff only. Therefore, no changes are needed to the features controller or view.

### DefaultAccountFactory

`app/services/factories/default_account_factory.rb` — `set_account_defaults` method (lines 29-45):

```ruby
def set_account_defaults
  account.update(
    private_inspections_enabled: true,
    scheduled_inspections_enabled: true,
    template_library_enabled: true,
    tickets_enabled: true,
    mobile_ticket_access: true,
    ticket_tasks_enabled: true,
    qr_codes_enabled: true,
    visit_tracking_enabled: false,
    service_validations_enabled: false,
    # ... pricing defaults ...
  )
end
```

The new flag should be added here with `deficient_line_items_report_enabled: false`.

### Related Tests

| Test File | Coverage | Type |
|-----------|----------|------|
| `spec/requests/reports/deficient_line_items_controller_spec.rb` (pipeline branch) | Route existence, sorting, pagination, summary cards | Request spec |
| `spec/services/analytics/deficient_line_items_spec.rb` (pipeline branch) | Service logic, scoping, calculations | Service spec |
| `spec/models/report_setting_spec.rb` (pipeline branch) | Model validations, defaults | Model spec |

**Test pattern:** Request spec uses `include_context :default_context` (provides `account`, `user`, `company`). Creates test data with `create_deficient_data` helper.

### Related Background Jobs

None. No background jobs are involved in feature flag checking.

---

## 3. Current State: iOS

N/A — Level 1 project. No mobile impact.

---

## 4. Current State: Android

N/A — Level 1 project. No mobile impact.

---

## 5. Cross-Platform Patterns

### How Account Feature Flags Work

```
Migration adds boolean column to accounts table (default: false)
    ↓
Rails auto-generates `account.deficient_line_items_report_enabled?` predicate
    ↓
Controller checks predicate in before_action → render_404 if false
    ↓
View checks predicate to conditionally render menu entries
    ↓
DefaultAccountFactory sets default for new accounts
```

### How Similar Features Are Gated

**Tickets Report** — dual gate (account flag + user permission):
- View: `current_account.tickets_enabled && current_user.can?(:read, :tickets)`
- Controller: `before_action` checks tickets_enabled

**Visit Tracking** — dual gate:
- Controller: `render_404 unless current_user.can?(:view, :visits) && current_user.account.visit_tracking_enabled?`

**Inspection Scheduling** — account flag only for controller gate:
- Controller: `return if current_account.scheduled_inspections_enabled? && current_user.can?(:access_inspection_events)`

**Pattern:** The `render_404` call is the standard rejection pattern for disabled features. Not a redirect — a hard 404.

---

## 6. Technical Risks

| Risk | Severity | Details | Mitigation |
|------|----------|---------|------------|
| None significant | — | This is a single boolean column addition + 3 guard clauses. Well-established pattern with 17 existing precedents. | — |

### Performance Concerns

None. Boolean column check on an already-loaded `current_account` record. No additional queries.

### Security Concerns

None introduced. The flag adds a gate; it does not remove one. Existing user-level permission checks remain.

---

## 7. Open Questions

| # | Question | Source | Blocking? |
|---|----------|--------|-----------|
| 1 | Should existing test specs be updated to set the flag to `true` in their setup? Tests on the pipeline branch were written without this flag and will fail if the flag defaults to `false` and the test's `account` doesn't enable it. | Test compatibility | Yes — must be addressed in implementation |

---

## 8. Recommendations for Architecture Stage

- Follow the `visit_tracking_enabled` pattern: migration, controller `before_action`, view conditional
- The flag does NOT go on the Account Features page (per PRD) — skip the features controller/view changes
- Add the flag to `DefaultAccountFactory#set_account_defaults` with `false`
- Existing request specs will need their test account to have `deficient_line_items_report_enabled: true` — otherwise all existing tests break
- All work goes on the existing `pipeline/deficient-line-items-report` branch (do NOT create a new branch)
- The migration should follow the naming convention: `add_deficient_line_items_report_enabled_to_accounts`
