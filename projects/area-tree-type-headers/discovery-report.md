# Area Tree Type Headers & Icons - Discovery Report

> **Generated by:** Pipeline Stage 1 (Discovery)
> **Date:** February 6, 2026
> **PRD:** `projects/area-tree-type-headers/prd.md`
> **Linear:** [WEB-106](https://linear.app/orangeqc/issue/WEB-106/area-tree-should-have-headers-and-different-icons-for-each-of)

---

## 1. PRD Understanding

### Feature Summary
Add section headers ("Inspections", "Surveys", "Checklists") and distinct FontAwesome icons to the Setup > Sites area tree so users can visually distinguish between the three types of assignable forms. Currently, surveys and inspection forms share the same icon and appear in a flat, unlabeled list. Both mobile apps already have section headers for these groups.

### Entities Identified
| Entity | PRD Reference | Existing? | Current Location |
|--------|--------------|-----------|-----------------|
| Structure (Area) | HDR-001, GRP-001 | Yes | `app/models/structure.rb` |
| InspectionForm | ICN-001, GRP-001 | Yes | `app/models/inspection_form.rb` |
| Survey (STI subclass) | ICN-002, GRP-001 | Yes | `app/models/survey.rb` |
| InspectionFormsStructures (join) | GRP-001, INT-004 | Yes | `app/models/inspection_forms_structures.rb` |
| Checklist | ICN-003, GRP-003 | Yes | `app/models/checklist.rb` |
| ChecklistAssignment (join) | GRP-003, HDR-005 | Yes | `app/models/checklist_assignment.rb` |

### Platforms Affected
- [x] Rails (Web Admin)
- [ ] Rails (API)
- [ ] iOS — N/A (Level 2, web-only; iOS already has section headers)
- [ ] Android — N/A (Level 2, web-only; Android already has section headers)

---

## 2. Current State: Rails

### Related Models
| Model | File | Key Associations | Notes |
|-------|------|------------------|-------|
| Structure | `app/models/structure.rb` | `has_many :inspection_forms_structures`, `has_many :checklist_assignments`, `has_many :assigned_forms` (through IFS), `has_many :inspection_forms` (created at), `has_many :surveys` (created at) | Uses `ancestry` gem for tree hierarchy. `active_children_count` counter cache. Soft-delete via `Archivable`. |
| InspectionForm | `app/models/inspection_form.rb` | `belongs_to :structure` (created at), `has_many :inspection_forms_structures` | STI base class. `type` column: `nil` = inspection form, `'Survey'` = survey. Scopes: `.surveys`, `.non_surveys`. |
| Survey | `app/models/survey.rb` | Inherits all from InspectionForm | Minimal STI subclass (5 lines). Only overrides `to_s`. |
| InspectionFormsStructures | `app/models/inspection_forms_structures.rb` | `belongs_to :inspection_form`, `belongs_to :structure` | Join model for form-to-area assignment. Scopes: `.non_surveys` (joins inspection_form, filters `type: nil`), `.ordered_by_form_name`. Soft-delete via `Archivable`. |
| Checklist | `app/models/checklist.rb` | `belongs_to :account`, `has_many :checklist_assignments` | UUID primary key. Soft-delete. |
| ChecklistAssignment | `app/models/checklist_assignment.rb` | `belongs_to :checklist`, `belongs_to :structure` | UUID primary key. Scope: `.ordered_by_checklist_name`. Soft-delete. |

#### Key Model Associations on Structure

```ruby
# Structure model — associations relevant to the area tree

# Assignments (what's assigned TO this area)
has_many :inspection_forms_structures     # all join records (including surveys)
has_many :active_inspection_forms_structures,
  -> { where(deleted_at: nil) }           # non-deleted join records
has_many :active_non_survey_ifs,
  -> { joins(:inspection_form).where(deleted_at: nil, inspection_forms: {type: nil}) }
                                          # non-deleted, non-survey join records
has_many :assigned_forms,
  -> { where(deleted_at: nil) },
  through: :inspection_forms_structures   # actual InspectionForm objects

has_many :checklist_assignments
has_many :assigned_checklists,
  -> { where(deleted_at: nil) },
  through: :checklist_assignments

# Forms created at this structure level (NOT assignments)
has_many :inspection_forms                # forms whose structure_id = this area
has_many :surveys                         # surveys whose structure_id = this area
```

**Important distinction:** `structure.inspection_forms` = forms *created at* this structure. `structure.assigned_forms` = forms *assigned to* this structure (via the join table). The area tree displays assignments, not creation-level ownership.

**Existing scope for the split:** `Structure` already has `active_non_survey_ifs` which joins to InspectionForm and filters `type: nil`. The `InspectionFormsStructures` model has a `.non_surveys` scope. These can be used to split the tree list without new scope definitions.

### Current Schema (Related Tables)

```sql
-- structures (Tier 1 — 740K rows, 697 MB total)
-- Uses ancestry gem for tree hierarchy, soft-delete via deleted_at
create_table "structures", id: :serial do |t|
  t.string   "name", limit: 255
  t.string   "structure_type", limit: 255      -- 'Project' (site), 'Company', nil (area)
  t.datetime "deleted_at"
  t.integer  "account_id", default: 0
  t.string   "ancestry", limit: 255            -- ancestry gem path
  t.text     "structure_path"
  t.string   "site_name", limit: 255
  t.integer  "active_children_count", default: 0, null: false
  -- indexes on account_id, ancestry (btree + gist)
end

-- inspection_forms (54K rows, 27 MB total)
-- STI: type = nil for inspection forms, 'Survey' for surveys
create_table "inspection_forms", id: :serial do |t|
  t.string   "name", limit: 255
  t.integer  "structure_id"                    -- where the form was created
  t.datetime "deleted_at"
  t.string   "type", limit: 255               -- STI column
  -- index on (id, type), index on type
end

-- inspection_forms_structures (1.8M rows, 422 MB total — Tier 2)
-- Join table: which forms are assigned to which areas
create_table "inspection_forms_structures", id: :serial do |t|
  t.integer  "inspection_form_id"
  t.integer  "structure_id"
  t.datetime "deleted_at"
  -- indexes on inspection_form_id, structure_id, deleted_at
end

-- checklist_assignments (8K rows, 1.7 MB — Tier 2)
create_table "checklist_assignments", id: :uuid do |t|
  t.uuid     "checklist_id", null: false
  t.integer  "structure_id", null: false
  t.datetime "deleted_at"
end

-- checklists (144 rows, 176 KB — Tier 2)
create_table "checklists", id: :uuid do |t|
  t.string   "name", null: false
  t.integer  "account_id", null: false
  t.datetime "deleted_at"
end
```

### Related Controllers

| Controller | File | Actions | Auth Pattern |
|-----------|------|---------|--------------|
| Setup::StructuresController | `app/controllers/setup/structures_controller.rb` | show, right_pane, children, create, destroy | `require_administer_permission`, `Structure.accessible_to(current_user)` |
| Setup::InspectionFormAssignmentsController | `app/controllers/setup/inspection_form_assignments_controller.rb` | create, destroy | `require_administer_permission`, `Structure.accessible_to`, `InspectionForm.accessible_to` |
| Setup::ChecklistAssignmentsController | `app/controllers/setup/checklist_assignments_controller.rb` | create, destroy | `require_administer_permission`, `Structure.accessible_to`, account-scoped checklists |
| Setup::AssignedSurveysController | `app/controllers/setup/assigned_surveys_controller.rb` | create, destroy | `require_administer_permission`, `Survey.accessible_to` |

**Key controller details:**

- `StructuresController#show` renders the full area tree page. Passes `@inspection_forms` (scoped to `non_surveys`) and `@checklists` to the "Assign" dropdowns.
- `StructuresController#children` returns the `_children.html.erb` partial (layout: false) for lazy-loading child nodes via AJAX.
- `StructuresController#right_pane` returns `right_pane.html.erb` (layout: false) for the right editing pane.
- `InspectionFormAssignmentsController#create` renders the `_inspection_form_assignment.html.erb` partial (layout: false) — this is the HTML fragment the Stimulus controller inserts into the DOM.
- `AssignedSurveysController#create` renders `create.js.erb` which only updates `.js-right-pane-surveys` — the tree is NOT updated.

### Related Routes

```ruby
# config/routes.rb (setup namespace, lines 467-544)
namespace :setup do
  resources :inspection_form_assignments, only: %i[create destroy]
  resources :checklist_assignments, only: %i[create destroy]

  resources :structures, only: %i[show create destroy] do
    member do
      get :right_pane
      get :children
    end
  end

  resources :structures, only: [:show] do
    resources :assigned_surveys, only: %i[create destroy]
  end
end
```

### Related Serializers / Blueprints

**Not applicable.** This feature changes only the web admin UI. No API serialization is involved. The area tree is rendered server-side via ERB partials.

### Related API Endpoints (Current)

**Not applicable.** The area tree is a web-only admin view. API endpoints for structures/inspection_forms_structures/checklist_assignments exist but are not affected.

### Related Views

| View | File | Purpose | Lines |
|------|------|---------|-------|
| Structure tree page | `app/views/setup/structures/show.html.erb` | Main page: `.AreaTree` wrapper div, renders root node, right-pane container | 71 |
| Structure node | `app/views/setup/structures/_structure_node.html.erb` | **Core template.** Renders one tree node: name, expand/collapse, action buttons, checklists list, inspection forms list, children list. | 110 |
| Children partial | `app/views/setup/structures/_children.html.erb` | Lazy-loaded child nodes. Iterates `@structure.children.active` and renders `_structure_node` for each. | 12 |
| Inspection form assignment | `app/views/setup/inspection_form_assignments/_inspection_form_assignment.html.erb` | Single assigned form in tree: icon (`fal fa-file-alt`), name, trash button. **Does not check form type.** | 12 |
| Checklist assignment | `app/views/setup/checklist_assignments/_checklist_assignment.html.erb` | Single assigned checklist in tree: icon (`far fa-clipboard-list-check`), name, trash button. | 12 |
| Right pane | `app/views/setup/structures/right_pane.html.erb` | Right-side editing form. Includes survey assignment at bottom (lines 184-189, conditional on `surveys_enabled`). | 235 |
| Survey assignment | `app/views/setup/assigned_surveys/_surveys.html.erb` | Right-pane survey section: list of assigned surveys, assign dropdown. Uses `remote: true`. | 31 |
| Survey create JS | `app/views/setup/assigned_surveys/create.js.erb` | jQuery response: replaces `.js-right-pane-surveys` HTML. Does NOT update the tree. | 1 |

#### Current DOM Structure Within a Tree Node

```
<div data-controller="structure-tree">
  <p class="AreaTree__node__name">          ← node name row (click to expand/select)
  <div class="collapse">                    ← collapsible content
    <ul>                                    ← action buttons
      <li> Add Area form </li>
      <li> Assign Inspection Form form </li>
      <li> Assign Checklist form </li>      ← conditional: service_validations_enabled
    </ul>
    <ul class="checklists"                  ← assigned checklists
         data-structure-tree-target="checklists">
      <li>...</li>
    </ul>
    <ul class="inspection-forms"            ← ALL assigned forms (inspections + surveys)
         data-structure-tree-target="inspectionForms">
      <li>...</li>                          ← uses fal fa-file-alt for ALL types
    </ul>
    <ul class="children"                    ← lazy-loaded child areas
         data-structure-tree-target="children">
    </ul>
  </div>
</div>
```

**Current rendering order:** action buttons → checklists → inspection forms (including surveys) → children.

### Related JavaScript

| File | Purpose | Lines |
|------|---------|-------|
| `app/javascript/controllers/structure_tree_controller.js` | Stimulus controller for each tree node. Handles expand/collapse, CRUD for areas/forms/checklists, right-pane loading, sort, selection. | 405 |
| `app/javascript/services/structure_tree_service.js` | Service for fetching children HTML and sorting node/assignment lists alphabetically. | 80 |

#### Stimulus Controller Targets

```javascript
static targets = [
  "icon",                         // expand/collapse chevron or folder icon
  "newArea",                      // "Add Area" action <li>
  "newInspectionFormAssignment",  // "Assign Inspection Form" action <li>
  "newChecklistAssignment",       // "Assign Checklist" action <li>
  "collapse",                     // collapsible <div>
  "node",                         // <p> node name row
  "link",                         // <a> inside node name
  "trashable",                    // selectable assignment divs
  "checklist",                    // NOTE: declared as singular but template uses "checklists"
  "inspectionForms",              // <ul class="inspection-forms">
  "children"                      // <ul class="children">
]
```

#### Methods That Reference `inspectionForms` Target

| Method | Line | What It Does | Impact of DOM Split |
|--------|------|--------------|---------------------|
| `createInspectionFormAssignment()` | 295 | POSTs new assignment, prepends `<li>` into `this.element.querySelector('ul.inspection-forms')`, then calls `sortInspectionForms()` | **Must update selector** to target correct `<ul>` (inspections, not surveys) |
| `sortInspectionForms()` | 291 | Calls `StructureTreeService.sortAssignmentsByName(this.inspectionFormsTarget)` | **Must target inspections-only `<ul>`** |
| `destroyInspectionFormAssignment()` | 327 | Removes `<li>`, then checks `this.inspectionFormsTarget.children.length === 0` to un-hide "Add Area" | **Must check both inspections AND surveys lists** (or just non-survey list, matching `hide_new_area` logic) |

### Related Helper

```ruby
# app/helpers/setup/structures_helper.rb
module Setup::StructuresHelper
  def hide_new_inspection_form(structure)
    structure.children.active.any? ? "hidden" : nil
  end

  def hide_new_area(structure)
    structure.assigned_forms.non_surveys.any? ? "hidden" : nil
  end
end
```

**Business rule:** Mutual exclusion between child areas and assigned inspection forms (non-surveys). A node can have child areas OR assigned non-survey forms, but not both. Surveys are exempt from this rule — a node can have surveys AND child areas simultaneously. Checklists are also exempt.

### Related CSS

All area tree CSS is **inline** in `show.html.erb` (lines 22-71). No external CSS/SCSS files. Key classes:
- `.AreaTree` — wrapper container
- `.AreaTree__node__name` — node name row (with `.active` state)
- `.inspection-form-assignment` — form assignment item (`.destroy-link` shown on `.active`)
- `.checklist-assignment` — checklist assignment item (same `.destroy-link` pattern)
- `li.list-action` — action button items

### Related Tests

| Test File | Coverage | Type |
|-----------|----------|------|
| `spec/models/structure_spec.rb` | `.accessible_to`, subtree queries, counter caching, ancestry | Model spec (638 lines) |
| `spec/models/inspection_forms_structures_spec.rb` | `.accessible_to`, `.within_subtrees` | Model spec (146 lines) |
| `spec/models/checklist_assignment_spec.rb` | **Pending/empty** | Model spec (5 lines) |
| `spec/features/setup/sites_spec.rb` | Site index, create, archive, restore. **No tree interaction tests.** | Feature spec (83 lines) |

**No controller/request specs exist** for `StructuresController`, `InspectionFormAssignmentsController`, `ChecklistAssignmentsController`, or `AssignedSurveysController`.

**No JavaScript/system specs exist** for `structure_tree_controller.js` or `structure_tree_service.js`.

### Related Background Jobs

**Not applicable.** No background jobs are involved in the area tree rendering.

---

## 3. Current State: iOS

N/A — Level 2 (web-only) project. iOS already has section headers:
- `StructureScreen.swift` uses SwiftUI `Section` with headers: `Text("Inspections")`, `Text("Checklists")`
- Checklists use SF Symbol `list.bullet.clipboard`

---

## 4. Current State: Android

N/A — Level 2 (web-only) project. Android already has section headers:
- `InspectionsSection.kt` renders `SectionHeader("Inspections")`
- `ChecklistsSection.kt` renders `SectionHeader("Checklists")`
- Checklists use `painterResource(R.drawable.clipboard_24px)`

---

## 5. Cross-Platform Patterns

### Data Flow
```
Structure (area) ← InspectionFormsStructures (join) → InspectionForm (type: nil or 'Survey')
Structure (area) ← ChecklistAssignment (join) → Checklist
```

The area tree is purely a web admin view. It reads from the database and renders server-side HTML. AJAX operations (assign, unassign, expand) return HTML partials or JS responses that manipulate the DOM directly.

### How Similar Features Are Built

The area tree follows a consistent pattern for all three assignment types:
1. **Server renders** the initial list via ERB partial inside `_structure_node.html.erb`
2. **Stimulus controller** handles CRUD via fetch API (POST/DELETE), receives HTML partial response
3. **DOM manipulation** — new items are prepended to the target `<ul>`, sorted alphabetically, then optionally hidden/shown
4. **Sorting** — `StructureTreeService.sortAssignmentsByName()` sorts by `.assignment-title` text content

**Exception:** Surveys are managed through the right pane, not the tree. The right pane uses Rails UJS (`remote: true`) and `create.js.erb` jQuery response, not the Stimulus controller. The tree is not updated when surveys are assigned/unassigned — it picks up changes on next server-side re-render (collapse/expand).

### Reference Pattern: How Mobile Apps Handle This

Both iOS and Android group form assignments under typed section headers within each area node. This is the target pattern for the web area tree:

| Platform | Inspections Header | Checklists Header | Surveys Header | Distinct Icons |
|----------|-------------------|-------------------|----------------|----------------|
| iOS | `Text("Inspections")` | `Text("Checklists")` | N/A (not shown) | SF Symbols |
| Android | `SectionHeader("Inspections")` | `SectionHeader("Checklists")` | N/A (not shown) | Drawable resources |
| Web (current) | None | None | None | Checklists only |
| Web (proposed) | "Inspections" | "Checklists" | "Surveys" | All three |

**Note:** Neither mobile app displays surveys in the area node. The web tree displays surveys because `inspection_forms_structures.active` includes all types. This is a web-specific behavior.

---

## 6. Technical Risks

| Risk | Severity | Details | Mitigation |
|------|----------|---------|------------|
| Stimulus target breakage | Med | `inspectionForms` target points to the single `<ul class="inspection-forms">`. Splitting into two `<ul>` elements requires updating the target binding and all methods that reference it. | Update target declarations and method selectors. Test all three CRUD flows (assign, sort, destroy) after changes. |
| CSS selector breakage | Low | `.inspection-form-assignment` class is used for both trash-icon show/hide and click selection. The split doesn't change this class — it stays on individual items regardless of which `<ul>` they're in. | Verify `.inspection-form-assignment` and `.checklist-assignment` styles still apply after DOM restructure. |
| Survey right-pane assignment doesn't update tree | Low | Pre-existing behavior, not introduced by this change. Tree picks up changes on next expand/collapse. | Document clearly in PRD (already done in INT-006). No fix needed. |
| DOM order change | Low | Current order is checklists → inspection forms → children. Proposed order is inspections → surveys → checklists → children. Visual change for existing users. | Intentional design decision per HDR-004. Matches sidebar nav order. |
| `hide_new_area` logic dependency | Low | `destroyInspectionFormAssignment()` checks `inspectionFormsTarget.children.length === 0` to un-hide "Add Area". After the split, this check must consider both inspection and survey lists (or just inspection list, since `hide_new_area` only checks `non_surveys`). | Verify: `hide_new_area` checks `assigned_forms.non_surveys.any?` — so only the non-survey list matters for this logic. Update the JS check to match. |

### Performance Concerns

**None.** The current template already iterates `inspection_forms_structures.active` once per node. Splitting into two groups (with `.non_surveys` and a survey filter) adds one additional scope per node. Given that each node typically has <10 assignments, this is negligible. The `inspection_forms.type` column is indexed.

### Security Concerns

**None.** This is a view-only change. All authorization (`accessible_to`, `require_administer_permission`) remains unchanged. No new data access paths are introduced.

---

## 7. Open Questions

| # | Question | Source | Blocking? |
|---|----------|--------|-----------|
| 1 | The `checklist` target in `static targets` is declared singular, but the template uses `data-structure-tree-target="checklists"` (plural). Is this a pre-existing bug, or does Stimulus auto-pluralize? Need to verify behavior before adding new targets. | `structure_tree_controller.js:5` vs `_structure_node.html.erb:91` | No — can be investigated during implementation |
| 2 | Should the "Assign Inspection Form" action button remain with the action button group at the top, or move to sit near the "Inspections" section header? Same question for "Assign Checklist". | PRD doesn't specify action button positioning relative to section headers | No — engineering discretion |
| 3 | Neither mobile app displays surveys in area nodes. Should the web tree continue to display surveys (with distinct icon), or should surveys be removed from the tree entirely (managed only via right pane)? | iOS `StructureScreen.swift` / Android `InspectionsSection.kt` — neither renders surveys | No — PRD specifies showing surveys with headers, which is fine |

---

## 8. Recommendations for Architecture Stage

- **Split the `<ul class="inspection-forms">` into two `<ul>` elements** — one for inspections (filtered by `.non_surveys`), one for surveys (filtered by `.surveys`). Both already have scopes on `InspectionFormsStructures`. The `_inspection_form_assignment.html.erb` partial can check `inspection_form_assignment.inspection_form.type` to render the correct icon.

- **Add a new Stimulus target** for the surveys list (e.g., `surveys`). Update `inspectionForms` target to point only at the inspections `<ul>`. This keeps the existing assignment/sort/destroy methods working on the correct list.

- **Reuse the existing `_inspection_form_assignment.html.erb` partial** for both inspections and surveys. Add a conditional icon: `inspection_form_assignment.inspection_form.is_a?(Survey) ? 'fal fa-poll-h' : 'fal fa-file-alt'`.

- **Section headers can be simple `<li>` elements** styled as non-interactive labels within each `<ul>`, or `<h6>`/`<span>` elements above each `<ul>`. The sort methods operate on `container.children`, so headers inside the `<ul>` could interfere with sorting. **Recommend placing headers outside/above each `<ul>`**, not as children within it.

- **Follow the inline CSS pattern** — the area tree's styles are defined inline in `show.html.erb`, not in external stylesheets. Add section header styles there.

- **The `_children.html.erb` partial needs no changes** — it just iterates children and renders `_structure_node` for each. Changes to `_structure_node` automatically propagate.

- **Existing scopes to leverage:**
  - `InspectionFormsStructures.non_surveys` — joins inspection_form, filters `type: nil`
  - `InspectionFormsStructures.ordered_by_form_name` — sorts alphabetically
  - `Structure#active_non_survey_ifs` — pre-filtered association
  - `Archivable#active` — filters `deleted_at: nil`

- **Do not change `hide_new_area` helper logic.** It correctly checks `assigned_forms.non_surveys.any?` — surveys don't count toward the mutual exclusion with child areas. The Stimulus controller's `destroyInspectionFormAssignment()` check should mirror this: only check the inspections list length, not the surveys list.
