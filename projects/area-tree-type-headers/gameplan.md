# Area Tree Type Headers & Icons - Engineering Gameplan

> **Generated by:** Pipeline Stage 3 (Gameplan)
> **Date:** February 6, 2026
> **PRD:** `projects/area-tree-type-headers/prd.md`
> **Discovery Report:** `projects/area-tree-type-headers/discovery-report.md`
> **Approved Architecture:** `projects/area-tree-type-headers/architecture-proposal.md` (Approved 2026-02-06)
> **Linear:** [WEB-106](https://linear.app/orangeqc/issue/WEB-106/area-tree-should-have-headers-and-different-icons-for-each-of)

---

## 1. Project Overview

### Goals
- Users can instantly distinguish Inspections, Surveys, and Checklists in the Setup > Sites area tree
- Resolve the customer confusion reported in Help Scout #11161
- Bring the web area tree in line with the section header pattern already used in iOS and Android

### Scope Summary

| Feature          | Description                                                                                    | Platform |
| ---------------- | ---------------------------------------------------------------------------------------------- | -------- |
| Section headers  | "Inspections", "Surveys", "Checklists" labels in each area node                                | Web      |
| Distinct icons   | `fa-poll-h` for surveys (inspections and checklists already have distinct icons)               | Web      |
| Grouped lists    | Split the flat `inspection_forms_structures` list into separate inspections and surveys groups | Web      |
| Stimulus updates | Update controller targets and methods to work with the new DOM structure                       | Web      |

### Out of Scope
- Changing the right-pane survey management UI
- Adding section collapse/expand within a node
- Changing icons anywhere other than the area tree
- Adding survey-specific behavior to the "Assign" dropdowns
- Mobile changes (iOS and Android already have section headers)
- Drag-and-drop reordering between sections

### Constraints & Conventions
- AGENTS.md: `~/projects/orangeqc/orangeqc/AGENTS.md`
- Area tree uses Bootstrap 3 views (`app/views/setup/`), not Tailwind
- Inline CSS in `show.html.erb` (no external stylesheet for the area tree)
- Stimulus 3.x controller pattern for all interactive behavior

---

## 2. Open Questions & Decisions

> Resolved during Stages 1-2 (Discovery + Architecture)

| Question | Status | Decision |
|----------|--------|----------|
| Should empty sections render their `<ul>` for Stimulus target availability? | Resolved | No — conditionally render only non-empty sections. Use `has[Target]Target` guards in JS. `createSection()` helper handles dynamic creation. |
| Should the `checklist` → `checklists` target name fix be bundled? | Resolved | Yes — fix it in this PR. One-token change in the same line we're already modifying. |
| Should section headers include counts (e.g., "Inspections (3)")? | Resolved | No — sections are always visible when node is expanded; counts are redundant. |
| Where should section headers sit in the DOM? | Resolved | Outside each `<ul>`, inside a wrapper `<div class="AreaTree__section">`. This prevents the sort service from treating headers as sortable items. |
| Should surveys be removed from the tree (matching mobile)? | Resolved | No — customer explicitly asked for visual distinction, not removal. |

---

## 3. Functional Milestones

### M0: Discovery & Alignment (Complete)
- [x] PRD parsed and understood (Stage 1)
- [x] Current state documented — area tree views, Stimulus controller, models/scopes (Stage 1)
- [x] View architecture proposed and **approved** (Stage 2 + Architecture Review)
- [x] Open questions resolved (Stages 1-2)

---

### M1: Section Headers, Icons & Stimulus Updates
**What:** Split the flat area tree form list into three grouped sections with headers and distinct icons, and update the Stimulus controller to work with the new DOM structure. This is a single tightly-coupled change — the ERB template restructure, icon conditional, CSS, model scope, and Stimulus controller updates must ship together.

**Acceptance Criteria:**
- [ ] **HDR-001:** Each area node in the tree displays up to three section headers: "Inspections", "Surveys", "Checklists"
- [ ] **HDR-002:** A section header only appears when at least one item of that type is assigned to the area
- [ ] **HDR-003:** Section headers are visually distinct from form names — smaller weight, muted color, uppercase styling, not clickable
- [ ] **HDR-004:** Sections are ordered: Inspections first, Surveys second, Checklists third (reordered from current checklists → forms layout)
- [ ] **HDR-005:** The Checklists section and header only appear when `service_validations_enabled` is true
- [ ] **ICN-001:** Inspection Forms display `fal fa-file-alt` icon (unchanged)
- [ ] **ICN-002:** Surveys display `fal fa-poll-h` icon (new — was previously `fa-file-alt`)
- [ ] **ICN-003:** Checklists display `far fa-clipboard-list-check` icon (unchanged)
- [ ] **GRP-001:** The single `inspection_forms_structures` list is split into non-surveys (`type IS NULL`) and surveys (`type = 'Survey'`), each under its own header
- [ ] **GRP-002:** Within each group, items are sorted alphabetically by form name (existing sort order preserved)
- [ ] **GRP-003:** Checklist assignments render under the "Checklists" header, sorted by name
- [ ] **INT-001:** Assigning an inspection form via the tree dropdown correctly inserts the new `<li>` into the "Inspections" `<ul>`, not the "Surveys" `<ul>`
- [ ] **INT-002:** Expand/collapse of area nodes is unchanged — all sections are visible when expanded
- [ ] **INT-003:** "Assign Inspection Form" and "Assign Checklist" dropdown buttons continue to function with unchanged dropdown filtering (non-surveys only for inspection forms)
- [ ] **INT-004:** When an inspection form is assigned to a node that previously had no inspections, the "Inspections" section (header + `<ul>`) is dynamically created by the Stimulus controller
- [ ] **INT-005:** `sortInspectionForms()` sorts the inspections-only `<ul>`; `destroyInspectionFormAssignment()` checks only the inspections list length for the "Add Area" un-hide logic (matching `hide_new_area` which checks `non_surveys`)
- [ ] **INT-006:** Survey assignment via the right pane still works. The tree does NOT update live (pre-existing behavior) — surveys appear on next node expand/collapse
- [ ] **BUG-FIX:** The Stimulus `static targets` declaration `"checklist"` is corrected to `"checklists"` to match the template attribute and method usage
- [ ] **EDGE:** An area with no assignments of any type shows no section headers (action buttons render as today)
- [ ] **EDGE:** An area with only surveys shows only the "Surveys" header
- [ ] **EDGE:** An area with only checklists shows only the "Checklists" header
- [ ] **EDGE:** AJAX-loaded child nodes (via `_children.html.erb`) also render with section headers
- [ ] **EDGE:** When the last inspection form is removed from a node, the "Inspections" section disappears and "Add Area" becomes visible (if no surveys block it — note: surveys don't block "Add Area" per `hide_new_area` logic)
- [ ] **EDGE:** When the last survey is removed from a node, the "Surveys" section disappears

**Web/API:**
- [ ] Model: Add `.surveys` scope to `InspectionFormsStructures` (`app/models/inspection_forms_structures.rb`)
- [ ] View: Restructure `_structure_node.html.erb` — replace lines 91-102 with three conditional section wrappers containing headers and typed `<ul>` elements. Reorder to inspections → surveys → checklists → children.
- [ ] View: Update `_inspection_form_assignment.html.erb` — add conditional icon based on `inspection_form_assignment.inspection_form.is_a?(Survey)`
- [ ] JavaScript: Update `structure_tree_controller.js` — add `surveys`, `surveysSection`, `inspectionFormsSection`, `checklistsSection` targets; fix `checklist` → `checklists`; update `createInspectionFormAssignment()`, `destroyInspectionFormAssignment()` methods; add `createSection()` helper
- [ ] CSS: Add `.AreaTree__section` and `.AreaTree__section-header` styles to inline `<style>` block in `show.html.erb`

**iOS:** N/A — Level 2 (web-only)
**Android:** N/A — Level 2 (web-only)

**Dependencies:** M0 (architecture approved)

---

### M2: QA Test Data
**What:** Create a rake task that seeds an account with areas having various combinations of inspections, surveys, and checklists so a QA tester can verify all section header scenarios without constructing data manually.

**Acceptance Criteria:**
- [ ] Rake task `pipeline:seed_area_tree_type_headers` exists in `lib/tasks/pipeline/`
- [ ] Task creates a test account with `service_validations_enabled = true` and `surveys_enabled = true`
- [ ] Task creates a site with areas covering these scenarios:
  - Area with inspections + surveys + checklists (all three headers visible)
  - Area with only inspections (one header)
  - Area with only surveys (one header)
  - Area with only checklists (one header)
  - Area with inspections + surveys but no checklists (two headers)
  - Area with no assignments (no headers, action buttons visible)
  - Area with child sub-areas AND assigned surveys (verifying surveys don't block "Add Area")
  - Nested area hierarchy (verifying AJAX-loaded children get headers)
- [ ] Task creates a user with `administer` permission for the test account
- [ ] Task is idempotent (can re-run without duplicating data)
- [ ] Task prints a summary: account subdomain, user login/password, and what to look for

**Web/API:**
- [ ] `lib/tasks/pipeline/seed_area_tree_type_headers.rake` — idempotent seed task
- [ ] Uses ActiveRecord directly (not FactoryBot) with careful attention to model validations
- [ ] Creates InspectionForm records (non-survey) and Survey records via STI
- [ ] Creates Checklist + ChecklistAssignment records
- [ ] Creates InspectionFormsStructures join records for both surveys and non-surveys

**iOS:** N/A
**Android:** N/A

**Dependencies:** M1 (needs the feature implemented to QA)

---

## 4. Non-Functional Requirements Checklist

### Data Model & API
> Reviewed and approved in Architecture Review (2026-02-06).

- [x] Architecture proposal approved: `projects/area-tree-type-headers/architecture-proposal.md`
- [x] Milestones correctly reference the approved view architecture
- [x] No contradictions between gameplan and approved architecture
- [x] No new tables, no migrations, no API changes

### Security & Access Control
- [x] All queries scoped to account/user — existing scoping unchanged; `.surveys` scope mirrors `.non_surveys`
- [x] Controller authorization in place — `require_administer_permission` on all setup controllers (unchanged)
- [x] Feature permissions respected — `service_validations_enabled` gate for checklists, `surveys_enabled` gate for surveys
- [x] Area-based access respected — `Structure.accessible_to(current_user)` unchanged
- [x] No new API endpoints
- [x] No new attack surfaces

### Performance
- [x] Data volume considered — `inspection_forms_structures` table is 1.8M rows, but queries are per-node (typically <10 rows). Splitting into two filtered queries adds negligible overhead.
- [x] `inspection_forms.type` column is indexed — the `.surveys` and `.non_surveys` scopes use this index via `joins(:inspection_form)`
- [x] No caching needed
- [x] N+1 risk: The `is_a?(Survey)` check in the partial uses the `inspection_form` association from the `inspection_form_assignment` — this is already eager-loaded by `joins(:inspection_form)` in the scope. No new N+1.

### Observability & Debuggability
- [x] No new logging needed — this is a visual UI change with no new business logic
- [x] Debug path: inspect the DOM in browser dev tools to verify sections, headers, targets
- [x] No new metrics or analytics — existing page load tracking covers the setup pages
- [x] No alerts needed

### Testing Plan

| Type | Coverage | Platform | Owner |
|------|----------|----------|-------|
| Manual QA | All section header scenarios (M2 seed data) | Web | Human |
| Visual inspection | Header styling, icon correctness, section ordering | Web | Human |
| Functional testing | Assign/unassign inspection forms via dropdown, verify correct `<ul>` insertion | Web | Human |
| Functional testing | Assign/unassign surveys via right pane, verify tree updates on re-expand | Web | Human |
| Functional testing | Expand/collapse, lazy-loaded children inherit section headers | Web | Human |

**Note on automated tests:** The discovery report found zero existing controller, feature, or JS specs for the area tree. Writing automated tests for this view-only change would require building test infrastructure from scratch (system/feature specs with JS driver). Given the project scope (5 files, visual change), manual QA via seed data is the pragmatic path. If the team later invests in system specs for the setup area, these scenarios should be covered.

### Feature Flags & Rollout
- [x] No feature flag required — this is a non-breaking visual enhancement
- [x] Ships directly to staging, then production
- [x] No phased rollout needed

### Mobile-Specific
- [x] N/A — Level 2 (web-only) project
- [x] iOS and Android already have section headers — no changes needed

### Legacy & Migration
- [x] No old client impact — web admin UI only
- [x] No API changes — mobile apps unaffected
- [x] No data migration needed

### Export/Reporting
- [x] N/A — no exports reference the area tree rendering

---

## 5. Dependencies & Risks

| Risk/Dependency | Impact | Mitigation |
|-----------------|--------|------------|
| Stimulus controller DOM assumptions | Med | The existing controller hardcodes `ul.inspection-forms` as a CSS selector. Architecture specifies the exact target and selector updates needed. Test all CRUD flows after changes. |
| Pre-existing `checklist`/`checklists` target naming bug | Low | Architecture bundles the fix. Verify `sortChecklists()` works before and after the change. |
| No existing test coverage for area tree | Low | The seed task (M2) provides comprehensive manual QA scenarios. All edge cases are documented. |
| Survey right-pane assignment doesn't update tree | None (pre-existing) | Documented in INT-006. No change to this behavior. |

---

## 6. Release Plan

### Single Phase

| Phase | What Ships | Audience |
|-------|-----------|----------|
| Phase 1 | M1 + M2 — all changes ship together | All web admin users |

No feature flag. No staged rollout. This is a visual enhancement that improves clarity without changing functionality.

### Done Criteria
- [ ] All M1 acceptance criteria met
- [ ] QA seed data created (M2) and all scenarios manually verified
- [ ] Branch pushed and PR created against `staging`
- [ ] Tim Lang (Help Scout #11161) can be notified the fix is live

---

## 7. Estimates

| Milestone | Rails | iOS | Android | Notes |
|-----------|-------|-----|---------|-------|
| M0: Discovery & Alignment | Done | N/A | N/A | Pipeline Stages 1-2 |
| M1: Section Headers, Icons & Stimulus | ~1 day | N/A | N/A | 5 files, tightly coupled |
| M2: QA Test Data | ~0.5 day | N/A | N/A | Seed task with 8 scenarios |
| **Total** | **~1.5 days** | **N/A** | **N/A** | |

---

## PRD Requirement Traceability Matrix

| PRD Requirement | Milestone | Acceptance Criteria |
|-----------------|-----------|---------------------|
| HDR-001 | M1 | Three section headers displayed |
| HDR-002 | M1 | Headers only when items exist |
| HDR-003 | M1 | Headers visually distinct |
| HDR-004 | M1 | Order: inspections, surveys, checklists |
| HDR-005 | M1 | Checklists conditional on service_validations_enabled |
| ICN-001 | M1 | Inspection forms use fa-file-alt |
| ICN-002 | M1 | Surveys use fa-poll-h |
| ICN-003 | M1 | Checklists use fa-clipboard-list-check |
| GRP-001 | M1 | Split into non-surveys and surveys groups |
| GRP-002 | M1 | Sort order preserved within groups |
| GRP-003 | M1 | Checklists under Checklists header |
| INT-001 | M1 | Dropdown insertion targets correct <ul> |
| INT-002 | M1 | Expand/collapse unchanged |
| INT-003 | M1 | Assign buttons function unchanged |
| INT-004 | M1 | Dynamic section creation on first assignment |
| INT-005 | M1 | Sort/destroy methods target inspections list |
| INT-006 | M1 | Survey right-pane behavior unchanged |

All 17 PRD requirements are mapped to M1 acceptance criteria.

---

## Approval Checklist

> **This gameplan requires human review and approval before test generation begins.**

### Reviewer: Dave
### Date: 2/6/2026
### Status: Accepted

#### Must Verify
- [x] Milestone breakdown is logical and correctly sequenced
- [x] Acceptance criteria are specific and testable
- [x] Every PRD requirement ID is mapped to a milestone (traceability matrix complete)
- [x] Non-functional requirements checklist is fully addressed
- [x] Dependencies form a valid DAG (no circular dependencies)
- [x] Estimates are realistic
- [x] Release plan is appropriate

#### Optional Notes
[Any modifications, corrections, or additional context for the implementation team]

---

## Changelog

| Date | Author | Changes |
|------|--------|---------|
| 2026-02-06 | Pipeline | Initial gameplan generated |
