# Area Tree Type Headers & Icons - Architecture Proposal

> **Generated by:** Pipeline Stage 2 (Architecture)
> **Date:** February 6, 2026
> **PRD:** `projects/area-tree-type-headers/prd.md`
> **Discovery Report:** `projects/area-tree-type-headers/discovery-report.md`
> **Linear:** [WEB-106](https://linear.app/orangeqc/issue/WEB-106/area-tree-should-have-headers-and-different-icons-for-each-of)

---

## 1. Data Model Changes

### New Tables

**None.** This feature is a view-layer-only change. No new database tables are required.

### Modified Tables

**None.** No schema changes. The existing `inspection_forms.type` column (STI) already provides the data needed to distinguish inspections from surveys. The existing `InspectionFormsStructures.non_surveys` scope and `InspectionForm.surveys` scope provide the grouping logic.

### Rails Models

**No model changes required.** All necessary scopes and associations already exist:

| Scope / Association | Location | Purpose |
|---------------------|----------|---------|
| `InspectionFormsStructures.non_surveys` | `app/models/inspection_forms_structures.rb` | Joins to `inspection_forms`, filters `type: nil` |
| `InspectionFormsStructures.active` | `Archivable` concern | Filters `deleted_at: nil` |
| `InspectionFormsStructures.ordered_by_form_name` | `app/models/inspection_forms_structures.rb` | Sorts by `inspection_forms.name ASC` |
| `InspectionForm.surveys` | `app/models/inspection_form.rb` | Filters `type: 'Survey'` |
| `Structure#active_non_survey_ifs` | `app/models/structure.rb` | Pre-filtered association: active, non-survey join records |

**New view-level query approach:** Replace the single `structure.inspection_forms_structures.active.ordered_by_form_name` call in `_structure_node.html.erb` with two separate queries:

```ruby
# Inspections (non-surveys)
structure.inspection_forms_structures.active.non_surveys.ordered_by_form_name

# Surveys
structure.inspection_forms_structures.active.ordered_by_form_name
  .joins(:inspection_form).where(inspection_forms: { type: 'Survey' })
```

A `surveys` scope on `InspectionFormsStructures` does not currently exist (only `non_surveys` does). Two options:

- **Option A (recommended):** Add a `.surveys` scope to `InspectionFormsStructures` for symmetry: `scope :surveys, -> { joins(:inspection_form).where(inspection_forms: { type: 'Survey' }) }`
- **Option B:** Use the inverse filter inline in the view

Option A is cleaner and keeps the filtering logic in the model. It's a one-line addition to `inspection_forms_structures.rb`.

### Associations Map

```
Structure
  ├── has_many :inspection_forms_structures (join records)
  │     ├── .active.non_surveys.ordered_by_form_name  → "Inspections" section
  │     └── .active.surveys.ordered_by_form_name       → "Surveys" section (new scope)
  ├── has_many :checklist_assignments
  │     └── .active.ordered_by_checklist_name          → "Checklists" section
  └── children (via ancestry)                          → child area nodes
```

### Migration Plan

| Migration | Type | Notes |
|-----------|------|-------|
| None | N/A | No database changes. One-line scope addition to model file only. |

### Expected Data Volumes

**Not applicable.** No new data. The existing `inspection_forms_structures` table (1.8M rows) is queried per-node (typically <10 rows per area). Splitting into two filtered queries adds negligible overhead. The `inspection_forms.type` column is indexed.

---

## 2. API Endpoints

**Not applicable.** This is a web admin view-only change. No API endpoints are created, modified, or affected.

The area tree is rendered server-side via ERB partials. The Stimulus controller makes fetch requests to existing Rails endpoints (`setup/inspection_form_assignments#create`, `setup/structures#children`) which return HTML partials. These endpoints are not public API — they are internal to the admin UI.

### Serializers / Blueprints

**Not applicable.** No serialization changes.

---

## 3. Backwards Compatibility

### Compatibility Matrix

| Feature / Behavior | Web (current) | iOS (current) | Android (current) |
|-------------------|:---:|:---:|:---:|
| Section headers in area tree | **New** — adds headers | N/A — already has headers | N/A — already has headers |
| Distinct survey icon | **New** — `fa-poll-h` for surveys | N/A — not affected | N/A — not affected |
| Inspection form assignment CRUD | Unchanged | N/A | N/A |
| Checklist assignment CRUD | Unchanged | N/A | N/A |
| Survey assignment via right pane | Unchanged | N/A | N/A |
| Area tree expand/collapse | Unchanged | N/A | N/A |
| Section ordering | **Changed** — inspections first, then surveys, then checklists (currently: checklists, then all forms mixed) | N/A | N/A |

### Old Client Behavior

**No mobile client impact.** This change is entirely within the web admin UI. Mobile apps:
- Do not render the area tree from web views
- Already have their own section header implementations
- Access area/form data through API endpoints, which are unchanged

### API Versioning

**Not applicable.** No API changes.

### Data Migration

**Not applicable.** No data changes.

---

## 4. View Architecture

> This section replaces the typical API/serializer design since this feature is entirely view-layer.

### 4.1 DOM Structure — Proposed

Replace the current flat list with grouped sections. Section headers sit **outside** each `<ul>` (as siblings, not children) to avoid interfering with `StructureTreeService.sortAssignmentsByName()` which sorts all `container.children`.

```html
<div class="collapse" data-structure-tree-target="collapse">
  <!-- Action buttons (unchanged) -->
  <ul>
    <li class="list-action"> Add Area </li>
    <li class="list-action"> Assign Inspection Form </li>
    <li class="list-action"> Assign Checklist </li>
  </ul>

  <!-- INSPECTIONS section (non-surveys) -->
  <div class="AreaTree__section" data-structure-tree-target="inspectionFormsSection">
    <span class="AreaTree__section-header">Inspections</span>
    <ul class="inspection-forms" data-structure-tree-target="inspectionForms">
      <!-- Only non-survey InspectionFormsStructures rendered here -->
      <li>... fa-file-alt icon ...</li>
    </ul>
  </div>

  <!-- SURVEYS section -->
  <div class="AreaTree__section" data-structure-tree-target="surveysSection">
    <span class="AreaTree__section-header">Surveys</span>
    <ul class="surveys" data-structure-tree-target="surveys">
      <!-- Only Survey-type InspectionFormsStructures rendered here -->
      <li>... fa-poll-h icon ...</li>
    </ul>
  </div>

  <!-- CHECKLISTS section (only if service_validations_enabled) -->
  <div class="AreaTree__section" data-structure-tree-target="checklistsSection">
    <span class="AreaTree__section-header">Checklists</span>
    <ul class="checklists" data-structure-tree-target="checklists">
      <li>... fa-clipboard-list-check icon ...</li>
    </ul>
  </div>

  <!-- Children (unchanged) -->
  <ul class="children" data-structure-tree-target="children">
  </ul>
</div>
```

**Key design decisions:**

1. **Wrapper `<div class="AreaTree__section">`** around each header + list. This allows hiding the entire section (header + list) when the section is empty, using a single ERB conditional. It also provides a hook for section-level styling.

2. **Header is a `<span>`, not an `<li>`** inside the `<ul>`. This prevents the sort service from treating it as a sortable item.

3. **Separate `<ul>` for surveys** with its own Stimulus target. This keeps the existing `inspectionForms` target pointing at the inspections-only list, so `createInspectionFormAssignment()` inserts into the correct list.

4. **Section ordering:** Inspections → Surveys → Checklists → Children. This matches the Setup sidebar navigation order and the PRD requirement HDR-004.

### 4.2 ERB Template Changes — `_structure_node.html.erb`

Replace lines 91-102 (the checklists and inspection-forms `<ul>` blocks) with grouped sections:

```erb
<%# INSPECTIONS section (non-surveys) %>
<% inspection_assignments = structure.inspection_forms_structures.active.non_surveys.ordered_by_form_name %>
<% if inspection_assignments.any? %>
  <div class="AreaTree__section" data-structure-tree-target="inspectionFormsSection">
    <span class="AreaTree__section-header">Inspections</span>
    <ul class="inspection-forms" data-structure-tree-target="inspectionForms">
      <% inspection_assignments.each do |ifa| %>
        <%= render "setup/inspection_form_assignments/inspection_form_assignment",
              inspection_form_assignment: ifa %>
      <% end %>
    </ul>
  </div>
<% end %>

<%# SURVEYS section %>
<% survey_assignments = structure.inspection_forms_structures.active.surveys.ordered_by_form_name %>
<% if survey_assignments.any? %>
  <div class="AreaTree__section" data-structure-tree-target="surveysSection">
    <span class="AreaTree__section-header">Surveys</span>
    <ul class="surveys" data-structure-tree-target="surveys">
      <% survey_assignments.each do |sa| %>
        <%= render "setup/inspection_form_assignments/inspection_form_assignment",
              inspection_form_assignment: sa %>
      <% end %>
    </ul>
  </div>
<% end %>

<%# CHECKLISTS section %>
<% if service_validations_enabled %>
  <% checklist_assignments_list = structure.checklist_assignments.active.ordered_by_checklist_name %>
  <% if checklist_assignments_list.any? %>
    <div class="AreaTree__section" data-structure-tree-target="checklistsSection">
      <span class="AreaTree__section-header">Checklists</span>
      <ul class="checklists" data-structure-tree-target="checklists">
        <% checklist_assignments_list.each do |ca| %>
          <%= render "setup/checklist_assignments/checklist_assignment",
                checklist_assignment: ca %>
        <% end %>
      </ul>
    </div>
  <% end %>
<% end %>
```

**Important:** The sections render conditionally. If a section has no items, neither its header nor its `<ul>` appear. This means the Stimulus targets (`inspectionForms`, `surveys`, `checklists`) may not exist in the DOM for a given node — the controller must use `has[Target]Target` checks.

### 4.3 ERB Template Changes — `_inspection_form_assignment.html.erb`

Add conditional icon based on form type:

```erb
<li id="inspection-form-assignment-<%= dom_id(inspection_form_assignment) %>">
  <div class="inspection-form-assignment"
       data-action="click->structure-tree#selectTrashable"
       data-structure-tree-target="trashable">
    <p>
      <% if inspection_form_assignment.inspection_form.is_a?(Survey) %>
        <span class="fal fa-poll-h right-margin"></span>
      <% else %>
        <span class="fal fa-file-alt right-margin"></span>
      <% end %>
      <span class="right-margin assignment-title">
        <%= inspection_form_assignment.inspection_form.name %>
      </span>
      <span class="destroy-link far fa-trash-alt" style="cursor: pointer;"
        data-action="click->structure-tree#destroyInspectionFormAssignment"
        data-destroy-inspection-form-assignment-url="<%= setup_inspection_form_assignment_path(inspection_form_assignment) %>"
        data-element-to-remove="#inspection-form-assignment-<%= dom_id(inspection_form_assignment) %>">
      </span>
    </p>
  </div>
</li>
```

The partial continues to be used for both inspections and surveys — the icon is the only difference. The `is_a?(Survey)` check uses the STI class hierarchy, which is reliable because the `type` column drives Rails' class instantiation.

### 4.4 Stimulus Controller Changes — `structure_tree_controller.js`

#### New/Changed Targets

```javascript
static targets = [
  "icon", "newArea", "newInspectionFormAssignment", "newChecklistAssignment",
  "collapse", "node", "link", "trashable",
  "inspectionForms",         // existing — now points at inspections-only <ul>
  "inspectionFormsSection",  // NEW — wrapper <div> for visibility toggling
  "surveys",                 // NEW — <ul class="surveys">
  "surveysSection",          // NEW — wrapper <div> for visibility toggling
  "checklists",              // FIX — was "checklist" (singular), change to "checklists"
  "checklistsSection",       // NEW — wrapper <div> for visibility toggling
  "children"
];
```

**Note on the `checklist` → `checklists` fix:** The current `static targets` declares `"checklist"` (singular) but code uses `this.checklistsTarget` and the template uses `data-structure-tree-target="checklists"`. These are inconsistent. This proposal corrects the target name to `"checklists"` to match the template and usage. This is a pre-existing bug fix, not a new change.

#### Method Changes

**`createInspectionFormAssignment(event)`** — Line 315: Change `this.element.querySelector('ul.inspection-forms')` to use the target:

```javascript
createInspectionFormAssignment(event) {
  // ... fetch POST unchanged ...
  .then(html => {
    var tempElement = document.createElement('div')
    tempElement.innerHTML = html

    // If the inspections section doesn't exist yet, create it
    if (!this.hasInspectionFormsSectionTarget) {
      this.createSection('inspectionForms', 'Inspections', 'inspection-forms')
    }

    this.inspectionFormsTarget.prepend(tempElement.firstElementChild)
    this.sortInspectionForms()

    if (this.hasNewAreaTarget) {
      this.newAreaTarget.setAttribute('hidden', '')
    }
  })
}
```

**`destroyInspectionFormAssignment(event)`** — Line 336: Check inspections list (not surveys) for the "Add Area" un-hide logic:

```javascript
destroyInspectionFormAssignment(event) {
  // ... fetch DELETE unchanged ...
  .then(html => {
    document.querySelector(elementToRemove).remove()

    // Remove empty section wrapper if no items remain
    if (this.hasInspectionFormsTarget && this.inspectionFormsTarget.children.length === 0) {
      this.inspectionFormsSectionTarget.remove()
    }
    if (this.hasSurveysTarget && this.surveysTarget.children.length === 0) {
      this.surveysSectionTarget.remove()
    }

    // Un-hide "Add Area" only when no non-survey forms remain
    // (matches hide_new_area helper which checks assigned_forms.non_surveys.any?)
    const hasInspections = this.hasInspectionFormsTarget && this.inspectionFormsTarget.children.length > 0
    if (!hasInspections && this.hasNewAreaTarget) {
      this.newAreaTarget.removeAttribute('hidden')
    }
  })
}
```

**`sortInspectionForms()`** — Unchanged. Still sorts `this.inspectionFormsTarget`, which now only contains inspections.

**New helper: `createSection(targetName, headerText, ulClass)`** — Dynamically creates a section wrapper + header + `<ul>` and inserts it in the correct position within the collapse div. This handles the case where a user assigns the first inspection form to a node that currently has none:

```javascript
createSection(targetName, headerText, ulClass) {
  const section = document.createElement('div')
  section.classList.add('AreaTree__section')
  section.setAttribute(`data-structure-tree-target`, `${targetName}Section`)

  const header = document.createElement('span')
  header.classList.add('AreaTree__section-header')
  header.textContent = headerText

  const ul = document.createElement('ul')
  ul.classList.add(ulClass)
  ul.setAttribute('data-structure-tree-target', targetName)

  section.appendChild(header)
  section.appendChild(ul)

  // Insert before children <ul> or at end of collapse div
  const childrenUl = this.hasChildrenTarget ? this.childrenTarget : null
  if (childrenUl) {
    this.collapseTarget.insertBefore(section, childrenUl)
  } else {
    this.collapseTarget.appendChild(section)
  }
}
```

### 4.5 CSS Changes — `show.html.erb` (inline styles)

Add section header styles to the existing inline `<style>` block:

```css
.AreaTree__section {
  margin-bottom: 2px;
}
.AreaTree__section-header {
  display: block;
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: #999;
  padding: 4px 6px 2px 22px;
  user-select: none;
}
```

The `padding-left: 22px` aligns the header text with the assignment names (which are indented by their icon width). Engineering has discretion on exact values.

### 4.6 Model Change — `inspection_forms_structures.rb`

Add a symmetric `surveys` scope:

```ruby
# app/models/inspection_forms_structures.rb
scope :surveys, -> { joins(:inspection_form).where(inspection_forms: { type: 'Survey' }) }
```

This is one line, mirrors the existing `non_surveys` scope, and keeps filtering logic in the model.

---

## 5. Security Design

### Query Scoping

| Resource | Scoping Chain | Changed? |
|----------|--------------|----------|
| Structure (area tree page) | `Structure.accessible_to(current_user).where(id: params[:id])` | No |
| InspectionFormsStructures (inspections) | `structure.inspection_forms_structures.active.non_surveys` | No (existing scope) |
| InspectionFormsStructures (surveys) | `structure.inspection_forms_structures.active.surveys` | No (new scope, same join pattern as `non_surveys`) |
| ChecklistAssignments | `structure.checklist_assignments.active` | No |
| Inspection form assignment create | `InspectionForm.accessible_to(current_user)` + `Structure.accessible_to(current_user)` | No |

All data access paths remain scoped through existing associations. The new `.surveys` scope uses the same `joins(:inspection_form)` pattern as `.non_surveys` — no new query path is introduced.

### Authorization

| Action | Required Permission | Check | Changed? |
|--------|-------------------|-------|----------|
| View area tree | `administer` permission | `require_administer_permission` in `StructuresController` | No |
| Assign inspection form | `administer` permission | `require_administer_permission` in `InspectionFormAssignmentsController` | No |
| Assign checklist | `administer` permission | `require_administer_permission` in `ChecklistAssignmentsController` | No |
| Assign survey | `administer` permission | `require_administer_permission` in `AssignedSurveysController` | No |

### New Attack Surface

**None.** No new endpoints, no new data access paths, no new user inputs. The only new element is the `.surveys` scope which mirrors the existing `.non_surveys` pattern.

---

## 6. Export Impact

**None.** This feature changes only the visual rendering of the area tree in the web admin UI. No exports (PDF, CSV, email) reference the area tree rendering. The export infrastructure uses the underlying data models directly, not the view templates.

---

## 7. Open Questions for Human Review

| # | Question | Options | Recommendation |
|---|----------|---------|---------------|
| 1 | Should empty sections render the `<ul>` with no items (for Stimulus target availability), or should the entire section wrapper be conditionally omitted? | **A:** Always render all three section `<div>`s (some with empty `<ul>`), so targets always exist. Simpler JS. / **B:** Conditionally render only non-empty sections. Cleaner HTML. JS uses `has[Target]Target` guards. | **B** — conditional rendering. The `has[Target]Target` pattern is idiomatic Stimulus and the `createSection()` helper handles the dynamic case. Empty markup clutters every node in the tree. |
| 2 | Should the `checklist` → `checklists` target name fix be included in this change, or done separately? | **A:** Fix it in this PR since we're already touching the targets list. / **B:** Separate PR to isolate changes. | **A** — fix it here. It's a one-token change in the same line we're already modifying, and testing it in isolation would require touching the same files. |
| 3 | Should section headers include counts (e.g., "Inspections (3)")? | **A:** No count — cleaner, count is obvious from the list. / **B:** Include count — helpful for collapsed state if we ever add section collapse. | **A** — no count. Sections are always expanded when the node is expanded, so counts are redundant. |

---

## 8. Alternatives Considered

### Alternative A: CSS-Only Approach (No DOM Split)

**Description:** Keep the single `<ul class="inspection-forms">` with all types mixed, and use CSS `::before` pseudo-elements with `data-form-type` attributes to add visual headers when the type changes.

**Pros:**
- No Stimulus controller changes
- No new targets
- Fewer ERB template changes

**Cons:**
- CSS cannot reliably detect "first item of a new type" when items are sorted alphabetically (surveys and inspections interleave)
- Cannot conditionally hide headers when a section is empty without JS
- Fragile — depends on sort order matching type grouping

**Why rejected:** The interleaved sort order means CSS alone cannot create distinct type-grouped sections. The items must actually be in separate DOM containers.

### Alternative B: Single Partial with Type Parameter

**Description:** Create a new `_assignment_section.html.erb` partial that takes a type parameter and renders the header + list for one section. Called three times from `_structure_node.html.erb`.

**Pros:**
- DRY — one partial for all three section types
- Could be reused elsewhere

**Cons:**
- Over-abstraction for three simple, slightly-different sections (checklists use a different partial and different conditional)
- Harder to read — indirection for a simple feature
- The three sections differ enough (different scopes, different partials, different conditionals) that the "shared" partial would need many parameters

**Why rejected:** Three explicit sections in the template is clearer than a parameterized abstraction, especially since checklists have a `service_validations_enabled` conditional and use a different assignment partial. Following the AGENTS.md principle: "Sometimes duplication is better than the wrong abstraction."

### Alternative C: Remove Surveys From the Tree

**Description:** Since neither mobile platform shows surveys in area nodes, remove surveys from the web tree entirely. Surveys would only be visible and manageable in the right pane.

**Pros:**
- Simpler — no need for a third section
- Aligns with mobile behavior
- The right pane already has a "Surveys" section for managing assignments

**Cons:**
- Users currently see surveys in the tree (even if indistinguishable). Removing them could be perceived as a regression.
- The customer bug report specifically asks to see surveys WITH visual distinction, not to hide them

**Why rejected:** The PRD and the customer request (Help Scout #11161) explicitly ask for visual distinction, not removal. Removing surveys from the tree would change behavior beyond what was requested.

---

## 9. Summary

### Files to Create

| File | Purpose |
|------|---------|
| None | No new files required |

### Files to Modify

| File | Changes |
|------|---------|
| `app/models/inspection_forms_structures.rb` | Add `.surveys` scope (one line) |
| `app/views/setup/structures/_structure_node.html.erb` | Split flat list into three conditional sections with headers; reorder to inspections → surveys → checklists; update Stimulus target attributes |
| `app/views/setup/inspection_form_assignments/_inspection_form_assignment.html.erb` | Conditional icon: `fa-poll-h` for surveys, `fa-file-alt` for inspections |
| `app/javascript/controllers/structure_tree_controller.js` | Add `surveys`, `surveysSection`, `inspectionFormsSection`, `checklistsSection` targets; fix `checklist` → `checklists` target; update `createInspectionFormAssignment`, `destroyInspectionFormAssignment` methods; add `createSection` helper |
| `app/views/setup/structures/show.html.erb` | Add `.AreaTree__section` and `.AreaTree__section-header` CSS rules to inline styles |

### Files Unchanged (Verified)

| File | Why No Change Needed |
|------|---------------------|
| `app/views/setup/structures/_children.html.erb` | Renders `_structure_node` — changes propagate automatically |
| `app/views/setup/checklist_assignments/_checklist_assignment.html.erb` | Icon and structure unchanged |
| `app/controllers/setup/structures_controller.rb` | No controller logic changes; view handles grouping |
| `app/controllers/setup/inspection_form_assignments_controller.rb` | Returns `_inspection_form_assignment` partial (which now conditionally renders icon) |
| `app/controllers/setup/assigned_surveys_controller.rb` | Right-pane flow unchanged |
| `app/javascript/services/structure_tree_service.js` | `sortAssignmentsByName` works on any `<ul>` container — no changes needed |
| `app/helpers/setup/structures_helper.rb` | `hide_new_area` and `hide_new_inspection_form` logic unchanged |
| `config/routes.rb` | No new routes |
| `db/migrate/` | No migrations |

---

## Approval Checklist

> **This architecture proposal requires human review and approval before the gameplan is generated.**

### Reviewer: Dave
### Date: 2026-02-06
### Status: Approved

#### Must Verify
- [x] View architecture is sound (DOM structure, section wrappers, header placement)
- [x] Stimulus controller changes are correct (new targets, method updates, `has[Target]Target` guards)
- [x] Backwards compatibility is handled correctly (no API/mobile impact, section reorder is intentional)
- [x] Security scoping is correct (no new data access paths, `.surveys` scope mirrors `.non_surveys`)
- [x] No database changes needed (confirmed: STI `type` column + existing scopes are sufficient)

#### Should Check
- [x] CSS approach for section headers matches app conventions
- [x] `createSection()` helper handles dynamic section creation correctly
- [x] The `checklist` → `checklists` target fix is safe to bundle
- [x] Open questions are answerable
- [x] No conflicts with in-progress work

#### Notes
Approved as proposed. Go with recommended options on all three open questions (conditional rendering, bundle the checklist target fix, no counts in headers).
