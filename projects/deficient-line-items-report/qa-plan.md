# QA Plan — Deficient Line Item Report

> **Generated by:** Pipeline Stage 7 (QA Plan)
> **Date:** February 6, 2026
> **Branch:** `pipeline/deficient-line-items-report`
> **PR:** TBD
> **Gameplan:** `projects/deficient-line-items-report/gameplan.md`
> **Progress:** `projects/deficient-line-items-report/progress.md`

---

## 1. Feature Summary

A new Deficient Line Item Report that surfaces repeat deficiency patterns across a BSC's account. Users see which tasks are failing most consistently, drill down to see where failures are concentrated by area and inspection form, view deficiency trends over time, configure visibility thresholds, filter by date/area/form, and export to PDF or CSV.

### Milestones Implemented

| Milestone | Description | Commit |
|-----------|-------------|--------|
| M1 | Data Model & Core Analytics | `29c5d53` |
| M2 | Entry View — Summary Cards & Line Item Table | `60f06aa` |
| M3 | Configurable Thresholds | `8cab0ac` |
| M4 | Filters — Date Range, Areas, Forms | `6bdf34d` |
| M5 | Drill-Down View — Navigation, Summary, Area Concentration | `81ffdbc` |
| M6 | Drill-Down View — Trend Chart & Mixed Areas | `3cb33ee` |
| M7 | Export — PDF & CSV | `1caf387` |
| M8 | Empty States, Edge Cases & Polish | `d5df7c3` |
| QA Test Data | Seed task for manual QA testing | `f9c3652` |

---

## 2. Automated Test Coverage

| Metric | Value |
|--------|-------|
| **Total tests** | 123 |
| **Passing** | 123 |
| **Failing** | 0 |
| **Test files** | 7 (6 specs + 1 factory) |

### Test Types

| Type | File | Count | Covers |
|------|------|-------|--------|
| Model specs | `spec/models/report_setting_spec.rb` | 9 | ReportSetting validations, defaults, `.for()`, accessors |
| Service specs | `spec/services/analytics/deficient_line_items_spec.rb` | 58 | All analytics methods, scoping, thresholds, trends, drill-down, area concentration, form comparison |
| Request specs | `spec/requests/reports/deficient_line_items_controller_spec.rb` | 26 | Index (pagination, sorting, auth, scoping), show (drill-down, filters, redirects, edge cases, empty states) |
| Request specs | `spec/requests/reports/deficient_line_item_settings_controller_spec.rb` | 9 | Threshold save, persistence, user isolation, authorization |
| Exporter specs | `spec/services/exporter/deficient_line_item_report_pdf_spec.rb` | 10 | PDF section selection, filters, drill-down export |
| Exporter specs | `spec/services/exporter/deficient_line_item_report_csv_spec.rb` | 20 | CSV columns, scoping, large report detection, cross-tenant isolation |

### What Automated Tests Verify
- Analytics service: all aggregate calculations, threshold filtering, scoping by account/user/date, trend badge logic (±5pp), prior period batch computation, area concentration, form comparison, trend data bucketing
- Controller: authorization (read_reports + read_inspections), supervisory zone scoping, pagination, sorting, cross-tenant isolation (line item, structure), empty states (UI-010, UI-011, UI-012), filter params flow-through
- Settings: threshold persistence per-user, partial updates, user isolation
- PDF: section selection, filter context, drill-down scoping
- CSV: 9-column output, deficient-only rows, filter application, drill-down line_item_id scoping, large report detection (>10K rows)

---

## 3. Test Data Setup

### Rake Task

```bash
cd ~/projects/orangeqc/orangeqc
bundle exec rake pipeline:seed_deficient_line_items_report
```

**Prerequisites:** The `elm` dev account must exist (`rake db:seed` first). The task is idempotent — if data already exists, it prints a summary and exits.

### Scenarios Seeded

| Scenario | Account/User | Data Created | Purpose |
|----------|-------------|--------------|---------|
| Admin with full access | `crash` / (existing password) | Company-level supervisory zone covers all QA areas | Standard report viewing, drill-down, exports |
| Permission denial | `qa_restricted` / `password` | `read_reports=false`, has supervisory zones | Verify report is inaccessible |
| HIGH RISK line item | elm account | Floor Care: 15/25 deficiencies (60%) | HIGH RISK badge, red row tint, risk bar |
| Mid-range deficiencies | elm account | Trash Removal (8/20=40%), Restroom Supplies (12/30=40%) | Amber risk bars, standard drill-down |
| Trend worsening | elm account | Floor Care, Trash Removal, Restroom Supplies: current rate > prior period | Red ↑ trend badges |
| Trend improving | elm account | Window Cleaning (40%→67% prior), Dusting (33%→67% prior) | Green ↓ trend badges |
| Below repeat threshold | elm account | Carpet Stains: 1/10 deficiencies | Filtered out by default (requires 2+) |
| Below sample size | elm account | HVAC Filters: 3/4 inspections | Filtered out by default (requires 5+) |
| Zero deficiencies | elm account | Door Hardware: 0/8 deficiencies | Filtered out (zero deficiencies) |
| Mixed area | elm account | Building Gamma has sub-areas (Basement) AND direct inspections | Dual-table display (DDV-050) |
| Form comparison | elm account | Leaf areas have inspections from multiple forms | Form comparison table at leaf level |
| Multi-level hierarchy | elm account | QA Campus → Building Alpha → Floor 1/2/3 (3 levels deep) | Breadcrumb navigation, area drill-down |
| Prior period data | elm account | 60–120 days ago: different deficiency rates than current | Trend badge calculation, chart data |

### Post-Seed Verification

- [ ] Navigate to `http://elm.lvh.me:3000/reports/deficient_line_items` and verify the report loads with 7 qualifying line items
- [ ] Log in as `qa_restricted` / `password` and verify the report is NOT accessible (redirect or no menu entry)

---

## 4. Manual Testing Checklist

> Organized by feature area. Each item has steps, expected result, and the acceptance criteria it verifies.

### 4.1 Entry View — Summary Cards & Table Rendering

#### QA-001: Summary cards display correct metrics
**Criteria:** ENT-001 through ENT-005
**Steps:**
1. Log in as `crash` on the `elm` account
2. Navigate to Reports > Deficient Line Item Report
3. Observe the four summary cards above the table

**Expected:** Four cards visible: Total Deficiencies (non-zero), Total Inspected (non-zero), Overall Deficiency Rate (percentage with "vs. prior period" comparison), Line Items Tracked (should show 7).

---

#### QA-002: Line item table columns and data
**Criteria:** ENT-010 through ENT-017
**Steps:**
1. On the entry view, examine the line item table

**Expected:** Table has 7 columns: Line Item, # Deficient, # Total, % Deficient (with risk bar), Unique Areas, Avg Score, Trend. Each row represents one line item. "Floor Care" should show the highest % Deficient (~60%).

---

#### QA-003: Risk bar color thresholds
**Criteria:** UI-001, UI-002
**Steps:**
1. On the entry view, observe the % Deficient column

**Expected:** Floor Care (60%) shows a RED risk bar. Trash Removal (~40%) and Restroom Supplies (~40%) show AMBER risk bars. Lower-rate items show GREEN risk bars. The bar width is proportional to the rate.

---

#### QA-004: Trend badges display correctly
**Criteria:** ENT-018, TRD-001 through TRD-007
**Steps:**
1. On the entry view, observe the Trend column

**Expected:** Floor Care, Trash Removal, and Restroom Supplies show red ↑ (worsening). Window Cleaning and Dusting show green ↓ (improving). Others show gray — (flat) or no badge if no prior period data.

---

#### QA-005: Default sort order
**Criteria:** ENT-019, ENT-021
**Steps:**
1. Load the entry view fresh

**Expected:** Table is sorted by % Deficient descending. The % Deficient column header shows a directional arrow (▼) indicating the active sort.

---

#### QA-006: Column sorting
**Criteria:** ENT-020, ENT-021
**Steps:**
1. Click the "# Deficient" column header
2. Observe the table re-sort
3. Click the same header again

**Expected:** Table re-sorts by # Deficient descending on first click. Arrow indicator moves to # Deficient column. Second click reverses to ascending. The Trend column should NOT be sortable (no click handler).

---

#### QA-007: Row click navigates to drill-down
**Criteria:** ENT-024, ENT-025
**Steps:**
1. Hover over any row in the line item table
2. Click the row

**Expected:** Row highlights on hover (cursor changes to pointer). Clicking navigates to the drill-down view for that line item (`/reports/deficient_line_items/:id`).

---

#### QA-008: Report appears in Reports menu
**Criteria:** WEB-001
**Steps:**
1. Navigate to the Reports index page (`/reports`)

**Expected:** "Deficient Line Item Report" appears in the reports list. Clicking it navigates to the entry view.

---

### 4.2 Configurable Thresholds

#### QA-009: Defaults banner displays current thresholds
**Criteria:** CFG-001, CFG-002, CFG-011
**Steps:**
1. On the entry view, observe the banner below the report header

**Expected:** Banner text reads something like "Showing line items with 2+ deficiencies, 5+ inspections, flagging areas above 60% deficiency rate." An "Edit Defaults" button is visible.

---

#### QA-010: Edit Defaults modal opens and displays inputs
**Criteria:** CFG-003, CFG-004, CFG-005, CFG-006, CFG-007
**Steps:**
1. Click "Edit Defaults" button on the banner
2. Observe the modal

**Expected:** Modal opens with three number inputs: Repeat Threshold (value: 2), Minimum Sample Size (value: 5), High Risk Threshold (value: 60). Each input has helper text explaining what it controls.

---

#### QA-011: Save thresholds and verify report updates
**Criteria:** CFG-008, CFG-010, CFG-011
**Steps:**
1. Open Edit Defaults modal
2. Change Repeat Threshold to 1
3. Click "Save"
4. Observe the report

**Expected:** Modal closes. Report refreshes. Banner text updates to show "1+ deficiencies". Line items that were previously below the 2+ threshold (like Carpet Stains with 1 deficiency) now appear in the table. Line Items Tracked count increases.

---

#### QA-012: Cancel discards changes
**Criteria:** CFG-009
**Steps:**
1. Open Edit Defaults modal
2. Change a threshold value
3. Click "Cancel"

**Expected:** Modal closes. Report shows the same data as before — the changed value was NOT saved.

---

#### QA-013: Threshold persistence across sessions
**Criteria:** CFG-010
**Steps:**
1. Change a threshold and save (e.g., set Repeat Threshold to 3)
2. Navigate away from the report (e.g., to the Reports index)
3. Navigate back to the Deficient Line Item Report

**Expected:** The threshold is still set to 3. The banner reflects the saved value. The table shows only items with 3+ deficiencies.

---

### 4.3 Filters

#### QA-014: Filter panel opens and displays areas + forms
**Criteria:** FLT-001, FLT-002, FLT-003, FLT-004, FLT-009
**Steps:**
1. Click the "Filters" button in the report header toolbar
2. Observe the filter panel

**Expected:** A filter panel appears (slide-down). It has two sections: Areas (hierarchical tree with checkboxes) and Inspection Forms (list). The area tree shows "QA Campus" and its children expandable.

---

#### QA-015: Area filter narrows results
**Criteria:** FLT-006, FLT-015
**Steps:**
1. Open the filter panel
2. Select only "Building Alpha" in the Areas section
3. Click "Search" / "Apply"
4. Observe the table

**Expected:** Report refreshes showing only data from Building Alpha and its children (Floor 1, 2, 3). Line items with no data at Building Alpha may disappear. Summary card numbers decrease.

---

#### QA-016: Inspection form filter narrows results
**Criteria:** FLT-009, FLT-015
**Steps:**
1. Open the filter panel
2. Select only "Daily Janitorial" in the Inspection Forms section
3. Apply the filter

**Expected:** Report refreshes showing only data from inspections using the "Daily Janitorial" form. Line items inspected only on other forms may disappear.

---

#### QA-017: Date range filter changes data
**Criteria:** FLT-016
**Steps:**
1. Change the date range to the last 7 days
2. Observe the report

**Expected:** Report refreshes with data scoped to last 7 days only. Summary numbers change. Some line items may disappear if they have no recent inspections.

---

#### QA-018: Filters carry through to drill-down
**Criteria:** FLT-015
**Steps:**
1. Apply an area filter (e.g., Building Alpha only)
2. Click a line item row to drill down
3. Observe the drill-down data

**Expected:** The drill-down shows only areas within Building Alpha. The area concentration table shows Floor 1, Floor 2, Floor 3 (not Building Beta or Gamma).

---

### 4.4 Drill-Down View — Navigation & Summary

#### QA-019: Breadcrumb displays and navigates
**Criteria:** DDV-002, DDV-003, DDV-004
**Steps:**
1. Click "Floor Care" in the entry table
2. Observe the breadcrumb
3. Click "Building Alpha ▸" in the area concentration table
4. Observe the updated breadcrumb
5. Click the "Floor Care" segment in the breadcrumb

**Expected:**
- Step 2: Breadcrumb shows "Reports > Deficient Line Items > Floor Care"
- Step 4: Breadcrumb extends to "... > Floor Care > Building Alpha"
- Step 5: Navigates back to Floor Care top-level drill-down (all areas visible)

---

#### QA-020: Browser back button works
**Criteria:** DDV-005
**Steps:**
1. From the entry view, click a line item to drill down
2. Drill into an area
3. Click the browser Back button

**Expected:** Navigates to the previous level (line item top-level drill-down). Back again returns to the entry view. Each drill-down level is a distinct URL.

---

#### QA-021: Drill-down summary cards
**Criteria:** DDV-010, DDV-011, DDV-012, DDV-013
**Steps:**
1. Click "Floor Care" in the entry table
2. Observe the five summary cards

**Expected:** Five cards: # Deficient, # Total, Deficiency Rate (with trend badge), Unique Areas (shows "X of Y inspected"), Avg Score. Values are scoped to Floor Care across all areas.

---

#### QA-022: Area concentration table with HIGH RISK badges
**Criteria:** DDV-030, DDV-031, DDV-033, DDV-035
**Steps:**
1. On the Floor Care drill-down, observe the Area Concentration table

**Expected:** Table shows top-level areas (Building Alpha, Building Beta, Building Gamma) with columns: Area, # Deficient, # Total, % Deficient, Avg Score. Areas at or above 60% deficiency rate are flagged with a red "HIGH RISK" badge and subtle red row background.

---

#### QA-023: Area drill-down navigation (chevron/arrow)
**Criteria:** DDV-036, DDV-037, DDV-038, DDV-039
**Steps:**
1. In the area concentration table, observe Building Alpha — it should show a chevron (▸)
2. Click Building Alpha
3. Observe the updated table
4. Click a leaf area (e.g., Floor 1) — it should show an arrow (→)

**Expected:**
- Building Alpha has ▸ because it has sub-areas
- After clicking, table shows Floor 1, Floor 2, Floor 3 (direct children of Building Alpha)
- Breadcrumb updates
- Floor 1 shows → (leaf area); clicking it shows inspection form comparison

---

#### QA-024: Default sort in area concentration
**Criteria:** DDV-032
**Steps:**
1. On any drill-down level, observe the area concentration table

**Expected:** Areas are sorted by % Deficient descending (highest-risk areas first).

---

#### QA-025: Subtree aggregation in area metrics
**Criteria:** DDV-034, DDV-055
**Steps:**
1. On the Floor Care drill-down, note the metrics for Building Alpha
2. Click into Building Alpha and add up the metrics for Floor 1, Floor 2, Floor 3

**Expected:** Building Alpha's # Deficient and # Total at the parent level equal the sum of its children's metrics (data rolls up through the subtree).

---

### 4.5 Drill-Down View — Trend Chart

#### QA-026: Trend chart renders
**Criteria:** DDV-020, DDV-022, DDV-023
**Steps:**
1. On any line item drill-down, observe the trend chart

**Expected:** A bar chart displays below the summary cards, spanning the full width. Each bar has two layers: total inspections (light fill) and deficient count (contrasting overlay). A legend distinguishes the two layers.

---

#### QA-027: Adaptive time bucketing
**Criteria:** DDV-021
**Steps:**
1. Set date range to last 7 days → observe chart x-axis labels
2. Set date range to last 45 days → observe chart x-axis labels
3. Set date range to last 90 days → observe chart x-axis labels

**Expected:** 7 days shows daily buckets, 45 days shows weekly buckets, 90+ days shows monthly buckets. Labels on the x-axis change accordingly.

---

### 4.6 Drill-Down View — Inspection Form Comparison

#### QA-028: Leaf area shows form comparison table
**Criteria:** DDV-040, DDV-041, DDV-042, DDV-043, DDV-044, DDV-046
**Steps:**
1. Drill down to Floor Care > Building Alpha > Floor 1 (a leaf area)
2. Observe the table

**Expected:** Table header reads "Inspection Forms at Floor 1". Table has columns: Inspection Form, # Deficient, # Total, % Deficient, Avg Score. Each row is an inspection form that had Floor Care inspections at Floor 1 (e.g., Daily Janitorial, Monthly Deep Clean). Rows are NOT clickable — this is the terminal level.

---

#### QA-029: HIGH RISK badge on forms
**Criteria:** DDV-045
**Steps:**
1. At a leaf area, observe the form comparison table

**Expected:** Any form with a deficiency rate at or above the high risk threshold (default 60%) shows a red "HIGH RISK" badge and red row tint, matching the area concentration table's style.

---

### 4.7 Mixed Areas

#### QA-030: Mixed area displays two tables
**Criteria:** DDV-050, DDV-051, DDV-056, DDV-057, DDV-058
**Steps:**
1. Drill down to Floor Care > Building Gamma
2. Observe the page

**Expected:** Two stacked tables: "Sub-Areas" table first (showing Basement), then "Inspection Forms" table below (showing forms with direct inspections at Building Gamma). Sub-area rows are clickable (▸ or →). Form rows are NOT clickable. Sub-area metrics include all descendants; form metrics are specific to Building Gamma only.

---

### 4.8 Export — PDF

#### QA-031: PDF export from entry view
**Criteria:** PDF-001, PDF-005, PDF-006, PDF-007, PDF-008
**Steps:**
1. On the entry view with data showing, trigger a PDF export (via export mechanism or direct URL if no modal)
2. Open the downloaded PDF

**Expected:** PDF includes: account logo branding, report title "Deficient Line Item Report", date range, current threshold settings, summary cards section, and line item table. Data matches what's displayed on screen (same filters, same sort order).

---

#### QA-032: PDF export from drill-down view
**Criteria:** PDF-001, PDF-009
**Steps:**
1. Drill into a specific line item (e.g., Floor Care)
2. Trigger a PDF export

**Expected:** PDF contains data for Floor Care only. Includes summary cards and area concentration table scoped to Floor Care.

---

### 4.9 Export — CSV

#### QA-033: CSV export downloads correctly
**Criteria:** CSV-001, CSV-003, CSV-004
**Steps:**
1. From the entry view, trigger a CSV export
2. Open the downloaded CSV file

**Expected:** CSV has a header row with 9 columns: Line Item, Inspection Form, Area (Full Path), Area (Top Level), Inspection Date, Score, Deficient, Inspector, Comment. Each data row represents one individual deficient inspection item (not aggregated).

---

#### QA-034: CSV respects filters
**Criteria:** CSV-007
**Steps:**
1. Apply an area filter (e.g., Building Alpha only)
2. Export CSV
3. Open the CSV

**Expected:** CSV contains only rows for areas within Building Alpha (Floor 1, Floor 2, Floor 3). No rows from Building Beta, Gamma, or Basement.

---

#### QA-035: CSV area columns
**Criteria:** CSV-005, CSV-006
**Steps:**
1. Export a CSV and examine the "Area (Full Path)" and "Area (Top Level)" columns

**Expected:** "Area (Full Path)" shows the full hierarchy (e.g., "QA Campus / Building Alpha / Floor 1"). "Area (Top Level)" shows only the site-level name (e.g., "QA Campus").

---

### 4.10 Empty States & Permissions

#### QA-036: No inspection data empty state
**Criteria:** UI-012
**Steps:**
1. Log in as a user with read_reports permission but whose supervisory zones have no inspection data (or narrow the date range to a period with zero inspections for the areas)

**Expected:** Message displays: "No inspection data available for your areas. Inspections must be completed before deficiency data can be reported."

---

#### QA-037: No deficiencies in date range empty state
**Criteria:** UI-010
**Steps:**
1. Set the date range to a very recent period where no deficient inspections exist (e.g., today only)

**Expected:** Message displays guidance about no deficient line items found, suggesting adjusting the date range or thresholds.

---

#### QA-038: No items meet thresholds empty state
**Criteria:** UI-011
**Steps:**
1. Set Repeat Threshold to a very high number (e.g., 100)
2. Save thresholds

**Expected:** Message displays: "No line items have 100+ deficiencies with 5+ inspections in this period. Try lowering the threshold." The current threshold values are shown in the message.

---

#### QA-039: Permission denial — read_reports=false
**Criteria:** Authorization
**Steps:**
1. Log in as `qa_restricted` / `password`
2. Attempt to navigate to `/reports/deficient_line_items`

**Expected:** User is redirected or sees an access denied message. The report does NOT appear in the Reports menu for this user.

---

### 4.11 Print Styles

#### QA-040: Print-friendly rendering
**Criteria:** Polish
**Steps:**
1. On the entry view with data showing, use the browser's Print Preview (Ctrl+P / Cmd+P)

**Expected:** The Edit Defaults button, filter panel, and modal are hidden (`hidden-print`). The line item table, summary cards, and defaults banner text remain visible. Output is clean and suitable for printing.

---

---

## 5. Edge Cases & Boundary Conditions

| # | Scenario | How to Test | Expected Result | Criteria |
|---|----------|-------------|-----------------|----------|
| 1 | Direct URL to invalid line item | Navigate to `/reports/deficient_line_items/99999` | 404 or redirect to entry view | Edge case |
| 2 | Cross-account line item URL | If you know a line item ID from another account, navigate to its drill-down URL | 404 (RecordNotFound) | Security |
| 3 | Cross-account structure URL | Navigate to `/reports/deficient_line_items/:id?structure_id=<other_account_structure>` | 404 (RecordNotFound) | Security |
| 4 | Threshold change on drill-down disqualifies line item | While on a drill-down, change Repeat Threshold to 100 and save | User returned to entry view (line item no longer qualifies) | CFG edge case |
| 5 | Date range change on drill-down disqualifies line item | While on a drill-down, change date range to a period with no data for this line item | User returned to entry view or drill-down shows zero state | FLT edge case |
| 6 | Leaf area with single form | Drill to a leaf area that has only one inspection form | Table shows single row, no errors | DDV edge case |
| 7 | Line item with only N/A responses | Verify that line items with zero total inspections (all N/A) don't appear | Should not appear in the table | Data rule |
| 8 | Prior period has no data | Verify trend badges for line items without prior period data | No trend badge displayed (empty cell) | TRD-007 |

---

## 6. Known Limitations

Items explicitly deferred or not implemented in this version:

| Item | Status | Notes |
|------|--------|-------|
| Export modal (`_export_modal.html.erb`) | Not created | The PDF and CSV exporter services work correctly, but the UI modal to trigger exports is not built. Exports must be triggered via direct URL or programmatic method for now. This is the most significant gap — the export infrastructure is ready but the user-facing trigger is missing. |
| DDV-024: Chart header prior period comparison text | Not implemented | The trend chart renders but does not show "vs. prior period: ↑ 18% worse" text in the header. Trend information is available on the summary cards. |
| DDV-048: Leaf summary cards show Forms count | Not implemented | Summary cards show the same 5 metrics at all levels (Unique Areas instead of Forms count at leaf). |
| DDV-052/DDV-053: Table headers with counts | Not implemented | Sub-area and form table headers don't include item counts (e.g., "Sub-Areas of Building Gamma (1)"). Headers display without counts. |
| DDV-054: Drill-down table pagination | Not implemented | Tables show all rows (no pagination at 10 per page). Acceptable for V1 — typical area counts are small (5-20). |
| FLT-007: Partial-selection indicator | Not implemented | Parent area checkboxes don't show indeterminate state when only some children are selected. |
| FLT-013/FLT-014: Filter pill badges & button count | Not implemented | No pill badges below header showing active filter counts. Filter button doesn't show count. |
| UI-013: Export button disabled when no data | Not implemented | Depends on export modal which is not created. |
| Loading state | Not implemented | Standard Rails request/response cycle — no async loading indicator while report computes. |
| Filter panel uses slide-down (not slide-out) | Design deviation | PRD specified slide-out from right (FLT-002), but implementation follows existing codebase convention (slide-down panel) for consistency with other reports. |
| Proactive alerting | Deferred to V1.1 | Not in scope for V1. Edit Defaults modal designed to accommodate alerting config in the future. |
| Custom comparison period | Deferred to V1.1 | V1 uses prior equivalent period only. |
| Connected actions / corrective action logging | Deferred to V2 | V1 surfaces insight only — no workflow integration. |
| Mobile (iOS/Android) | Out of scope | Web-only desk-based reporting tool. |
| Excel/XLSX export | Out of scope | No Excel export infrastructure exists. |

---

## 7. Regression Concerns

Areas where existing functionality could be affected by this change:

| Area | Risk | What to Check |
|------|------|---------------|
| Reports index page | Low | New entry link added — verify other report links still work and aren't displaced |
| Existing report exports | Low | `FACTORY_ADAPTERS` array modified — verify existing exports (e.g., `DeficientLineItemPdf`, `LowestLineItemCsv`) still work |
| Routes | Low | New routes added to `namespace :reports` — verify existing report URLs (e.g., `/reports/overall`) still resolve correctly |
| Stimulus controllers registration | Low | `controllers/index.js` modified — verify existing Stimulus controllers still initialize (dashboard charts, other interactive elements) |
| AGENTS.md documentation | None | Documentation-only change, no functional impact |

---

## 8. Rollback Plan

| Step | Action | Notes |
|------|--------|-------|
| Feature flag | No feature flag exists | Report is visible to all users with `read_reports` + `read_inspections` permissions. To hide it, the code must be reverted. |
| Code revert | Revert the `pipeline/deficient-line-items-report` branch (remove all commits from staging) | This removes routes, controllers, views, exporters, and the Stimulus controller. Clean removal. |
| Migration | `drop_table :report_settings` | The migration is reversible. The `report_settings` table is the only schema change. |
| Data cleanup | No data cleanup needed | The `report_settings` table stores user preferences only. Dropping it resets all users to defaults. No inspection data is modified by this feature. |
| Export factory | Revert change to `report_export.rb` | Remove the two new exporter entries from `FACTORY_ADAPTERS`. Existing export jobs referencing the removed types will fail gracefully (no matching handler). |

---

## QA Sign-Off

### Tester: ___________
### Date: ___________
### Status: Pending

- [ ] All manual test scenarios verified (QA-001 through QA-040)
- [ ] Edge cases tested (items 1–8)
- [ ] Regression areas checked
- [ ] No blocking issues found

#### Issues Found
| # | Severity | Description | Status |
|---|----------|-------------|--------|
| | | | |

#### Notes
[Any observations, feedback, or suggestions from QA]
