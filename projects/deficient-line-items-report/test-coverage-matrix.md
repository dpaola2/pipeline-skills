# Test Coverage Matrix — Deficient Line Item Report

> Generated by Pipeline Stage 4 (Test Generation)
> Date: February 5, 2026
> Maps every gameplan acceptance criterion to its test location(s).

## Summary

| Metric | Value |
|--------|-------|
| **Milestones covered** | M1–M8 |
| **Acceptance criteria mapped** | 87 |
| **Test files created** | 6 (+ 1 factory) |
| **Platform** | Rails only (Level 2, web-only) |
| **iOS / Android** | N/A |

## Test Files

| File | Type | Covers |
|------|------|--------|
| `spec/factories/report_setting.rb` | Factory | ReportSetting test data |
| `spec/models/report_setting_spec.rb` | Model | M1: ReportSetting validations, defaults, `.for()` |
| `spec/services/analytics/deficient_line_items_spec.rb` | Service | M1: All analytics methods, scoping, thresholds, trends |
| `spec/requests/reports/deficient_line_items_controller_spec.rb` | Request | M2, M4, M5, M6, M8: Entry view, drill-down, filters, edge cases |
| `spec/requests/reports/deficient_line_item_settings_controller_spec.rb` | Request | M3: Threshold save, persistence, user isolation |
| `spec/services/exporter/deficient_line_item_report_pdf_spec.rb` | Service | M7: PDF export, sections, filters, drill-down |
| `spec/services/exporter/deficient_line_item_report_csv_spec.rb` | Service | M7: CSV export, columns, scoping, large report detection |

## Coverage Matrix

### M1: Data Model & Core Analytics

| Criterion | Description | Test File | Describe/Context |
|-----------|-------------|-----------|------------------|
| `report_settings` table | Table exists with correct columns | `spec/models/report_setting_spec.rb` | `describe "factory"` |
| ReportSetting validates report_type | Presence, uniqueness scoped to user | `spec/models/report_setting_spec.rb` | `describe "validations" > "report_type"` |
| ReportSetting validates settings | Presence of settings jsonb | `spec/models/report_setting_spec.rb` | `describe "validations" > "settings"` |
| ReportSetting.for() | Returns existing or initializes with defaults | `spec/models/report_setting_spec.rb` | `describe ".for"` |
| ReportSetting.for() partial overrides | Merges defaults for missing keys | `spec/models/report_setting_spec.rb` | `describe ".for" > "partial overrides"` |
| Accessor methods | repeat_threshold, minimum_sample_size, high_risk_threshold | `spec/models/report_setting_spec.rb` | `describe "#repeat_threshold"` etc. |
| DEFAULTS constant | Correct default values | `spec/models/report_setting_spec.rb` | `describe "DEFAULTS"` |
| total_deficiencies | Count of deficient items within scope | `spec/services/analytics/deficient_line_items_spec.rb` | `describe "#total_deficiencies"` |
| total_inspected | Count of all applicable items | `spec/services/analytics/deficient_line_items_spec.rb` | `describe "#total_inspected"` |
| N/A exclusion | Items with not_applicable_at excluded | `spec/services/analytics/deficient_line_items_spec.rb` | `describe "#total_inspected" > "N/A"` |
| overall_deficiency_rate | Percentage rounded to 1 decimal | `spec/services/analytics/deficient_line_items_spec.rb` | `describe "#overall_deficiency_rate"` |
| qualifying_line_items | Returns items meeting both thresholds | `spec/services/analytics/deficient_line_items_spec.rb` | `describe "#qualifying_line_items"` |
| qualifying_line_items columns | line_item_id, name, deficient_count, total_count, rate, areas, avg_score | `spec/services/analytics/deficient_line_items_spec.rb` | `"includes expected columns"` |
| Sort/pagination | sort_column, sort_direction, page, per_page | `spec/services/analytics/deficient_line_items_spec.rb` | `"sort_column and sort_direction"`, `"pagination"` |
| Repeat threshold filter | Excludes below repeat threshold | `spec/services/analytics/deficient_line_items_spec.rb` | `"filtering by repeat threshold"` |
| Sample size filter | Excludes below minimum sample | `spec/services/analytics/deficient_line_items_spec.rb` | `"filtering by minimum sample size"` |
| Account scoping | Only current account line items | `spec/services/analytics/deficient_line_items_spec.rb` | `"account scoping"` |
| Date range scoping | Only items within date range | `spec/services/analytics/deficient_line_items_spec.rb` | `"scoping" > "only counts items within the date range"` |
| User access scoping | Only items accessible to user | `spec/services/analytics/deficient_line_items_spec.rb` | `"scoping" > "only counts items accessible to the user"` |
| unique_areas | Count of distinct areas with deficiencies | `spec/services/analytics/deficient_line_items_spec.rb` | `"unique_areas calculation"` |
| avg_score | Average of deficient items only | `spec/services/analytics/deficient_line_items_spec.rb` | `"avg_score calculation"` |
| Sort sanitization | Invalid sort columns fall back to deficiency_rate | `spec/services/analytics/deficient_line_items_spec.rb` | `"sort column sanitization"` |
| trend_badge | Returns :worsening, :improving, :flat, nil | `spec/services/analytics/deficient_line_items_spec.rb` | `describe "#trend_badge"` |
| TRD-001 through TRD-006 | 5pp threshold boundaries | `spec/services/analytics/deficient_line_items_spec.rb` | `describe "#trend_badge"` (7 contexts) |
| TRD-007 | nil when no prior data | `spec/services/analytics/deficient_line_items_spec.rb` | `"when prior rate is nil"` |
| prior_period_rates_for | Batch prior period computation | `spec/services/analytics/deficient_line_items_spec.rb` | `describe "#prior_period_rates_for"` |
| drill_down_summary | Summary metrics for a line item | `spec/services/analytics/deficient_line_items_spec.rb` | `describe "#drill_down_summary"` |
| drill_down_summary with structure | Scoped to structure subtree | `spec/services/analytics/deficient_line_items_spec.rb` | `"with structure scoping"` |
| area_concentration | Per-area metrics at top level | `spec/services/analytics/deficient_line_items_spec.rb` | `describe "#area_concentration"` |
| area_concentration sorted | Sorted by deficiency_rate DESC | `spec/services/analytics/deficient_line_items_spec.rb` | `"sorts by deficiency_rate descending"` |
| area_concentration scoped | Children of parent structure | `spec/services/analytics/deficient_line_items_spec.rb` | `"scoped to parent structure"` |
| area_concentration zero excluded | Areas with no data excluded | `spec/services/analytics/deficient_line_items_spec.rb` | `"areas with zero total excluded"` |
| form_comparison | Per-form metrics at leaf area | `spec/services/analytics/deficient_line_items_spec.rb` | `describe "#form_comparison"` |
| trend_data | Time-bucketed deficiency data | `spec/services/analytics/deficient_line_items_spec.rb` | `describe "#trend_data"` |
| trend_data with structure | Scoped to structure subtree | `spec/services/analytics/deficient_line_items_spec.rb` | `"with structure scoping"` |

### M2: Entry View — Summary Cards & Line Item Table

| Criterion | Description | Test File | Describe/Context |
|-----------|-------------|-----------|------------------|
| ENT-001 through ENT-005 | Summary cards rendered | `spec/requests/reports/deficient_line_items_controller_spec.rb` | `"with qualifying data"` |
| ENT-010 through ENT-017 | Table columns and metrics | Covered by analytics service spec | `#qualifying_line_items` |
| ENT-018 | Trend badges | Covered by analytics service spec | `#trend_badge` |
| ENT-019 | Default sort % Deficient DESC | `spec/requests/reports/deficient_line_items_controller_spec.rb` | `"default sorting"` |
| ENT-020 | Sortable columns | `spec/requests/reports/deficient_line_items_controller_spec.rb` | `"custom sorting"` |
| ENT-022 | Only items meeting thresholds | `spec/requests/reports/deficient_line_items_controller_spec.rb` | `"threshold filtering"` |
| ENT-023 | Supervisory zone scoping | `spec/requests/reports/deficient_line_items_controller_spec.rb` | `"supervisory zone scoping"` |
| ENT-026 | Pagination | `spec/requests/reports/deficient_line_items_controller_spec.rb` | `"pagination"` |
| WEB-001 | Route at /reports/deficient_line_items | `spec/requests/reports/deficient_line_items_controller_spec.rb` | `"route existence"` |
| Authorization | read_reports + read_inspections required | `spec/requests/reports/deficient_line_items_controller_spec.rb` | `"authorization"` |
| Multi-tenant isolation | Cross-tenant data never shown | `spec/requests/reports/deficient_line_items_controller_spec.rb` | `"cross-tenant isolation"` |

### M3: Configurable Thresholds

| Criterion | Description | Test File | Describe/Context |
|-----------|-------------|-----------|------------------|
| CFG-008 | Save closes modal, refreshes | `spec/requests/reports/deficient_line_item_settings_controller_spec.rb` | `"with valid params"` |
| CFG-010 | Settings persist per-user | `spec/requests/reports/deficient_line_item_settings_controller_spec.rb` | `"updating existing settings"` |
| CFG-004/005/006 | Individual threshold inputs | `spec/requests/reports/deficient_line_item_settings_controller_spec.rb` | `"updating only one threshold"` |
| User isolation | One user's settings don't affect another's | `spec/requests/reports/deficient_line_item_settings_controller_spec.rb` | `"user isolation"` |
| Authorization | read_reports required | `spec/requests/reports/deficient_line_item_settings_controller_spec.rb` | `"without read_reports permission"` |

### M4: Filters — Date Range, Areas, Forms

| Criterion | Description | Test File | Describe/Context |
|-----------|-------------|-----------|------------------|
| FLT-015 | Active filters apply to entry + drill-down | `spec/requests/reports/deficient_line_items_controller_spec.rb` | `"with area filters"`, `"with filter params"` |
| FLT-016 | Date filter | `spec/requests/reports/deficient_line_items_controller_spec.rb` | `"with date range params"` |
| Filter params to analytics | Filters flow through to service | `spec/services/analytics/deficient_line_items_spec.rb` | Date range scoping tests |

> **Note:** FLT-001 through FLT-014 are UI/UX requirements (slide-out panel, checkboxes, pill badges) that are best verified via system/E2E tests or manual QA. The controller specs verify that filter parameters are correctly processed.

### M5: Drill-Down View — Navigation, Summary, Area Concentration

| Criterion | Description | Test File | Describe/Context |
|-----------|-------------|-----------|------------------|
| DDV-001 | Drill-down accessed by line item ID | `spec/requests/reports/deficient_line_items_controller_spec.rb` | `"line item lookup"` |
| DDV-010 through DDV-013 | Drill-down summary cards | `spec/services/analytics/deficient_line_items_spec.rb` | `describe "#drill_down_summary"` |
| DDV-030 through DDV-035 | Area concentration table | `spec/services/analytics/deficient_line_items_spec.rb` | `describe "#area_concentration"` |
| DDV-036/DDV-037 | Area with sub-areas (chevron, click-through) | `spec/services/analytics/deficient_line_items_spec.rb` | `has_children` key in results |
| DDV-038/DDV-039 | Leaf area (arrow, form comparison) | `spec/requests/reports/deficient_line_items_controller_spec.rb` | `"leaf area (form comparison)"` |
| WEB-002 | Route at /reports/deficient_line_items/:id | `spec/requests/reports/deficient_line_items_controller_spec.rb` | `"with valid line item"` |
| Structure scoping | Structure from other account → 404 | `spec/requests/reports/deficient_line_items_controller_spec.rb` | `"with structure from another account"` |
| Invalid line item | 404 for non-existent ID | `spec/requests/reports/deficient_line_items_controller_spec.rb` | `"with invalid line item ID"` |
| Cross-account line item | 404 for other account's line item | `spec/requests/reports/deficient_line_items_controller_spec.rb` | `"with line item from another account"` |

### M6: Drill-Down View — Trend Chart, Form Comparison, Mixed Areas

| Criterion | Description | Test File | Describe/Context |
|-----------|-------------|-----------|------------------|
| DDV-020 through DDV-024 | Trend chart data | `spec/services/analytics/deficient_line_items_spec.rb` | `describe "#trend_data"` |
| DDV-040 through DDV-048 | Form comparison | `spec/services/analytics/deficient_line_items_spec.rb` | `describe "#form_comparison"` |
| DDV-050 through DDV-058 | Mixed areas and forms | `spec/requests/reports/deficient_line_items_controller_spec.rb` | `"mixed area/form display"` |

### M7: Export — PDF & CSV

| Criterion | Description | Test File | Describe/Context |
|-----------|-------------|-----------|------------------|
| PDF-001 | Export from entry + drill-down | `spec/services/exporter/deficient_line_item_report_pdf_spec.rb` | `describe "#perform"` |
| PDF-002/PDF-003 | PDF format with section checkboxes | `spec/services/exporter/deficient_line_item_report_pdf_spec.rb` | `"with section selection"` |
| PDF-005 | Only selected sections | `spec/services/exporter/deficient_line_item_report_pdf_spec.rb` | `"with section selection"` |
| PDF-008 | Reflects current filters | `spec/services/exporter/deficient_line_item_report_pdf_spec.rb` | `"with filters"` |
| PDF-009 | Drill-down exports single line item | `spec/services/exporter/deficient_line_item_report_pdf_spec.rb` | `"drill-down export"` |
| CSV-001 | Export from entry + drill-down | `spec/services/exporter/deficient_line_item_report_csv_spec.rb` | `describe "#perform"` |
| CSV-003 | One row per deficient inspection item | `spec/services/exporter/deficient_line_item_report_csv_spec.rb` | `"with deficient items"` |
| CSV-004 | Nine columns | `spec/services/exporter/deficient_line_item_report_csv_spec.rb` | `"CSV header"` |
| CSV-007 | Respects current filters | `spec/services/exporter/deficient_line_item_report_csv_spec.rb` | `"with area filter"` |
| CSV drill-down | Scoped to line_item_id | `spec/services/exporter/deficient_line_item_report_csv_spec.rb` | `"with line_item_id parameter"` |
| CSV-008 | No summary card metrics in CSV | `spec/services/exporter/deficient_line_item_report_csv_spec.rb` | Header has 9 data columns only |
| Large report detection | >10K rows triggers confirmation | `spec/services/exporter/deficient_line_item_report_csv_spec.rb` | `describe "#large_report?"` |
| Multi-tenant isolation | Only current account data | `spec/services/exporter/deficient_line_item_report_csv_spec.rb` | `"cross-tenant isolation"` |
| Export factory registration | FACTORY_ADAPTERS includes both | N/A — verified by `.handles?` tests | `.handles?` with correct/incorrect types |

### M8: Empty States, Edge Cases & Polish

| Criterion | Description | Test File | Describe/Context |
|-----------|-------------|-----------|------------------|
| UI-010 | No deficiencies in date range | `spec/requests/reports/deficient_line_items_controller_spec.rb` | `"empty states" > "no inspection data"` |
| UI-011 | No items meet thresholds | `spec/requests/reports/deficient_line_items_controller_spec.rb` | `"empty states" > "no line items meet thresholds"` |
| UI-012 | No inspection data at all | `spec/requests/reports/deficient_line_items_controller_spec.rb` | `"empty states" > "no inspection data at all"` |
| Edge: N/A only items | Excluded (zero total) | `spec/services/analytics/deficient_line_items_spec.rb` | N/A exclusion test |
| Edge: Deleted areas | Excluded via active scope | Covered by scoping chain (`.active`) | |
| Edge: read_reports=false | Not accessible | `spec/requests/reports/deficient_line_items_controller_spec.rb` | `"authorization"` |
| Edge: Invalid line item URL | Redirect/404 | `spec/requests/reports/deficient_line_items_controller_spec.rb` | `"with invalid line item ID"` |
| Edge: Cross-account line item | 404 | `spec/requests/reports/deficient_line_items_controller_spec.rb` | `"with line item from another account"` |
| Edge: Cross-account structure | 404 | `spec/requests/reports/deficient_line_items_controller_spec.rb` | `"with structure from another account"` |
| TRD-007: No prior data | Trend badge not displayed | `spec/services/analytics/deficient_line_items_spec.rb` | `"when prior rate is nil"` |

## Criteria Not Directly Testable in Unit/Request Specs

These criteria are UI/UX behaviors best verified through system tests or manual QA:

| Criterion | Description | Why |
|-----------|-------------|-----|
| ENT-021 | Active sort column arrow | Visual rendering |
| ENT-024 | Clicking row navigates to drill-down | UI interaction |
| ENT-025 | Rows highlight on hover | CSS behavior |
| UI-001/UI-002 | Risk bar rendering and color thresholds | Visual rendering |
| CFG-001/002/003/007/009/011 | Banner text, modal UI, helper text, cancel behavior | UI interactions |
| FLT-001 through FLT-014 | Filter panel UI (slide-out, tree, checkboxes, pills) | UI interactions |
| DDV-002 through DDV-005 | Breadcrumb navigation, browser back | Navigation/UI |
| DDV-021 | Adaptive time bucketing display | Chart rendering |
| DDV-022/023 | Stacked bar chart layers and legend | Chart rendering |
| DDV-024 | Chart header prior period text | Chart rendering |
| PDF-006/007 | PDF branding and metadata | PDF visual verification |
| PDF-010 | Section selection UI | UI interaction |
| CSV-009 | Export modal description text | UI rendering |
| WEB-003/004/005 | Modal and panel net new status | UI verification |
| UI-013 | Export button disabled when no data | UI state |
| Polish items | Loading state, spacing, print styles | Visual/UX |

These will be covered by manual QA as specified in the gameplan's testing plan.
