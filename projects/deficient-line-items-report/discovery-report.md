# Deficient Line Item Report - Discovery Report

> **Generated by:** Pipeline Stage 1 (Discovery)
> **Date:** February 5, 2026
> **PRD:** `projects/deficient-line-items-report/prd.md`

---

## 1. PRD Understanding

### Feature Summary

A new web-only report that aggregates inspection deficiency data **by line item** across an account. Users start with a summary table showing which line items fail most consistently (sorted by deficiency rate), then drill down through the area hierarchy to see where failures are concentrated. The report includes configurable thresholds (per-user persistent), area/form filters, trend comparisons to prior periods, and PDF/CSV export. This is a net new report — no existing features are modified.

### Entities Identified

| Entity | PRD Reference | Existing? | Current Location |
|--------|--------------|-----------|-----------------|
| InspectionItem | ENT-013, ENT-014 (the row-level data source) | Yes | `app/models/inspection_item.rb` |
| Inspection | ENT-014 (parent record, date range, structure, form) | Yes | `app/models/inspection.rb` |
| LineItem | ENT-012 (the grouping key for the report table) | Yes | `app/models/line_item.rb` |
| InspectionFormItem | (links line items to forms, carries weight) | Yes | `app/models/inspection_form_item.rb` |
| InspectionForm | FLT-009, DDV-040 (filter and leaf-level drill-down) | Yes | `app/models/inspection_form.rb` |
| Structure | FLT-004, DDV-030 (area hierarchy, drill-down) | Yes | `app/models/structure.rb` |
| InspectionFormsStructures | (form-to-area assignment junction) | Yes | `app/models/inspection_forms_structures.rb` |
| User | CFG-010 (threshold persistence) | Yes | `app/models/user.rb` |
| UserPermission | (read_reports check) | Yes | `app/models/user_permission.rb` |
| SupervisoryZone | ENT-023 (area access scoping) | Yes | `app/models/supervisory_zone.rb` |
| ReportExport | PDF-001, CSV-001 (export infrastructure) | Yes | `app/models/report_export.rb` |
| Per-user threshold settings | CFG-010 (repeat threshold, sample size, high risk) | **No** | No existing model — needs new storage |
| Rating / RangeChoice | (defines deficiency flag per choice) | Yes | `app/models/rating.rb`, `app/models/range_choice.rb` |

### Platforms Affected

- [x] Rails (Web Admin)
- [ ] Rails (API)
- [ ] iOS
- [ ] Android

This is a **Level 2 (web-only)** project. No mobile or API endpoints are required.

---

## 2. Current State: Rails

### Related Models

| Model | File | Key Associations | Notes |
|-------|------|------------------|-------|
| InspectionItem | `app/models/inspection_item.rb` | `belongs_to :inspection, :rating, :line_item, :category, :account` | 204M rows (Tier 0). Core data source. Has `deficient` boolean, `score` float, `not_applicable_at`, `weight`. |
| Inspection | `app/models/inspection.rb` | `belongs_to :structure, :inspection_form, :user, :account; has_many :inspection_items` | 12M rows (Tier 0). Provides `ended_at` for date filtering, `structure_id` for area scoping. |
| LineItem | `app/models/line_item.rb` | `belongs_to :account` | 202K rows. Simple name-based entity unique per account. The grouping key for the report. |
| InspectionForm | `app/models/inspection_form.rb` | `has_many :inspection_form_items, :line_items (through); belongs_to :structure` | 54K rows. Used in leaf-level drill-down and form filtering. |
| InspectionFormItem | `app/models/inspection_form_item.rb` | `belongs_to :inspection_form, :line_item, :rating, :category` | 973K rows. Links line items to forms with weight and position. |
| Structure | `app/models/structure.rb` | `has_ancestry; has_many :inspections, :supervisory_zones; belongs_to :account` | 740K rows. Hierarchical via `ancestry` gem. Types: Company, Site (Project), Area (nil). |
| Rating | `app/models/rating.rb` | `has_many :range_choices, :inspection_items; belongs_to :account` | Defines scoring type. Only `PERCENTAGE_TYPE_ID (1)` and `POINTS_TYPE_ID (7)` support deficiency. |
| RangeChoice | `app/models/range_choice.rb` | `belongs_to :rating` | Each choice has `deficient` boolean + `percentage_score`. Deficiency is configured here. |
| ReportExport | `app/models/report_export.rb` | `belongs_to :user` | Factory pattern for export processing. `FACTORY_ADAPTERS` list. Shrine S3 storage. |

### Current Schema (Related Tables)

```sql
-- inspection_items (204M rows, 91GB total — TIER 0)
-- Key columns for this report:
--   inspection_id  → joins to inspections (for date, structure, form)
--   line_item_id   → the grouping key
--   deficient      → boolean, default false
--   score          → float (0.0 to 1.0 for percentage type)
--   weight         → integer, default 1
--   not_applicable_at → datetime, null = applicable
--   deleted_at     → soft delete
-- Existing indexes:
--   (inspection_id, line_item_id, deficient, weight) — "multi_inspection_items"
--   (line_item_id)
--   (inspection_id)

-- inspections (12M rows, 9.5GB total — TIER 0)
-- Key columns:
--   structure_id        → links to area hierarchy
--   inspection_form_id  → links to form
--   ended_at            → date range filtering
--   deficient           → boolean (inspection-level rollup)
--   finalized           → boolean (only finalized inspections matter)
--   account_id
--   deleted_at
--   private             → boolean (private inspection access control)
-- Existing indexes:
--   (structure_id, ended_at, inspection_form_id) WHERE deleted_at IS NULL — "multi_inspections_not_deleted"
--   (account_id, ended_at)

-- line_items (202K rows, 49MB)
-- Key columns:
--   account_id
--   name → display name, unique per account
-- Indexes: (account_id), (name)

-- structures (740K rows, 697MB)
-- Key columns:
--   account_id, name, structure_type, ancestry, active_children_count, deleted_at
-- Indexes: (ancestry) with GiST, (account_id)

-- inspection_forms (54K rows, 27MB)
-- Key columns:
--   name, structure_id, shared, private, type, deleted_at
-- Indexes: (structure_id), (private), (shared), (type)

-- inspection_forms_structures (1.8M rows, 422MB)
-- Key columns:
--   inspection_form_id, structure_id, deleted_at
-- Indexes: (inspection_form_id), (structure_id), (deleted_at)

-- supervisory_zones (172K rows, 72MB)
-- Key columns:
--   user_id, structure_id
-- Links users to their accessible structures

-- user_permissions (49K rows, 21MB)
-- Key columns:
--   read_reports (boolean, default true) — the gating permission
```

### Related Controllers

| Controller | File | Actions | Auth Pattern |
|-----------|------|---------|--------------|
| ReportsController | `app/controllers/reports_controller.rb` | index | `require_read_reports_permission` |
| Reports::BaseController | `app/controllers/reports/base_controller.rb` | (base class) | `require_read_reports_permission`, sets default date range (45 days) |
| Reports::OverallsController | `app/controllers/reports/overalls_controller.rb` | show | Inherits from BaseController. Uses `Analytics::FilterSelection` + `Analytics::InspectionItems` |
| ReportExportsController | `app/controllers/report_exports_controller.rb` | new, create, show, edit, update | Creates `ReportExport` records, checks `large_report?`, delegates to Delayed::Job |

### Related Serializers / Blueprints

| Serializer | File | Notes |
|-----------|------|-------|
| InspectionItemBlueprint | `app/blueprints/inspection_item_blueprint.rb` | API serialization — not directly relevant (web-only report) |

No existing report blueprint exists. The new report is a web view, not an API endpoint.

### Related API Endpoints (Current)

| Method | Path | Purpose | Notes |
|--------|------|---------|-------|
| GET | `/api/v4/deficient_inspection_item_count` | Returns count of deficient items | Simple count endpoint, not a full report |
| GET | `/api/v4/inspection_score_average` | Returns average inspection score | Used by mobile dashboard |

These existing API endpoints are not modified by this feature. The new report is web-only.

### Related Tests

| Test File | Coverage | Type |
|-----------|----------|------|
| `spec/models/inspection_item_spec.rb` | Model validations, scopes | Model spec |
| `spec/models/inspection_spec.rb` | Model validations, scopes | Model spec |
| `spec/models/line_item_spec.rb` | Basic model validations | Model spec |
| `spec/services/analytics/` | Analytics service tests | Service spec |
| `spec/services/exporter/` | Export tests | Service spec |

### Related Background Jobs

| Job | File | Purpose |
|-----|------|---------|
| ReportExportProcessor | `app/jobs/report_export_processor.rb` | Processes report exports via Delayed::Job. 5-minute timeout, 1 max attempt. |

### Existing Export Infrastructure

The export system uses a **factory pattern**:

1. `ReportExport` model stores `report_type` + `parameters` (serialized filter params)
2. `FACTORY_ADAPTERS` list maps report types to exporter classes
3. `ReportExportProcessor` (Delayed::Job) calls `adapter.new(report_export).perform`
4. CSV exporters include `Exporter::Csvable` mixin, PDF exporters include `Exporter::PdfHelper`
5. PDFs use **Prawn** gem for generation
6. Files uploaded to **S3 via Shrine**, URLs expire in 24 hours

**Existing name collision:** `Exporter::DeficientLineItemPdf` already exists (`app/services/exporter/deficient_line_item_pdf.rb`) — but this is an **inspection-level** PDF that lists individual deficient items per inspection with photos and comments. It is NOT the same as the new aggregated report. The architecture stage must choose a distinct name.

---

## 3. Current State: iOS

N/A — Level 2 (web-only) project.

---

## 4. Current State: Android

N/A — Level 2 (web-only) project.

---

## 5. Cross-Platform Patterns

### Data Flow (for this report)

```
inspection_items (204M rows)
  → JOIN inspections (date range, structure, form, finalized, active)
  → JOIN line_items (grouping key — line item name)
  → JOIN structures (area hierarchy via ancestry)
  → Filtered by: supervisory_zones (user access), date range, form filters
  → Aggregated: GROUP BY line_item_id (entry view), then by structure/form (drill-down)
```

### How Deficiency Is Determined

Deficiency is **not derived from a score threshold** — it is a boolean flag set at inspection time:

1. Each `Rating` has `RangeChoice` records, each with a `deficient: true/false` flag
2. When an inspector selects a range choice, the `inspection_items.deficient` column is set accordingly
3. Items with `not_applicable_at IS NOT NULL` are excluded from all deficiency calculations
4. The deficient flag is only supported on `percentage` (type 1) and `points` (type 7) rating types

This means the PRD's definition of "deficient" maps directly to `inspection_items.deficient = true`.

### How N/A Is Handled

- Column: `inspection_items.not_applicable_at` (datetime, null = applicable)
- Scopes: `.applicable` → `WHERE not_applicable_at IS NULL`; `.not_applicable` → `WHERE not_applicable_at IS NOT NULL`
- N/A items are excluded from scoring (`percentage_scorable`, `points_scorable` scopes filter `.applicable`)
- N/A items are excluded from deficiency counting (`deficient_inspection_items` filters `not_applicable_at: nil`)

### How the Existing Analytics Layer Works

The `Analytics::Filters` module (`app/services/analytics/filters.rb`) provides the canonical filter infrastructure:

- **Initialization:** `Analytics::ClassName.new(current_user, params)` — accepts user + filter hash
- **Date range:** `start_date` / `end_date` parsed from params, defaults to 90 days ago
- **Structure scoping:** `scoped_supervisory_structures` handles area filtering
- **Form filtering:** `forms` returns `InspectionForm.accessible_to(user).active.where(id: form_ids)`
- **Time grouping:** `suggested_grouping_by_time` → day (<3 weeks), week (3 weeks–100 days), month (>100 days)

The `Analytics::InspectionItems` class (`app/services/analytics/inspection_items.rb`) already has:
- `highest_performing` and `lowest_performing` methods that GROUP BY `line_items.id`
- Standard query chain: `.accessible_to(user).between(dates).has_score.has_weight.active.applicable`
- This is the closest existing pattern to what the new report needs, but it limits to 10 results and doesn't support the full aggregation the PRD requires

### How Similar Reports Are Built

The Overall Report (`Reports::OverallsController`) follows this pattern:

1. Controller creates `Analytics::FilterSelection.new(current_user, params)`
2. View renders partial hierarchy (filters, summary, charts, tables)
3. Export links point to `new_report_export_path` with `report_type` param
4. Date range picker uses `shared/_daterange_picker.html.erb` partial + Stimulus controller

### Permission Model

Three-layer access control:
1. **Permission check:** `require_read_reports_permission` → `user.can?(:read, :reports)` → `user_permissions.read_reports`
2. **Structure scoping:** `InspectionItem.accessible_to(user)` → joins through `inspection → structure` → filters by `supervisory_zones` ancestry
3. **Account isolation:** `.where(structures: { account_id: user.account })`

Private inspection handling: if user lacks `read_private_inspections`, an additional WHERE clause excludes `inspections.private = TRUE`.

---

## 6. Technical Risks

| Risk | Severity | Details | Mitigation |
|------|----------|---------|------------|
| Query performance on 204M-row inspection_items table | **High** | The core query must GROUP BY line_item_id across all inspection_items matching date range + access scopes. This touches a Tier 0 table. N+1 queries in drill-down (per area, per form) compound this. | Assess if existing indexes suffice. The `multi_inspection_items` index covers `(inspection_id, line_item_id, deficient, weight)` but the report queries from the OTHER direction (line_item → inspection). May need a new index. Consider materialized views or pre-aggregation for accounts with high data volumes. |
| Trend calculation requires two date-range queries | **Med** | Each trend badge (entry view has one per line item, drill-down has one per area) needs current period AND prior period deficiency rates. This could double query load. | Compute prior period in a single query alongside current period using CASE/FILTER expressions, or batch the trend calculation. |
| No existing per-user preference storage model | **Med** | The PRD requires three thresholds (repeat, sample size, high risk) to persist per-user. No `UserPreference` or generic key-value model exists. Settings are currently spread across purpose-specific models (notification_settings, etc.). | Architecture must decide: add columns to `users` table, create a new `user_report_settings` table, or use a generic key-value approach. |
| Structure hierarchy query complexity | **Med** | Ancestry-based subtree queries use string matching on the `ancestry` column (`LIKE 'X/%'`). For drill-down aggregation, the report must roll up metrics across all descendants of each displayed area. With deeply nested hierarchies, this generates complex OR-chain WHERE clauses. | Follow existing `Structure.multiple_subtree_conditions` pattern. The GiST index on `ancestry` helps. Consider caching subtree structure IDs. |
| Existing `DeficientLineItemPdf` name collision | **Low** | `Exporter::DeficientLineItemPdf` already exists as an inspection-level PDF exporter. The new report's PDF exporter needs a different name. | Choose a distinct `REPORT_TYPE` name (e.g., `DeficientLineItemReportPdf`, `DeficiencyPatternReportPdf`). |
| Date filter defaults differ from PRD expectations | **Low** | `Reports::BaseController` defaults to 45 days. `Analytics::Filters` defaults to 90 days. The PRD says "defaults to the current period." The concept of "current period" needs definition. | Clarify what "current period" means (likely the account's configured billing/reporting period, or the current month). |
| PDF chart rendering | **Low** | The trend chart (DDV-020) needs to be rendered as a static image in the PDF export. The existing pattern uses `Shared::GraphImageHelper` to generate chart images for Prawn. | Follow existing `OverallAveragePerformancePdf` pattern which already embeds chart images. |

### Performance Concerns

- **Primary concern:** The core aggregation query groups 204M+ inspection_items by line_item_id, joining through inspections and structures. Without optimization, this could be a multi-second query for large accounts.
- **Index analysis:** The existing `multi_inspection_items` index `(inspection_id, line_item_id, deficient, weight)` is optimized for lookups starting from inspection_id. The report query starts from line_item_id and filters by date range (via inspections.ended_at) and structure (via inspections.structure_id). A covering index like `(line_item_id, deficient) WHERE deleted_at IS NULL AND not_applicable_at IS NULL` on inspection_items could help, but must be justified against the Tier 0 table constraints.
- **Drill-down N+1:** Each area in the concentration table needs its own aggregation. Batch this into a single GROUP BY query rather than N separate queries.
- **Pagination:** Entry table page size is TBD. For accounts with many line items, pagination prevents loading all aggregations at once.

### Security Concerns

- **Multi-tenant scoping:** All queries must flow through `accessible_to(user)` or equivalent. The existing pattern is well-established.
- **Supervisory zone enforcement:** The PRD requirement ENT-023 ("Only line items within the user's supervisory zone access appear") maps directly to the existing `InspectionItem.accessible_to(user)` scope.
- **Private inspections:** The `accessible_to` scope already handles private inspection filtering based on `user.can?(:read, :private_inspections)`.

---

## 7. Open Questions

| # | Question | Source | Blocking? |
|---|----------|--------|-----------|
| 1 | What does "current period" mean for the default date range? The existing reports default to 45 or 90 days. The PRD says "defaults to the current period and respects the user's last selection" (FLT-016). Is this the current calendar month? Current billing period? | PRD FLT-016 | No — can use existing 45-day default and refine |
| 2 | How should per-user threshold settings be stored? No generic user preference model exists. Options: (a) new `report_settings` table with user_id + report_type + JSON settings, (b) new columns on `users` table, (c) new dedicated model. | PRD CFG-010 | Yes — architecture needs to decide storage approach |
| 3 | Should the `score` column on inspection_items be used for "Avg Score" in the report, or should the score be re-derived from range_choice? The PRD says "average score of deficient instances only." The existing score is stored as 0.0–1.0 (percentage type) or null (non-percentage types). | PRD ENT-017, DDV-033 | Yes — need to confirm what "Avg Score" means for mixed rating types |
| 4 | How should the report handle inspection_items that have `deficient = true` but `score IS NULL`? Points-type items can be deficient but have no percentage score. Should these contribute to "Avg Score"? | PRD ENT-017 | No — likely use score for percentage type, points for points type, or display as N/A |
| 5 | The existing `multi_inspection_items` index covers `(inspection_id, line_item_id, deficient, weight)`. Will the report's aggregation query (which filters by date range via inspections.ended_at and groups by line_item_id) benefit from a new index, and is adding one acceptable given the Tier 0 table constraints? | Performance risk, AGENTS.md Tier 0 guidance | Yes — architecture must propose and justify any new indexes |
| 6 | The PRD mentions "Line Items Tracked" (ENT-005) counting items "meeting the configured repeat and minimum sample thresholds." Should this count be computed in the same query as the main table, or as a separate lightweight query? | PRD ENT-005 | No — implementation detail |
| 7 | The PRD filter panel (FLT-004) requires a hierarchical area tree with expand/collapse. Does the existing `shared/advanced_area_filter` partial support this, or is a new component needed? | PRD FLT-004 through FLT-008 | No — need to assess existing component capability |

---

## 8. Recommendations for Architecture Stage

- **Follow the existing analytics pattern.** Build a new `Analytics::DeficientLineItems` service class that includes `Analytics::Filters` and follows the same `accessible_to(user).between(dates).active.applicable` query chain established in `Analytics::InspectionItems`.

- **Extend the existing report controller pattern.** Add `Reports::DeficientLineItemsController` inheriting from `Reports::BaseController`. This gets `require_read_reports_permission` and default date range for free.

- **Extend the existing export factory.** Add new exporter classes (CSV + PDF) to `ReportExport::FACTORY_ADAPTERS`. Follow the Csvable/PdfHelper mixin pattern. Name them distinctly from the existing `DeficientLineItemPdf`.

- **Use the `InspectionItem.deficient` boolean directly.** Don't re-derive deficiency from scores — the boolean is the source of truth, set at inspection time based on the range choice configuration.

- **For per-user threshold persistence**, consider a lightweight approach: either a new `report_settings` table (user_id + report_type + jsonb settings) that can serve future reports too, or columns directly on the users table if the scope is strictly this report.

- **For performance**, the architecture must decide upfront whether the report can use real-time aggregation or needs pre-computation. The `inspection_items` table at 204M rows is the critical bottleneck. Index strategy and query plan analysis should be part of the architecture proposal.

- **For the area hierarchy drill-down**, leverage `Structure.multiple_subtree_conditions` for subtree filtering and the existing `ancestry` gem methods for parent/child navigation. The `active_children_count` counter cache on structures can determine whether an area is a leaf (count = 0) without additional queries.

- **For the date filter**, reuse `shared/_daterange_picker.html.erb` and the `date_range_picker_controller.js` Stimulus controller. The existing infrastructure supports predefined ranges and custom date selection.
