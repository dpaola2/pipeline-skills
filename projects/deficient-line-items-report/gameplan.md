# Deficient Line Item Report - Engineering Gameplan

> **Generated by:** Pipeline Stage 3 (Gameplan)
> **Date:** February 5, 2026
> **PRD:** `projects/deficient-line-items-report/prd.md`
> **Discovery Report:** `projects/deficient-line-items-report/discovery-report.md`
> **Approved Architecture:** `projects/deficient-line-items-report/architecture-proposal.md`
> **Linear Project:** TBD

---

## 1. Project Overview

### Goals
- Surface repeat deficiency patterns by line item across a BSC's account
- Enable drill-down from line item → area hierarchy → inspection form comparison
- Provide configurable, per-user thresholds that control report visibility
- Support PDF and CSV export for QBR preparation
- Ship as a single-phase release behind a feature flag

### Scope Summary

| Milestone | Description | Platform |
|-----------|-------------|----------|
| M0 | Discovery & Alignment | N/A (complete) |
| M1 | Data Model & Core Analytics | Web (Rails) |
| M2 | Entry View — Summary Cards & Line Item Table | Web (Rails) |
| M3 | Configurable Thresholds | Web (Rails) |
| M4 | Filters — Date Range, Areas, Forms | Web (Rails) |
| M5 | Drill-Down View — Navigation, Summary, Area Concentration | Web (Rails) |
| M6 | Drill-Down View — Trend Chart & Mixed Areas | Web (Rails) |
| M7 | Export — PDF & CSV | Web (Rails) |
| M8 | Empty States, Edge Cases & Polish | Web (Rails) |

### Out of Scope
- Proactive alerting / email notifications (V1.1)
- Attribution to people (cleaners, teams, managers)
- Custom comparison period selection (V1.1)
- Connected actions (create ticket, assign corrective action)
- Corrective action logging (V2)
- Mobile (iOS / Android)
- Excel/XLSX export

### Constraints & Conventions
- AGENTS.md: `~/projects/orangeqc/orangeqc/AGENTS.md`
- Level 2 (web-only) project — no API endpoints, no mobile
- `inspection_items` is Tier 0 (204M rows) — no new indexes in V1
- Deficiency is a pre-computed boolean (`inspection_items.deficient`), not derived at query time
- OrangeQC error format: `{ "error": "Type", "message": "..." }` (flat, not field-level)
- Reports inherit from `Reports::BaseController` (45-day default date range, `read_reports` permission)

---

## 2. Open Questions & Decisions

> Resolved during Stages 1-2 (Discovery + Architecture)

| # | Question | Status | Decision |
|---|----------|--------|----------|
| 1 | What does "current period" mean for the default date range? | Resolved | Use 45-day default from `Reports::BaseController` for consistency with existing reports. Users can adjust. |
| 2 | How should per-user threshold settings be stored? | Resolved | New `report_settings` table with `user_id` + `report_type` + `jsonb settings`. Extensible for future reports. |
| 3 | Should `inspection_items.score` be used for "Avg Score"? | Resolved | Yes — use `AVG(score * 100.0) FILTER (WHERE deficient AND score IS NOT NULL)`. Items with NULL scores don't contribute to the average. Display "N/A" if all scores are NULL. |
| 4 | How handle deficient items with NULL score? | Resolved | Skip them in average. Points-type items may have NULL percentage score — the avg score column shows "N/A" for those. |
| 5 | New index on Tier 0 `inspection_items` table? | Resolved | No new index in V1. Date range filter on `inspections.ended_at` is highly selective (~45-day window over years of data). Monitor post-launch; add partial index if needed. |
| 6 | Filter panel: Stimulus + form vs. Turbo Frame? | Resolved | Stimulus + standard form submission. Consistent with existing filter patterns. |
| 7 | Unified PDF export vs. per-section? | Resolved | Section checkboxes (unified pattern). Low implementation cost — PDF builder generates sections sequentially. `sections` parameter controls which render. |
| 8 | Chart rendering in PDF? | Resolved | Server-side via `GraphImageHelper` + Gruff. Consistent with existing `OverallAveragePerformancePdf`. |
| 9 | Naming collision with existing `DeficientLineItemPdf`? | Resolved | New exporters named `DeficientLineItemReportPdf` / `DeficientLineItemReportCsv`. |

---

## 3. Functional Milestones

> Organized by FEATURE AREA, not by platform.

### M0: Discovery & Alignment (Complete)
- [x] PRD parsed and understood (Stage 1)
- [x] Current state documented across platforms (Stage 1)
- [x] Data model proposed and **approved** (Stage 2 + Architecture Review)
- [x] Open questions resolved (Stages 1-2)

---

### M1: Data Model & Core Analytics Service
**What:** Create the `report_settings` table and the `Analytics::DeficientLineItems` service class. This is the foundation everything else builds on.

**Acceptance Criteria:**
- [ ] `report_settings` table exists with `user_id`, `report_type`, `settings` (jsonb), and unique index on `(user_id, report_type)`
- [ ] `ReportSetting` model validates presence of `report_type`, uniqueness scoped to `user_id`, and presence of `settings`
- [ ] `ReportSetting.for(user, report_type)` returns existing settings or initializes with defaults (repeat: 2, sample: 5, high risk: 60)
- [ ] `Analytics::DeficientLineItems` includes `Analytics::Filters` module
- [ ] `Analytics::DeficientLineItems#total_deficiencies` returns count of deficient inspection items within scoped date range and access
- [ ] `Analytics::DeficientLineItems#total_inspected` returns count of all applicable, active inspection items (excluding N/A) within scope
- [ ] `Analytics::DeficientLineItems#overall_deficiency_rate` returns `total_deficiencies / total_inspected * 100`, rounded to 1 decimal
- [ ] `Analytics::DeficientLineItems#qualifying_line_items` returns line items meeting both repeat threshold AND minimum sample size thresholds, with columns: `line_item_id`, `line_item_name`, `deficient_count`, `total_count`, `deficiency_rate`, `unique_areas`, `avg_score`
- [ ] `qualifying_line_items` supports `sort_column`, `sort_direction`, `page`, `per_page` params
- [ ] `qualifying_line_items` uses `FILTER (WHERE ...)` PostgreSQL syntax for conditional aggregates
- [ ] All queries are scoped through `InspectionItem.accessible_to(current_user).between(start_date, end_date).active.applicable`
- [ ] Prior period is calculated as a mirror-duration window immediately preceding the selected date range
- [ ] `prior_period_rates_for(line_item_ids)` batch-computes prior period deficiency rates for a set of line items in a single query
- [ ] `trend_badge(current_rate:, prior_rate:)` returns `:worsening` (>+5pp), `:improving` (<-5pp), `:flat` (within ±5pp), or `nil` (no prior data) — matching TRD-001 through TRD-007
- [ ] `drill_down_summary(line_item_id:, structure:)` returns metrics for a specific line item optionally scoped to a structure subtree
- [ ] `area_concentration(line_item_id:, parent_structure:)` returns per-area metrics for direct children of the parent (or top-level supervisory structures if nil)
- [ ] `form_comparison(line_item_id:, structure:)` returns per-inspection-form metrics at a specific leaf area
- [ ] `trend_data(line_item_id:, structure:)` returns time-bucketed deficiency counts using `suggested_grouping_by_time`

**Web/API:**
- [ ] Migration: `db/migrate/XXXXXX_create_report_settings.rb` — create `report_settings` table with unique index
- [ ] Model: `app/models/report_setting.rb` — with `DEFAULTS`, `for()` class method, accessor methods
- [ ] Service: `app/services/analytics/deficient_line_items.rb` — full analytics service
- [ ] Tests: `spec/models/report_setting_spec.rb` — model validations, defaults, `for()` method
- [ ] Tests: `spec/services/analytics/deficient_line_items_spec.rb` — all public methods, scoping, thresholds, trend calculation, prior period

**iOS:** N/A
**Android:** N/A

**Dependencies:** None (first milestone)

---

### M2: Entry View — Summary Cards & Line Item Table
**What:** Build the entry view controller, layout, summary cards, sortable line item table with risk bars, trend badges, and pagination. This is the primary report surface users see.

**Acceptance Criteria:**
- [ ] ENT-001: Entry view displays four summary cards: Total Deficiencies, Total Inspected, Overall Deficiency Rate, Line Items Tracked
- [ ] ENT-002: Total Deficiencies shows sum of all deficient inspection items across qualifying line items
- [ ] ENT-003: Total Inspected shows total inspection count excluding N/A items
- [ ] ENT-004: Overall Deficiency Rate shows percentage with comparison to prior period (e.g., "↑ 3% vs. prior period")
- [ ] ENT-005: Line Items Tracked shows count of line items meeting current thresholds
- [ ] ENT-010: Table displays one row per unique line item aggregated across all forms and areas
- [ ] ENT-011: Table has seven columns: Line Item, # Deficient, # Total, % Deficient, Unique Areas, Avg Score, Trend
- [ ] ENT-012–017: Each column displays the correct metric as specified in the PRD
- [ ] ENT-018: Trend column shows directional badge — ↑ Worsening (red), ↓ Improving (green), — Flat (gray) — based on ±5pp threshold (TRD-001–TRD-006)
- [ ] TRD-007: Trend badge is not displayed when no prior period data exists
- [ ] ENT-019: Table defaults to sorting by % Deficient descending
- [ ] ENT-020: All columns except Trend are sortable; clicking a column header sorts by that column
- [ ] ENT-021: Active sort column displays directional arrow
- [ ] ENT-022: Only line items meeting repeat threshold AND minimum sample threshold appear
- [ ] ENT-023: Only line items within user's supervisory zone appear
- [ ] ENT-024: Clicking any row navigates to drill-down view for that line item
- [ ] ENT-025: Rows highlight on hover
- [ ] ENT-026: Table paginates when qualifying line items exceed page size (25 per page)
- [ ] UI-001: % Deficient column displays a horizontal risk bar alongside the percentage
- [ ] UI-002: Risk bar is red (>= high risk threshold), amber (35%–threshold), green (<35%)
- [ ] WEB-001: Entry view is a net new page at `/reports/deficient_line_items`
- [ ] Report appears in Reports menu (`reports/index.html.erb`) with `can?(:read, :inspections)` guard
- [ ] Report is accessible only to users with `read_reports` permission

**Web/API:**
- [ ] Routes: Add `resources :deficient_line_items, only: [:index, :show]` to `namespace :reports`
- [ ] Controller: `app/controllers/reports/deficient_line_items_controller.rb` — `index` action with pagination, sorting, batch prior period rates
- [ ] View: `app/views/reports/deficient_line_items/index.html.erb` — main entry layout
- [ ] Partial: `_summary_cards.html.erb` — four metric cards with trend comparison
- [ ] Partial: `_line_item_table.html.erb` — sortable table with column headers as sort links
- [ ] Partial: `_risk_bar.html.erb` — colored bar with threshold-based coloring
- [ ] Partial: `_pagination.html.erb` — page controls
- [ ] Modify: `app/views/reports/index.html.erb` — add report entry link
- [ ] Tests: `spec/controllers/reports/deficient_line_items_controller_spec.rb` — index action, authorization, pagination, sorting

**iOS:** N/A
**Android:** N/A

**Dependencies:** M1 (needs analytics service and report_settings model)

---

### M3: Configurable Thresholds
**What:** Build the defaults banner and Edit Defaults modal. Users can view and configure the three thresholds (repeat, sample size, high risk) that control report visibility and flagging. Settings persist per-user.

**Acceptance Criteria:**
- [ ] CFG-001: Persistent banner below report header showing current thresholds in plain language (e.g., "Showing line items with 2+ deficiencies, 5+ inspections, flagging areas above 60% deficiency rate")
- [ ] CFG-002: Banner displays "Edit Defaults" button
- [ ] CFG-003: Clicking "Edit Defaults" opens a modal with three inputs
- [ ] CFG-004: Repeat Threshold input — minimum deficiencies for a line item to appear. Default: 2.
- [ ] CFG-005: Minimum Sample Size input — minimum inspections for a line item to appear. Default: 5.
- [ ] CFG-006: High Risk Threshold input — deficiency rate at or above which areas are flagged HIGH RISK. Default: 60.
- [ ] CFG-007: Each input displays helper text
- [ ] CFG-008: Clicking "Save" closes modal, report refreshes with new thresholds applied
- [ ] CFG-009: Clicking "Cancel" closes modal with no changes
- [ ] CFG-010: All three thresholds persist per-user across sessions (stored in `report_settings` table)
- [ ] CFG-011: Defaults banner text updates after save
- [ ] WEB-003: Edit Defaults Modal is net new
- [ ] Edge case: User changes thresholds while on drill-down and current line item no longer qualifies → return to entry view with message

**Web/API:**
- [ ] Routes: Add `resource :deficient_line_item_settings, only: [:update]` to `namespace :reports`
- [ ] Controller: `app/controllers/reports/deficient_line_item_settings_controller.rb` — `update` action
- [ ] Partial: `_defaults_banner.html.erb` — threshold display with "Edit Defaults" button
- [ ] Partial: `_edit_defaults_modal.html.erb` — Bootstrap modal with three inputs, helper text, Save/Cancel
- [ ] Stimulus: `deficient_line_items_settings_controller.js` — modal open/close management
- [ ] Tests: Settings controller spec — save, validation, persistence across requests

**iOS:** N/A
**Android:** N/A

**Dependencies:** M1 (needs `ReportSetting` model), M2 (banner integrates into entry view layout)

---

### M4: Filters — Date Range, Areas, Inspection Forms
**What:** Build the filter infrastructure: date range picker (reuse existing), slide-out filter panel with hierarchical area tree and inspection form checkboxes, active filter pill badges.

**Acceptance Criteria:**
- [ ] FLT-001: "Filters" button displayed in report header toolbar
- [ ] FLT-002: Clicking Filters opens a slide-out panel from the right
- [ ] FLT-003: Panel has two sections: Areas and Inspection Forms
- [ ] FLT-004: Areas section displays hierarchical tree matching user's supervisory zone with expand/collapse
- [ ] FLT-005: Areas section includes search field that filters the tree by name
- [ ] FLT-006: Areas selectable via checkboxes; selecting parent selects all children
- [ ] FLT-007: Parent displays partial-selection indicator when some but not all children are selected
- [ ] FLT-008: Areas section includes "Clear" link to deselect all
- [ ] FLT-009: Inspection Forms section displays flat list of available forms, selectable via checkboxes
- [ ] FLT-010: Inspection Forms section includes "Clear" link
- [ ] FLT-011: Panel footer has "Apply Filters" and "Cancel" buttons
- [ ] FLT-012: Panel footer has "Clear all" link
- [ ] FLT-013: When filters active, pill badges appear below header (e.g., "3 areas selected", "2 forms selected") with "Clear all"
- [ ] FLT-014: Filters button shows active count (e.g., "Filters (5)")
- [ ] FLT-015: Active filters apply to both entry view and drill-down view
- [ ] FLT-016: Date filter uses existing OrangeQC date filter pattern (45-day default)
- [ ] WEB-004: Filter Panel is net new
- [ ] Edge case: User applies filters and drills down → drill-down data is also filtered
- [ ] Edge case: User clicks "Cancel" → panel closes, no changes
- [ ] Edge case: User clicks "Clear all" in pill badges → all filters removed

**Web/API:**
- [ ] Partial: `_filters.html.erb` — date picker (reuse `shared/_daterange_picker.html.erb`), Filters button, active filter pills
- [ ] Partial: `_filter_panel.html.erb` — slide-out panel with area tree and form checkboxes
- [ ] Stimulus: `deficient_line_items_filter_controller.js` — panel slide, area tree expand/collapse/search, checkbox cascading, apply/clear
- [ ] Tests: Controller spec — filter params flow through to analytics service, structure scoping, form filtering

**iOS:** N/A
**Android:** N/A

**Dependencies:** M2 (integrates into entry view layout)

---

### M5: Drill-Down View — Navigation, Summary Cards & Area Concentration
**What:** Build the drill-down view with breadcrumb navigation, scoped summary cards, area concentration table with HIGH RISK flagging, and structure-level drill-down (chevron/arrow navigation).

**Acceptance Criteria:**
- [ ] DDV-001: Drill-down accessed by clicking row in entry table
- [ ] DDV-002: Breadcrumb shows "All Line Items / [Line Item Name]"
- [ ] DDV-003: Breadcrumb extends with area path when drilling into areas
- [ ] DDV-004: Clicking breadcrumb segment navigates back to that level
- [ ] DDV-005: Browser back button navigates to previous level
- [ ] DDV-010: Drill-down displays five summary cards: # Deficient, # Total, Deficiency Rate, Unique Areas, Avg Score
- [ ] DDV-011: Deficiency Rate card shows trend badge
- [ ] DDV-012: Unique Areas card shows context (e.g., "4 of 12 inspected")
- [ ] DDV-013: Avg Score card labeled as severity indicator, reflects deficient instances only
- [ ] DDV-030: Area Concentration table displayed below trend chart section
- [ ] DDV-031: Initial drill-down shows only top-level areas where line item was deficient
- [ ] DDV-032: Table defaults to sort by % Deficient descending
- [ ] DDV-033: Table has five columns: Area, # Deficient, # Total, % Deficient, Avg Score
- [ ] DDV-034: Area metrics are aggregated totals including all sub-areas (rolled up)
- [ ] DDV-035: Areas at or above high risk threshold flagged with red "HIGH RISK" badge + red row tint
- [ ] DDV-036: Areas with sub-areas display chevron (▸)
- [ ] DDV-037: Clicking area with sub-areas navigates into that area showing direct children; cards/chart update
- [ ] DDV-038: Leaf areas display arrow (→)
- [ ] DDV-039: Clicking leaf area transitions to inspection form comparison
- [ ] WEB-002: Drill-down view is net new at `/reports/deficient_line_items/:id`
- [ ] Edge case: Direct URL to line item not meeting thresholds → redirect to entry view
- [ ] Edge case: Date range change causes line item to no longer qualify → return to entry with message

**Web/API:**
- [ ] Controller: `deficient_line_items_controller.rb` — `show` action with `line_item_id`, `structure_id` params, area concentration, breadcrumb data
- [ ] View: `app/views/reports/deficient_line_items/show.html.erb` — drill-down layout
- [ ] Partial: `_breadcrumbs.html.erb` — clickable breadcrumb segments
- [ ] Partial: `_summary_cards.html.erb` — reused with drill-down variant (5 cards)
- [ ] Partial: `_area_concentration.html.erb` — area table with HIGH RISK badges, chevron/arrow icons
- [ ] Tests: Controller spec — show action, structure navigation, scoping, redirect for invalid line items

**iOS:** N/A
**Android:** N/A

**Dependencies:** M1 (analytics service), M2 (entry view for navigation source), M4 (filters must carry through to drill-down)

---

### M6: Drill-Down View — Trend Chart, Inspection Form Comparison & Mixed Areas
**What:** Add the trend bar chart, inspection form comparison table (leaf level), and mixed area/form display (DDV-050 series). This completes the drill-down view.

**Acceptance Criteria:**
- [ ] DDV-020: Bar chart displays deficiency data over time, full width
- [ ] DDV-021: Adaptive time bucketing: daily (≤7 days), weekly (8–60 days), monthly (61+ days)
- [ ] DDV-022: Each bar has two layers: total inspections (light) and deficient count (overlay)
- [ ] DDV-023: Legend distinguishes total from deficient
- [ ] DDV-024: Chart header shows prior period comparison (e.g., "vs. prior period: ↑ 18% worse")
- [ ] DDV-040: Clicking leaf area transitions table from areas to inspection form comparison
- [ ] DDV-041: Table header updates to "Inspection Forms at [Area Name]"
- [ ] DDV-042: Table has five columns: Inspection Form, # Deficient, # Total, % Deficient, Avg Score
- [ ] DDV-043: Each row is a form assigned to that leaf area containing the line item
- [ ] DDV-044: Allows comparison of same line item across forms at same location
- [ ] DDV-045: Forms at or above high risk threshold flagged with "HIGH RISK" badge
- [ ] DDV-046: Form rows are not clickable (terminal level)
- [ ] DDV-047: Breadcrumb shows full path to leaf area
- [ ] DDV-048: Summary cards at leaf: # Deficient, # Total, Deficiency Rate, Forms count, Avg Score
- [ ] DDV-050: When area has both sub-areas AND direct forms, two stacked tables shown
- [ ] DDV-051: Sub-areas table first, then forms table
- [ ] DDV-052: Sub-areas table header: "Sub-Areas of [Area Name] ([count])"
- [ ] DDV-053: Forms table header: "Inspection Forms at [Area Name] ([count])"
- [ ] DDV-054: Each table paginates independently (10 per page, controls shown at 11+)
- [ ] DDV-055: Sub-area metrics include all descendants (rolled up)
- [ ] DDV-056: Form metrics specific to that form at current area only
- [ ] DDV-057: Sub-area rows clickable (▸ or →), form rows not clickable
- [ ] DDV-058: If only sub-areas, show sub-areas table only; if only forms (leaf), show forms only
- [ ] DDV-059: Summary cards at mixed level aggregate across all sub-areas and direct forms
- [ ] Edge case: Leaf area has only one inspection form → table shows single row

**Web/API:**
- [ ] Partial: `_trend_chart.html.erb` — Chart.js stacked bar chart container with data attributes
- [ ] Stimulus: `deficient_line_items_chart_controller.js` — render Chart.js stacked bar chart from data attributes
- [ ] Partial: `_form_comparison.html.erb` — inspection form table for leaf areas
- [ ] Controller updates: Handle mixed area/form display logic, leaf detection via `active_children_count`
- [ ] Tests: Controller spec — trend data, form comparison, mixed area handling, leaf vs non-leaf

**iOS:** N/A
**Android:** N/A

**Dependencies:** M5 (drill-down view structure must exist)

---

### M7: Export — PDF & CSV
**What:** Build both export pipelines: PDF with section selection and CSV with raw inspection-level data. Register in the existing export factory.

**Acceptance Criteria:**
- [ ] PDF-001: User can export PDF from both entry view and drill-down view via Export modal
- [ ] PDF-002: Export modal presents "PDF" format option with section checkboxes
- [ ] PDF-003: Entry view PDF sections: Summary Cards, Line Item Table (both default checked)
- [ ] PDF-004: Drill-down PDF sections: Summary Cards, Trend Chart, Area Concentration Table (all default checked)
- [ ] PDF-005: Generated PDF includes only selected sections
- [ ] PDF-006: PDF branded with account logo
- [ ] PDF-007: PDF shows date range, generation timestamp, current threshold settings
- [ ] PDF-008: PDF reflects current filters and sort order
- [ ] PDF-009: Drill-down PDF exports currently viewed line item only
- [ ] PDF-010: Section selection UI implemented (unified export pattern)
- [ ] CSV-001: User can export CSV from both entry and drill-down view
- [ ] CSV-002: CSV option shows no section selection — always exports full dataset matching filters
- [ ] CSV-003: CSV has one row per individual deficient inspection item (not aggregated)
- [ ] CSV-004: Nine columns: Line Item, Inspection Form, Area (Full Path), Area (Top Level), Inspection Date, Score, Deficient (Yes/No), Inspector, Comment
- [ ] CSV-005: Area (Full Path) displays full hierarchy path
- [ ] CSV-006: Area (Top Level) displays only top-level area name
- [ ] CSV-007: CSV respects current date range, thresholds, and filters
- [ ] CSV-008: CSV does not include summary card metrics
- [ ] CSV-009: Export modal displays description of CSV contents and filter context
- [ ] WEB-005: Export Modal is net new
- [ ] UI-013: Export button disabled when no data to export
- [ ] Large CSV (>10K rows) triggers confirmation flow (existing pattern)
- [ ] Export registered in `ReportExport::FACTORY_ADAPTERS`

**Web/API:**
- [ ] Service: `app/services/exporter/deficient_line_item_report_pdf.rb` — Prawn PDF with section selection, branding, threshold display, chart embedding via `GraphImageHelper`
- [ ] Service: `app/services/exporter/deficient_line_item_report_csv.rb` — CSV with `find_each` batching, 9 columns, `large_report?` check
- [ ] Modify: `app/models/report_export.rb` — add both new exporters to `FACTORY_ADAPTERS`
- [ ] Partial: `_export_modal.html.erb` — format selection (PDF/CSV), section checkboxes, filter context display
- [ ] Tests: `spec/services/exporter/deficient_line_item_report_pdf_spec.rb` — sections, branding, data accuracy
- [ ] Tests: `spec/services/exporter/deficient_line_item_report_csv_spec.rb` — columns, scoping, batching, large report detection

**iOS:** N/A
**Android:** N/A

**Dependencies:** M1 (analytics service for data), M2 + M5 (export entry points in views)

---

### M8: Empty States, Edge Cases & Polish
**What:** Implement all empty state messages, handle edge cases documented in the PRD, and polish the UI (hover states, loading indicators, responsive tweaks).

**Acceptance Criteria:**
- [ ] UI-010: No deficiencies in date range → "No deficient line items found for [date range]. Adjust the date range or threshold to see results."
- [ ] UI-011: No line items meet thresholds → "No line items have [X]+ deficiencies with [Y]+ inspections in this period. Try lowering the threshold."
- [ ] UI-012: No inspection data at all → "No inspection data available for your areas. Inspections must be completed before deficiency data can be reported."
- [ ] Edge case: Line item has only N/A responses → excluded entirely (zero total = does not appear)
- [ ] Edge case: All deficiencies at deleted areas → excluded (deleted structures filtered)
- [ ] Edge case: Line item exists on deleted form → still appears (historical data valid, form name displayed as-is)
- [ ] Edge case: 100% deficiency rate with low sample (e.g., 2/2) → filtered by minimum sample threshold (default 5+)
- [ ] Edge case: User has `read_reports` = false → report not accessible, not in menu
- [ ] Edge case: User's supervisory zone changes mid-period → report reflects current access at time of viewing
- [ ] Edge case: Admin user with full access → sees all data, no area filtering
- [ ] Edge case: User navigates directly to drill-down URL for invalid line item → redirect to entry view
- [ ] Edge case: Date range change on drill-down causes line item to no longer qualify → return to entry with message
- [ ] Edge case: Threshold change on drill-down causes current line item to no longer qualify → return to entry with message
- [ ] Edge case: Prior period has no data → trend badge not displayed (TRD-007)
- [ ] Edge case: Table has 11+ items in drill-down → pagination controls appear (10 per page per DDV-054)
- [ ] Polish: Loading state while report computes
- [ ] Polish: Consistent spacing, responsive behavior, print styles (`hidden-print` for interactive elements)

**Web/API:**
- [ ] Update entry view index to handle all three empty state scenarios with appropriate messages
- [ ] Update drill-down show to handle redirect cases (invalid line item, threshold change)
- [ ] Update all tables to handle zero-row cases gracefully
- [ ] Add `hidden-print` classes to filter buttons, export buttons, modals
- [ ] Tests: Edge case specs — empty states, permission denial, redirect scenarios

**iOS:** N/A
**Android:** N/A

**Dependencies:** M2–M7 (polishes all prior milestones)

---

## 4. Non-Functional Requirements Checklist

### Data Model & API
> Reviewed and approved in the Architecture Review checkpoint.

- [x] Architecture proposal approved: `projects/deficient-line-items-report/architecture-proposal.md` (Status: Approved, 2/5/2026)
- [x] Milestones correctly reference the approved data model (`report_settings` table) and analytics service design
- [x] No contradictions between gameplan and approved architecture
- [x] No API endpoints needed (Level 2, web-only)

### Security & Access Control
- [x] All queries scoped via `InspectionItem.accessible_to(current_user)` → joins through `inspection: :structure` → filters by `supervisory_zones` + `account_id`
- [x] Controller inherits `Reports::BaseController` → `require_read_reports_permission` before_action
- [x] Additional `require_read_inspections_permission` before_action on the new controller
- [x] `ReportSetting` always read/written via `current_user` scope
- [x] Structure drill-down uses `Structure.accessible_to(current_user).find(id)` — prevents cross-tenant access
- [x] LineItem looked up via `current_account.line_items.find(id)` — scoped to account
- [x] Sort column/direction sanitized via whitelist methods
- [x] Private inspections handled by existing `accessible_to` scope
- [x] No new API authentication surfaces (web-only)

### Performance
- [x] Primary query aggregates over `inspection_items` (204M rows) — mitigated by date range selectivity (45-day window eliminates >90% of rows)
- [x] No new indexes on Tier 0 table in V1 — monitor post-launch
- [x] Pagination: 25 per page (entry), 10 per page (drill-down sub-tables)
- [x] Batch prior-period rate computation in single query per page
- [x] Area concentration: N queries per visible area (typically 5-20) — acceptable for V1
- [x] CSV export: `find_each(batch_size: 1000)` for memory efficiency
- [x] Large report guard: CSV >10K rows triggers confirmation flow
- [ ] Caching needed? No — real-time data, short query times expected with date range selectivity
- [x] N+1 risks: Area concentration intentionally issues per-area queries (acceptable); CSV uses `.includes()` for eager loading

### Observability & Debuggability
- [x] Logging: Standard Rails request logging covers controller actions. No custom logging needed for V1.
- [x] Logs are human-readable (Rails default format)
- [x] Debug path: Developers can reproduce via Rails console with `Analytics::DeficientLineItems.new(user, params)` — no production access needed
- [x] Metrics: Track report page loads and export events via existing analytics (if applicable)
- [ ] Alerts needed? No — no background processes beyond existing `ReportExportProcessor` (which already has error handling)

### Testing Plan

| Type | Coverage | Platform | Owner |
|------|----------|----------|-------|
| Model specs | `ReportSetting` — validations, defaults, `for()` method, accessor methods | Rails | Pipeline |
| Service specs | `Analytics::DeficientLineItems` — all public methods, scoping, thresholds, trend calculation, prior period, edge cases | Rails | Pipeline |
| Controller specs | `DeficientLineItemsController` — index (pagination, sorting, auth), show (drill-down, redirects, edge cases) | Rails | Pipeline |
| Controller specs | `DeficientLineItemSettingsController` — update, persistence, validation | Rails | Pipeline |
| Service specs | `DeficientLineItemReportPdf` — section selection, branding, data accuracy | Rails | Pipeline |
| Service specs | `DeficientLineItemReportCsv` — columns, scoping, batching, large report | Rails | Pipeline |
| System/E2E specs | N/A for V1 — manual QA covers integration | Rails | N/A |
| Manual QA | Entry view rendering, drill-down navigation, threshold persistence, filter behavior, export download, empty states, permission denial, browser back button | Web | Human |

### Feature Flags & Rollout
- [ ] Feature flag: Account-level flag TBD (e.g., `deficient_line_items_report_enabled`), or gate via menu visibility only
- [ ] Default: Visible to all accounts with `read_reports` permission (no flag for V1 — net new report, no existing behavior changes)
- [ ] If flag desired: off by default, enable for beta accounts, then GA
- [ ] Rollout plan: Deploy → internal testing → beta customers → GA

### Mobile-Specific
- N/A — Level 2 (web-only) project. No iOS or Android implementation.

### Legacy & Migration
- [x] No existing features modified — this is a net new report
- [x] Existing Overall Report behavior unchanged (lowest/highest line items remain)
- [x] Existing `DeficientLineItemPdf` exporter unchanged
- [x] No data migration needed — `report_settings` table starts empty, defaults on first access
- [x] Backwards compatibility: Not applicable (no mobile, no API, no existing behavior changed)

### Export/Reporting
- [x] Two new export formats: `DeficientLineItemReportPdf` and `DeficientLineItemReportCsv`
- [x] Existing exports unchanged — new exporters are additive to `FACTORY_ADAPTERS`
- [x] PDF: Prawn-based, branded, section-selectable, chart embedded via `GraphImageHelper`
- [x] CSV: Raw inspection-item grain, 9 columns, batched generation, large report guard
- [x] Export backwards compatibility: N/A — both are net new

---

## 5. Dependencies & Risks

### Milestone Dependencies

```
M0 (done)
  └── M1: Data Model & Core Analytics
        ├── M2: Entry View
        │     ├── M3: Configurable Thresholds (also depends on M1)
        │     ├── M4: Filters
        │     └── M7: Export (also depends on M5)
        └── M5: Drill-Down — Navigation, Summary, Areas (also depends on M2, M4)
              └── M6: Drill-Down — Chart, Forms, Mixed
                    └── M7: Export (PDF needs chart rendering)
M8: Polish (depends on M2–M7)
```

### Risks

| Risk | Impact | Mitigation |
|------|--------|------------|
| Query performance on 204M-row `inspection_items` table | High | Date range selectivity eliminates >90% of rows. Paginate at 25 per page. Monitor query times post-launch. Partial index ready to add if needed (see architecture). |
| Trend calculation doubles query load (current + prior period) | Med | `prior_period_rates_for` batches all prior rates in single query. Prior period scoped items cached via instance variable. |
| Filter panel complexity (hierarchical area tree with search + cascading checkboxes) | Med | Use Stimulus for client-side tree management. Area tree loaded on initial render, search is client-side filter. Limit depth to what `supervisory_structures` provides. |
| Chart.js stacked bar chart rendering | Low | Chart.js v2.9.4 already in asset pipeline. Stacked bar is a standard chart type. Pattern established by existing dashboard charts. |
| PDF chart rendering (server-side) | Low | `GraphImageHelper` + Gruff already used by `OverallAveragePerformancePdf`. Same pattern applies — stacked bar via `Gruff::StackedBar`. |
| `report_settings` table migration | Low | New table, small. No Tier 0 table changes. Standard DDL migration. |

---

## 6. Release Plan

### Phases

| Phase | What Ships | Audience | Done Criteria |
|-------|-----------|----------|---------------|
| Phase 1 | M1–M4: Entry view with summary, table, thresholds, filters | Internal QA | Entry view renders correctly, thresholds persist, filters work, pagination works |
| Phase 2 | M5–M6: Drill-down with all navigation levels, chart, mixed areas | Internal QA | Full drill-down flow works end-to-end, breadcrumbs work, browser back works |
| Phase 3 | M7: Export (PDF + CSV) | Internal QA | Both exports generate correctly, section selection works, large report guard works |
| Phase 4 | M8: Polish + full QA | Beta customers → GA | All empty states, edge cases handled. Manual QA sign-off. |

### Done Criteria (GA Release)
- [ ] All acceptance criteria met across M1–M8
- [ ] All automated tests passing
- [ ] Manual QA complete (entry view, drill-down, thresholds, filters, exports, empty states, permissions)
- [ ] Performance acceptable on representative data (largest accounts)
- [ ] Report accessible from Reports menu for all users with `read_reports` + `read_inspections`
- [ ] No regressions to existing reports

---

## 7. Estimates

| Milestone | Rails | iOS | Android | Notes |
|-----------|-------|-----|---------|-------|
| M0: Discovery & Alignment | Done | N/A | N/A | Pipeline Stages 1-2 |
| M1: Data Model & Core Analytics | 2 days | N/A | N/A | Migration + model + full analytics service + tests |
| M2: Entry View | 2 days | N/A | N/A | Controller + 7 view files + tests |
| M3: Configurable Thresholds | 1 day | N/A | N/A | Settings controller + modal + banner + tests |
| M4: Filters | 2 days | N/A | N/A | Stimulus filter panel + area tree + integration |
| M5: Drill-Down — Core | 2 days | N/A | N/A | Show action + breadcrumbs + area concentration + tests |
| M6: Drill-Down — Chart & Mixed | 2 days | N/A | N/A | Chart.js integration + form comparison + mixed layout |
| M7: Export | 2 days | N/A | N/A | PDF (Prawn + sections) + CSV (batched) + modal + tests |
| M8: Polish & Edge Cases | 1 day | N/A | N/A | Empty states, redirects, print styles |
| **Total** | **14 days** | **N/A** | **N/A** | |

---

## PRD Requirement Traceability

> Every PRD requirement ID mapped to its milestone.

| Requirement IDs | Milestone |
|----------------|-----------|
| ENT-001 through ENT-005 | M2 (Summary Cards) |
| ENT-010 through ENT-026 | M2 (Line Item Table) |
| CFG-001 through CFG-011 | M3 (Thresholds) |
| FLT-001 through FLT-016 | M4 (Filters) |
| DDV-001 through DDV-005 | M5 (Navigation) |
| DDV-010 through DDV-013 | M5 (Drill-Down Summary) |
| DDV-020 through DDV-024 | M6 (Trend Chart) |
| DDV-030 through DDV-039 | M5 (Area Concentration) |
| DDV-040 through DDV-048 | M6 (Form Comparison) |
| DDV-050 through DDV-059 | M6 (Mixed Areas) |
| TRD-001 through TRD-007 | M1 (Analytics), M2 (Entry Display) |
| UI-001, UI-002 | M2 (Risk Bar) |
| UI-010 through UI-013 | M8 (Empty States) |
| PDF-001 through PDF-010 | M7 (PDF Export) |
| CSV-001 through CSV-009 | M7 (CSV Export) |
| WEB-001 | M2 (Entry View) |
| WEB-002 | M5 (Drill-Down View) |
| WEB-003 | M3 (Edit Defaults Modal) |
| WEB-004 | M4 (Filter Panel) |
| WEB-005 | M7 (Export Modal) |
| WEB-010 | N/A (not required) |
| IOS-001, AND-001, PAR-001 | N/A (web-only) |

---

## Approval Checklist

> **This gameplan requires human review and approval before test generation begins.**

### Reviewer: Dave
### Date: 2/5/2026
### Status: Accepted

#### Must Verify
- [ ] Milestone breakdown is logical and correctly sequenced
- [ ] Acceptance criteria are specific and testable
- [ ] Every PRD requirement ID is mapped to a milestone (traceability matrix complete)
- [ ] Non-functional requirements checklist is fully addressed
- [ ] Dependencies form a valid DAG (no circular dependencies)
- [ ] Estimates are realistic
- [ ] Release plan is appropriate

#### Optional Notes
[Any modifications, corrections, or additional context for the implementation team]

---

## Changelog

| Date | Author | Changes |
|------|--------|---------|
| February 5, 2026 | Pipeline | Initial gameplan generated |
