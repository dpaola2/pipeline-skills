# QA Plan — Increase Inspection Schedule Limit

> **Generated by:** Pipeline Stage 7 (QA Plan)
> **Date:** February 6, 2026
> **Branch:** `pipeline/inspection-schedule-limit`
> **PR:** TBD
> **Gameplan:** `projects/inspection-schedule-limit/gameplan.md`
> **Progress:** `projects/inspection-schedule-limit/progress.md`
> **Linear:** [ENG-362](https://linear.app/orangeqc/issue/ENG-362/increase-number-of-total-inspection-schedules-beyond-600)

---

## 1. Feature Summary

Raised the per-account inspection schedule limit from 600 to 1,000 and added a model-level validation (`on: :create`) to enforce the limit server-side. Previously, the 600 limit was UI-only (a controller flag hiding the "New Schedule" button); a direct POST could bypass it. The new validation closes that security gap. The limit is now defined as a single named constant `InspectionSchedule::MAX_ACTIVE_SCHEDULES_PER_ACCOUNT`.

### Milestones Implemented

| Milestone | Description | Commit |
|-----------|-------------|--------|
| M1 | Limit Constant, Model Validation & UI Update | `ef50766` |
| M2 | QA Test Data (seed rake task) | `469d870` |

---

## 2. Automated Test Coverage

| Metric | Value |
|--------|-------|
| **Total tests** | 24 (7 new + 17 existing) |
| **Passing** | 24 |
| **Failing** | 0 |
| **Test files** | 4 (2 new + 2 existing) |

### Test Types

| Type | File | Count | Covers |
|------|------|-------|--------|
| Model specs | `spec/models/inspection_schedule_limit_spec.rb` | 5 | Constant value, validation at limit, below limit, update at limit, deleted schedules |
| Request specs | `spec/requests/inspection_schedules_limit_spec.rb` | 2 | Warning banner display, "New Schedule" button hidden |
| Model specs (existing) | `spec/models/inspection_schedule_spec.rb` | 15 | Existing validations, scopes, IceCube, assignee, incinerate |
| Request specs (existing) | `spec/requests/inspection_schedules_spec.rb` | 2 | Existing index and edit page loads |

### What Automated Tests Verify
- Constant `MAX_ACTIVE_SCHEDULES_PER_ACCOUNT` is defined and equals 1,000
- Validation prevents schedule creation when account has >= 1,000 active schedules
- Validation allows creation when account is below the limit
- Validation allows updates to existing schedules even at the limit (`on: :create` only)
- Deleted (soft-deleted) schedules do not count toward the limit
- Warning banner with "1,000" appears in the index page response when at limit
- "New Schedule" button is hidden when at limit
- All existing behavior (assignee validation, accessible_to, IceCube serialization, edit page) unchanged

---

## 3. Test Data Setup

### Rake Task

```bash
cd ~/projects/orangeqc/orangeqc
bundle exec rake pipeline:seed_inspection_schedule_limit
```

**Prerequisites:** The `elm` dev account must exist (`rake db:seed` first). The task is idempotent — re-running after initial seed will detect existing data and print the summary without duplicating.

### Scenarios Seeded

| Scenario | Account / User | Data Created | Purpose |
|----------|---------------|--------------|---------|
| At limit (1,000) | `elm` / existing admin (existing password) | 1,000 active inspection schedules, 1 site, 1 form | Test warning banner, hidden button, validation error |
| Below limit (999) | `schedlimit` / `qa_schedlimit` (password123) | 999 active inspection schedules, 1 site, 1 form | Test "one more" creation, then hitting the limit |

### Post-Seed Verification
- [ ] Navigate to `http://elm.lvh.me:3000/inspection_schedules` and verify the warning banner is visible
- [ ] Navigate to `http://schedlimit.lvh.me:3000/inspection_schedules` and verify no warning banner is shown
- [ ] Confirm the "New Schedule" button is hidden on the elm account
- [ ] Confirm the "New Schedule" button is visible on the schedlimit account

---

## 4. Manual Testing Checklist

> Organized by feature area. Each item has steps, expected result, and the acceptance criteria it verifies.

### 4.1 Warning Banner & Button Visibility

#### QA-001: Warning banner appears at the limit
**Criteria:** VAL-002, View
**Account:** elm (1,000 schedules)
**Steps:**
1. Log in to `http://elm.lvh.me:3000` as the admin user
2. Navigate to Setup > Inspection Schedules (`/inspection_schedules`)
3. Observe the page header area

**Expected:** A red alert banner reads: "**Maximum Number of Schedules!** Your account currently has the maximum number of 1,000 inspection schedules. Please delete unused schedules or condense your setup."

---

#### QA-002: "New Schedule" button is hidden at the limit
**Criteria:** View
**Account:** elm (1,000 schedules)
**Steps:**
1. On the inspection schedules index page (from QA-001)
2. Look for the "New Schedule" dropdown button in the top-right of the panel header

**Expected:** The "New Schedule" button is NOT visible. There is no way to initiate schedule creation from this page.

---

#### QA-003: No warning banner below the limit
**Criteria:** (baseline behavior)
**Account:** schedlimit (999 schedules)
**Steps:**
1. Log in to `http://schedlimit.lvh.me:3000` as `qa_schedlimit` / `password123`
2. Navigate to `/inspection_schedules`

**Expected:** No warning banner is shown. The "New Schedule" dropdown button is visible in the top-right.

---

### 4.2 Schedule Creation

#### QA-004: Create a schedule at 999 (succeeds, reaching 1,000)
**Criteria:** LIM-001, VAL-003
**Account:** schedlimit (999 schedules)
**Steps:**
1. On the schedlimit account, click "New Schedule" > "Monthly Inspection"
2. Fill in a name (e.g., "Test Limit Schedule")
3. Select at least one area and one inspection form
4. Set day of month (e.g., 1st and 15th)
5. Click Save

**Expected:** Schedule is created successfully. You are redirected to the schedule detail page. Flash message: "Successfully created an inspection schedule."

---

#### QA-005: Warning banner appears after reaching 1,000
**Criteria:** VAL-002, View
**Account:** schedlimit (now 1,000 schedules after QA-004)
**Steps:**
1. After QA-004, navigate back to `/inspection_schedules`

**Expected:** The red warning banner now appears with "Maximum Number of Schedules!" message. The "New Schedule" button is now hidden.

---

#### QA-006: Attempt to create at 1,000 (blocked by validation)
**Criteria:** VAL-001, VAL-003
**Account:** elm (1,000 schedules)
**Steps:**
1. On the elm account, navigate directly to `/inspection_schedules/new?period=monthly` (bypassing the hidden button)
2. Fill in a valid schedule name, select an area and form, set day of month
3. Click Save

**Expected:** Schedule is NOT created. The form re-renders with an error. The validation message reads: "This account has reached the maximum of 1,000 inspection schedules. Please delete unused schedules to add new ones."

---

### 4.3 Schedule Editing

#### QA-007: Edit an existing schedule at the limit (succeeds)
**Criteria:** VAL-003 (edit case)
**Account:** elm (1,000 schedules)
**Steps:**
1. On the elm account, navigate to `/inspection_schedules`
2. Click on any existing schedule to view its details
3. Click "Edit" (if the admin has access to the schedule's locations)
4. Change the schedule name (e.g., append " — edited")
5. Click Save

**Expected:** Schedule is updated successfully. Flash message: "Updated inspection schedule." The validation does NOT block edits — it only fires on `:create`.

---

### 4.4 Deleting Schedules

#### QA-008: Delete a schedule at the limit, then create again
**Criteria:** LIM-003
**Account:** elm (1,000 schedules)
**Steps:**
1. On the elm account, navigate to `/inspection_schedules`
2. Click on a schedule, then archive/delete it (via the schedule detail page)
3. Navigate back to `/inspection_schedules`
4. Observe the page state

**Expected:** After deletion, the active count drops to 999. The warning banner disappears and the "New Schedule" button reappears. Creating a new schedule should now succeed.

---

### 4.5 Pagination & Performance

#### QA-009: Index page loads with 1,000 schedules
**Criteria:** (performance)
**Account:** elm (1,000 schedules)
**Steps:**
1. Navigate to `/inspection_schedules` on the elm account
2. Observe page load time
3. Scroll through the paginated list
4. Click "Next" to navigate through pages (20 per page)

**Expected:** Page loads in a reasonable time (< 3 seconds). Pagination works correctly. All 1,000 schedules are accessible across pages. No errors or blank pages.

---

### 4.6 Filter Interaction

#### QA-010: Filters work with 1,000 schedules
**Criteria:** (regression)
**Account:** elm (1,000 schedules)
**Steps:**
1. On the index page, use the "Inspection Schedules for" location filter
2. Select a specific area
3. Observe the filtered results

**Expected:** Only schedules assigned to the selected area are shown. Warning banner remains visible (still at limit for the account, even if filtered view shows fewer). Pagination updates correctly.

---

## 5. Edge Cases & Boundary Conditions

| # | Scenario | How to Test | Expected Result | Criteria |
|---|----------|-------------|-----------------|----------|
| 1 | Account with exactly 999 schedules creates one more | QA-004 on schedlimit account | Schedule #1,000 created successfully | LIM-001 |
| 2 | Account with exactly 1,000 tries to create | QA-006 on elm account (direct URL) | Validation error, schedule not created | VAL-001, VAL-003 |
| 3 | Soft-deleted schedule doesn't count toward limit | QA-008 — delete one, verify creation is unblocked | Warning disappears, new schedule button returns | LIM-003 |
| 4 | Editing at limit doesn't trigger validation | QA-007 on elm account | Edit succeeds with no validation error | VAL-003 (edit) |
| 5 | Pausing/unpausing a schedule at the limit | On elm account, pause then unpause any schedule | Both actions succeed — validation is `on: :create` only | VAL-003 |
| 6 | Accounts under old 600 limit | Any dev account with < 600 schedules | Completely unaffected — no banner, no button hidden, creation works normally | Backwards compat |

---

## 6. Known Limitations

Items explicitly deferred or not implemented in this version:

| Item | Status | Notes |
|------|--------|-------|
| Dynamic per-account limits | Out of scope | Global constant only. If another customer needs a different limit, change the constant (one-line code change + deploy). |
| UI indicator "X of 1,000 used" | Out of scope | No schedule count shown to users. Only the at-limit warning banner. |
| Notification at 900 (approaching limit) | Out of scope | No proactive warning. Users see the banner only when the limit is hit. |
| Job performance instrumentation | Already satisfied | Existing rake task logging + Sentry check-ins cover OBS-001/OBS-002. No new logging added. |
| View hardcodes "1,000" in text | Spec gap (minor) | The warning banner text says "1,000" as a static string rather than dynamically referencing the constant. If the constant changes, the view text must be updated manually. The constant is the enforcement source of truth. |

---

## 7. Regression Concerns

Areas where existing functionality could be affected by this change:

| Area | Risk | What to Check |
|------|------|---------------|
| Inspection schedule index page | Low | Page still loads correctly, filters work, pagination works. The eager loading change (`.includes(:structures).preload(:assignee)`) could affect query behavior. Verify QA-009 and QA-010. |
| Schedule creation flow | Low | The new model validation fires on `:create`. Verify that creating schedules below the limit works normally (no unexpected validation errors). |
| Schedule editing/pausing/unpausing | Low | The validation is `on: :create` only. Verify QA-007 and edge case #5 (pause/unpause). |
| Schedule builder (`Builders::InspectionScheduleBuilder`) | Low | The builder calls `save` on the model, which triggers the validation. If `build` returns `false`, the controller re-renders the form. Verify the error message appears correctly (QA-006). |
| Scheduling batch job | None | No changes to the rake task, builder, or event processor. The limit only affects creation, not the daily batch job. |

---

## 8. Rollback Plan

| Step | Action | Notes |
|------|--------|-------|
| Feature flag | No feature flag | Uses existing `scheduled_inspections_enabled` account flag. Rollback requires code revert. |
| Migration | No migration | No database changes. Rollback is purely a code revert. |
| Code revert | Revert the 3 modified files to restore `>= 600` in controller and remove the constant/validation | `git revert ef50766` on the staging branch after merge |
| Data cleanup | None needed | No new tables, columns, or data structures. Accounts that created schedules between 600 and 1,000 would keep those schedules (the old 600 limit was UI-only anyway). |

---

## QA Sign-Off

### Tester: ___________
### Date: ___________
### Status: Pending

- [ ] All manual test scenarios verified (QA-001 through QA-010)
- [ ] Edge cases tested (1 through 6)
- [ ] Regression areas checked
- [ ] No blocking issues found

#### Issues Found
| # | Severity | Description | Status |
|---|----------|-------------|--------|
| | | | |

#### Notes
[Any observations, feedback, or suggestions from QA]
