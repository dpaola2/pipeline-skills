# Increase Inspection Schedule Limit - Architecture Proposal

> **Generated by:** Pipeline Stage 2 (Architecture)
> **Date:** February 6, 2026
> **PRD:** `projects/inspection-schedule-limit/prd.md`
> **Discovery Report:** `projects/inspection-schedule-limit/discovery-report.md`
> **Linear:** [ENG-362](https://linear.app/orangeqc/issue/ENG-362/increase-number-of-total-inspection-schedules-beyond-600)

---

## 1. Data Model Changes

### New Tables

None.

### Modified Tables

None. No schema changes are required. The limit is enforced in application code only.

### Rails Models

**Modified: `app/models/inspection_schedule.rb`**

Add a named constant and a model validation:

```ruby
class InspectionSchedule < ApplicationRecord
  MAX_ACTIVE_SCHEDULES_PER_ACCOUNT = 1_000

  # ... existing code ...

  validate :account_schedule_limit_not_exceeded, on: :create

  private

  def account_schedule_limit_not_exceeded
    return unless account

    if account.inspection_schedules.active.count >= MAX_ACTIVE_SCHEDULES_PER_ACCOUNT
      errors.add(:base, "This account has reached the maximum of #{MAX_ACTIVE_SCHEDULES_PER_ACCOUNT} inspection schedules. Please delete unused schedules to add new ones.")
    end
  end
end
```

Design rationale:
- **`on: :create` only** — the validation should not fire on updates to existing schedules. An account at the limit should still be able to edit/pause/unpause schedules.
- **Constant on the model** — single source of truth for both the validation and the controller/view. No magic numbers.
- **`errors.add(:base, ...)`** — this is not a field-level error; it's an account-level constraint. Using `:base` follows the Rails convention for non-attribute errors.

### Associations Map

No changes. Existing associations are unchanged:

```
Account 1──* InspectionSchedule 1──* InspectionScheduleForm ──1 InspectionForm
                    │
                    └──* InspectionSchedulesStructure ──1 Structure
                    │
                    └──* InspectionEvent
```

### Migration Plan

No migrations required.

### Expected Data Volumes

No change in data model, so no new volume projections. For reference, from the discovery report:

| Table | Current Records | Notes |
|-------|----------------|-------|
| inspection_schedules | ~12,746 | Tier 2, 9 MB total |
| inspection_schedule_forms | ~15,006 | 2.4 MB |
| inspection_schedules_structures | ~38,901 | 6 MB |

PCSI ORG 2 adding ~150 schedules is negligible at the table level.

---

## 2. API Endpoints

### New Endpoints

None. Schedule creation is web-only (no API endpoint for creating schedules).

### Modified Endpoints

None. The existing API only exposes `GET /api/v4/inspection_schedules/preview` (a collection-level preview route), which is unaffected.

### Serializers / Blueprints

No changes.

---

## 3. Backwards Compatibility

### Compatibility Matrix

| Feature / Behavior | Web (current) |  iOS | Android | API consumers |
|-------------------|:---:|:---:|:---:|:---:|
| Schedule creation limit raised to 1,000 | Full | N/A (no iOS schedule creation) | N/A (no Android schedule creation) | N/A (no API create endpoint) |
| Validation error on limit exceeded | Full | N/A | N/A | N/A |
| Existing schedules above 600 continue working | Full | N/A | N/A | N/A |

### Old Client Behavior

**iOS / Android:** No impact. Mobile apps do not create inspection schedules. The scheduling feature is web-only. Mobile apps consume `inspection_events` (the generated events from schedules), which are unchanged.

### API Versioning

Not applicable. No API changes.

### Data Migration

No data migration needed. Accounts currently below 600 are unaffected. Accounts at 600 (like PCSI ORG 2) can immediately create more schedules up to 1,000 once the code is deployed.

---

## 4. Security Design

### Query Scoping

No new data access paths. Existing scoping is unchanged:

| Resource | Scoping Chain |
|----------|--------------|
| InspectionSchedule (index) | `current_account.inspection_schedules.accessible_to(current_user).active` |
| InspectionSchedule (create) | `current_account.inspection_schedules.new(...)` — scoped by `belongs_to :account` |
| Limit check (model validation) | `account.inspection_schedules.active.count` — scoped to the schedule's own account |

### Authorization

No changes. Existing `before_action :require_inspection_schedule_permissions` on the controller is unchanged.

### New Attack Surface

| Vector | Risk | Mitigation |
|--------|------|------------|
| User bypasses UI limit gate via direct POST | **Closed** (was previously open) | The new model validation prevents schedule creation beyond 1,000, regardless of how the request is made. This is an improvement over the current UI-only gate. |

---

## 5. Export Impact

| Export | Format | Changes | Backwards Compatible? |
|-------|--------|---------|----------------------|
| N/A | — | No exports are affected | — |

Inspection schedules have no associated exports. The schedule index page has no export functionality.

---

## 6. Open Questions for Human Review

| # | Question | Options | Recommendation |
|---|----------|---------|---------------|
| 1 | Should the limit be configurable per-account (e.g., a column on the `accounts` table), or a single global constant? | **A:** Global constant on the model (simpler, matches current approach) / **B:** Per-account column on `accounts` table (flexible, requires migration + admin UI) | **A: Global constant.** The PRD explicitly says "don't invest heavily in the old architecture." A per-account column adds a migration, admin UI, and ongoing maintenance for a feature being rearchitected. If a third customer hits the limit, raising the constant is a one-line change. **Decision: A — Global constant. Approved.** |
| 2 | Should OBS-001/OBS-002 (job duration logging) be considered satisfied by the existing rake task logging and Sentry check-ins? | **A:** Already satisfied — the rake task logs total duration and has Sentry check-ins / **B:** Add per-schedule timing instrumentation within `build_all` | **A: Already satisfied.** The rake task already logs `"Completed at #{completed_time} with total time #{completed_time - now} seconds"` and uses `Sentry.capture_check_in`. The Sentry check-in will alert if the job fails or times out. Per-schedule timing adds complexity for a feature being rearchitected. **Decision: A — Already satisfied. No additional logging needed. Approved.** |

---

## 7. Alternatives Considered

### Alternative: Per-Account Configurable Limit

**Description:** Add an `inspection_schedule_limit` column to the `accounts` table, defaulting to 1,000. Allow OrangeQC admins to raise/lower the limit per account.

**Pros:**
- Maximum flexibility — support can raise the limit for specific accounts without a code deploy
- Future-proof if more accounts hit the limit with different needs

**Cons:**
- Requires a database migration on the `accounts` table
- Requires admin UI to manage the per-account limit
- Adds ongoing maintenance for a feature being rearchitected in 2026
- Over-engineers a stopgap change

**Why rejected:** The PRD explicitly says "don't invest heavily in the old architecture." The global constant approach is a one-line change to raise again if needed.

### Alternative: Remove the Limit Entirely

**Description:** Remove the 600 limit without adding a new one. Let accounts create unlimited schedules.

**Pros:**
- Simplest change — just remove the UI gate
- No future limit-related support tickets

**Cons:**
- The limit exists for a reason — the daily batch job scales linearly with schedule count
- An account with thousands of schedules could meaningfully impact batch job runtime
- No safety net before the rearchitecture

**Why rejected:** The risk of uncapped schedules impacting batch job performance is real. A 1,000-schedule ceiling provides headroom for PCSI ORG 2 while maintaining a safety boundary.

---

## 8. Summary

### Files to Create

None.

### Files to Modify

| File | Changes |
|------|---------|
| `app/models/inspection_schedule.rb` | Add `MAX_ACTIVE_SCHEDULES_PER_ACCOUNT = 1_000` constant. Add `validate :account_schedule_limit_not_exceeded, on: :create` with error message. |
| `app/controllers/inspection_schedules_controller.rb` | Change `>= 600` to reference `InspectionSchedule::MAX_ACTIVE_SCHEDULES_PER_ACCOUNT`. |
| `app/views/inspection_schedules/index.html.erb` | Update "600" in the error message text to reference the constant value (or use the constant via the controller). |

### Scope Assessment

This is a **3-file change** with no migrations, no API changes, and no new tables. The primary design decision is strengthening the limit from a UI-only gate to a model validation — a security and robustness improvement over the current behavior.

---

## Approval Checklist

> **This architecture proposal requires human review and approval before the gameplan is generated.**

### Reviewer: Dave
### Date: February 6, 2026
### Status: Approved

#### Must Verify
- [x] Data model is architecturally sound (constant + model validation approach)
- [x] API design is consistent with existing patterns (no API changes — confirmed)
- [x] Backwards compatibility is handled correctly (no impact on mobile or API consumers)
- [x] Security scoping is correct (model validation scoped to schedule's own account)
- [x] Migration strategy is safe (no migrations needed)

#### Should Check
- [x] The `on: :create` validation constraint is correct (updates to existing schedules at-limit should still work)
- [x] OBS-001/OBS-002 requirements are satisfied by existing rake task logging + Sentry check-ins
- [x] Global constant vs per-account column decision aligns with product direction
- [x] No conflicts with in-progress work or upcoming scheduling rearchitecture

#### Notes
Both open questions resolved as recommended: global constant (not per-account column), OBS requirements already satisfied by existing logging. No modifications needed.
