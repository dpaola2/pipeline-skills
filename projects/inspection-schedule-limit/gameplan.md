# Increase Inspection Schedule Limit - Engineering Gameplan

> **Generated by:** Pipeline Stage 3 (Gameplan)
> **Date:** February 6, 2026
> **PRD:** `projects/inspection-schedule-limit/prd.md`
> **Discovery Report:** `projects/inspection-schedule-limit/discovery-report.md`
> **Approved Architecture:** `projects/inspection-schedule-limit/architecture-proposal.md`
> **Linear:** [ENG-362](https://linear.app/orangeqc/issue/ENG-362/increase-number-of-total-inspection-schedules-beyond-600)

---

## 1. Project Overview

### Goals
- PCSI ORG 2 can create inspection schedules beyond 600, up to 1,000
- The limit is enforced by a model validation (not just a UI gate), preventing bypass via direct POST
- The limit lives in a single named constant, eliminating magic numbers

### Scope Summary

| Item | Description | Platform |
|------|-------------|----------|
| ENG-362 | Raise per-account inspection schedule limit from 600 to 1,000 | Web |

### Out of Scope
- Rearchitecting the scheduling job for better performance at scale
- Dynamic per-account limits (configurable by support or admin UI)
- Sharding or parallelizing the scheduling job
- UI indicator showing "X of 1,000 schedules used"
- Notification when approaching the limit
- Additional job duration logging (existing Sentry check-ins + rake task logging deemed sufficient)

### Constraints & Conventions
- AGENTS.md: `~/projects/orangeqc/orangeqc/AGENTS.md`
- No database migrations required
- No API changes required
- Follows existing `Archivable` concern pattern (`.active` = `where(deleted_at: nil)`)

---

## 2. Open Questions & Decisions

> All resolved during Stages 1-2 (Discovery + Architecture)

| Question | Status | Decision |
|----------|--------|----------|
| Where is the 600 limit enforced? | Resolved | Two places: controller line 12 (`>= 600`) and view line 59 (text "600"). No model validation exists. |
| Should limit be per-account column or global constant? | Resolved | Global constant on the model (`MAX_ACTIVE_SCHEDULES_PER_ACCOUNT = 1_000`). Simpler, matches "don't invest in old architecture" direction. |
| Should OBS-001/OBS-002 (job logging) be added? | Resolved | Already satisfied by existing rake task duration logging + Sentry check-ins. No additional instrumentation needed. |
| Should the limit be a model validation or remain UI-only? | Resolved | Model validation (`on: :create`). Closes the bypass-via-direct-POST security gap. |

---

## 3. Functional Milestones

### M0: Discovery & Alignment (Complete)
- [x] PRD parsed and understood (Stage 1)
- [x] Current state documented — limit is in 2 files, UI-only enforcement (Stage 1)
- [x] Architecture proposed and **approved** — constant + model validation (Stage 2)
- [x] Open questions resolved (Stages 1-2)

---

### M1: Limit Constant, Model Validation & UI Update
**What:** Extract the magic number 600 into a named constant on the model, raise it to 1,000, add a model validation that prevents creating schedules beyond the limit, and update the controller and view to reference the constant.

**Acceptance Criteria:**
- [ ] LIM-001: `InspectionSchedule::MAX_ACTIVE_SCHEDULES_PER_ACCOUNT` is set to `1_000`
- [ ] LIM-002: The constant is defined in `app/models/inspection_schedule.rb` and is the single source of truth — no other file contains the raw number as a magic number
- [ ] LIM-003: The limit counts only active (non-deleted) schedules via the `.active` scope (`where(deleted_at: nil)`)
- [ ] VAL-001: When a user attempts to create a schedule that would exceed 1,000, the model validation adds an error to `:base` with the message: "This account has reached the maximum of 1,000 inspection schedules. Please delete unused schedules to add new ones."
- [ ] VAL-002: The validation error is surfaced in the web UI on the schedule creation form (existing flash error pattern)
- [ ] VAL-003: The `validate :account_schedule_limit_not_exceeded, on: :create` prevents saving — the schedule is not created
- [ ] VAL-003 (edit case): Editing an existing schedule at an account with 1,000 schedules succeeds (validation is `on: :create` only)
- [ ] Controller: `inspection_schedules_controller.rb` line 12 references `InspectionSchedule::MAX_ACTIVE_SCHEDULES_PER_ACCOUNT` instead of `600`
- [ ] View: `index.html.erb` displays the correct limit value (1,000) in the warning banner text
- [ ] View: The "New Schedule" button is hidden when active schedule count >= 1,000
- [ ] Tests: Model spec covers the validation — creation blocked at limit, creation allowed below limit, update allowed at limit
- [ ] Tests: Request spec covers the controller `@at_limit` behavior at 1,000

**Web/API:**
- [ ] Model: Add `MAX_ACTIVE_SCHEDULES_PER_ACCOUNT = 1_000` constant to `app/models/inspection_schedule.rb`
- [ ] Model: Add `validate :account_schedule_limit_not_exceeded, on: :create` private method
- [ ] Controller: Update `app/controllers/inspection_schedules_controller.rb` line 12 to use the constant
- [ ] View: Update `app/views/inspection_schedules/index.html.erb` lines 39 and 56-61 to use the constant value
- [ ] Tests: Add model spec examples in `spec/models/inspection_schedule_spec.rb`
- [ ] Tests: Add or update request spec in `spec/requests/inspection_schedules_spec.rb`

**iOS:** N/A — Level 2 (web-only) project
**Android:** N/A — Level 2 (web-only) project

**Dependencies:** None (first implementation milestone)

---

### M2: QA Test Data
**What:** Create a rake task that seeds an account with inspection schedules near the 1,000 limit, enabling manual QA of the limit enforcement, warning banner, and validation behavior.

**Acceptance Criteria:**
- [ ] Rake task `pipeline:seed_inspection_schedule_limit` exists in `lib/tasks/pipeline/`
- [ ] Task creates (or reuses) a test account with `scheduled_inspections_enabled: true` and sufficient `inspector_limit`
- [ ] Task seeds the account with schedules to reach exactly the limit (1,000 active schedules)
- [ ] Task also seeds a second account with schedules just below the limit (999) for testing the "one more" scenario
- [ ] Task is idempotent (can re-run without duplicating data)
- [ ] Task prints a summary: account credentials, schedule counts, URL to test
- [ ] Manual QA can verify: warning banner appears at 1,000, "New Schedule" button hidden, creating via form fails with validation error, editing existing schedule succeeds

**Web/API:**
- [ ] `lib/tasks/pipeline/seed_inspection_schedule_limit.rake` — idempotent rake task
- [ ] Uses ActiveRecord directly (not FactoryBot) with correct model validations
- [ ] Creates minimal supporting objects (account, company, site, user, inspection form)
- [ ] No production-unsafe operations (dev/staging only)

**iOS:** N/A
**Android:** N/A

**Dependencies:** M1 (needs the constant and validation in place)

---

## 4. Non-Functional Requirements Checklist

### Data Model & API
> Reviewed and approved in the Architecture Review checkpoint.

- [x] Architecture proposal approved: `projects/inspection-schedule-limit/architecture-proposal.md`
- [x] Milestones correctly reference the approved data model and API design
- [x] No contradictions between gameplan and approved architecture

### Security & Access Control
- [x] All queries scoped to account — `account.inspection_schedules.active.count` in validation, `current_account.inspection_schedules.active.count` in controller
- [x] Controller authorization in place — existing `before_action :require_inspection_schedule_permissions` unchanged
- [x] Feature permissions respected — `scheduled_inspections_enabled?` gate unchanged
- [x] Area-based access respected — N/A (limit is account-wide, not area-specific)
- [x] API authentication — N/A (no API changes)
- [x] No new attack surfaces — the model validation **closes** the existing UI-bypass vulnerability

### Performance
- [x] Data volume x access frequency: `inspection_schedules.active.count` is a simple COUNT query on a Tier 2 table (~12K rows). Called once per index page load and once per schedule creation. Negligible.
- [x] Query patterns identified: Single COUNT query with `deleted_at IS NULL` condition, leveraging existing `deleted_at` index
- [x] Indexes sufficient — existing index on `deleted_at` covers the `.active` scope
- [x] Caching needed? No
- [x] N+1 query risks: None

### Observability & Debuggability
- [x] Logging plan: No additional logging needed. Existing rake task logs duration + Sentry check-ins cover the batch job.
- [x] Logs are human-readable: Existing format is clear (`[InspectionSchedules] Completed at ... with total time ... seconds`)
- [x] Debug path: Rails console — `Account.find(X).inspection_schedules.active.count`
- [x] Metrics/analytics: No additional metrics needed
- [x] Alerts needed? No — existing Sentry check-in alerts on batch job failure

### Testing Plan

| Type | Coverage | Platform | Owner |
|------|----------|----------|-------|
| Model spec | Validation: blocked at limit, allowed below limit, update allowed at limit | Rails | Pipeline |
| Request spec | Controller `@at_limit` behavior at 1,000, create blocked at limit | Rails | Pipeline |
| Manual QA | Warning banner, button hidden, form submission, edit at limit | Web | Human |

### Feature Flags & Rollout
- [x] Feature flag: None needed. This is a non-breaking change to an existing limit. The feature (`scheduled_inspections_enabled`) already has its own account-level flag.
- [x] Rollout: Single deploy, immediately effective for all accounts.

### Mobile-Specific
- N/A — Level 2 (web-only) project. Mobile apps do not create inspection schedules.

### Legacy & Migration
- [x] Old client experience: No impact. Mobile apps consume `inspection_events`, not the schedule limit.
- [x] Backward compatibility: Fully maintained. Accounts under 600 are unaffected. Accounts at 600 can now create more.
- [x] Data migration: None needed.

### Export/Reporting
- [x] N/A — Inspection schedules have no associated exports.

---

## 5. Dependencies & Risks

| Risk/Dependency | Impact | Mitigation |
|-----------------|--------|------------|
| Daily batch job takes longer with more schedules | Low | Adding ~150 schedules (PCSI ORG 2) adds ~2.5 min to a 3.5+ hour job. Existing Sentry monitoring will detect issues. |
| Per-schedule event generation at accounts with 1,000 schedules | Low | Event creation scales with forms × structures × occurrences per schedule, not number of schedules. No per-schedule change. |
| No existing tests for the limit — risk of introducing regression in adjacent behavior | Low | M1 adds new tests. Existing test suite (model, request, builder, presenter specs) covers adjacent behavior. |

---

## 6. Release Plan

### Phases

| Phase | What Ships | Flag State | Audience |
|-------|-----------|------------|----------|
| Phase 1 (only) | M1 + M2 | No flag (uses existing `scheduled_inspections_enabled`) | All accounts |

Single-phase release. No feature flag needed — the change raises an existing limit and adds a validation. It's immediately effective for all accounts with `scheduled_inspections_enabled: true`.

### Done Criteria
- [ ] All M1 acceptance criteria met
- [ ] All tests passing (model spec + request spec)
- [ ] QA test data seeded and manually verified
- [ ] PCSI ORG 2 confirmed able to create schedules beyond 600

---

## 7. Estimates

| Milestone | Rails | iOS | Android | Notes |
|-----------|-------|-----|---------|-------|
| M0: Discovery & Alignment | Done | N/A | N/A | Pipeline Stages 1-2 |
| M1: Limit Constant, Validation & UI | < 1 day | N/A | N/A | 3 files modified, 2 test files |
| M2: QA Test Data | < 1 day | N/A | N/A | Seed rake task |
| **Total** | **< 1 day** | **N/A** | **N/A** | |

---

## PRD Requirement Traceability

| PRD Requirement | Milestone | Acceptance Criterion |
|----------------|-----------|---------------------|
| LIM-001 | M1 | Constant set to 1,000 |
| LIM-002 | M1 | Single named constant, no magic numbers |
| LIM-003 | M1 | `.active` scope counts non-deleted only |
| VAL-001 | M1 | Validation error message text |
| VAL-002 | M1 | Error surfaced in web UI |
| VAL-003 | M1 | Validation prevents saving (`on: :create`) |
| OBS-001 | N/A | Already satisfied (existing rake task logging) |
| OBS-002 | N/A | Already satisfied (existing Sentry check-ins) |

---

## Approval Checklist

> **This gameplan requires human review and approval before test generation begins.**

### Reviewer: Dave
### Date: February 6, 2026
### Status: Approved

#### Must Verify
- [x] Milestone breakdown is logical and correctly sequenced
- [x] Acceptance criteria are specific and testable
- [x] Every PRD requirement ID is mapped to a milestone (traceability matrix complete)
- [x] Non-functional requirements checklist is fully addressed
- [x] Dependencies form a valid DAG (no circular dependencies)
- [x] Estimates are realistic
- [x] Release plan is appropriate

#### Optional Notes
Approved as-is. Straightforward 2-milestone plan for a small scope change.

---

## Changelog

| Date | Author | Changes |
|------|--------|---------|
| February 6, 2026 | Pipeline | Initial gameplan generated |
