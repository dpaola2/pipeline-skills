# [Feature Name] - Architecture Proposal

> **Generated by:** Pipeline Stage 2 (Architecture)
> **Date:** [Date]
> **PRD:** [Link]
> **Discovery Report:** [Link]
> **Linear:** [Link]

---

## 1. Data Model Changes

### New Tables

```sql
CREATE TABLE [table_name] (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),  -- UUIDv7
  [column_name] [type] [constraints],
  [foreign_key]_id uuid NOT NULL REFERENCES [parent_table](id),
  created_at timestamptz NOT NULL DEFAULT NOW(),
  updated_at timestamptz NOT NULL DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_[table]_[column] ON [table_name] ([column]);
CREATE INDEX idx_[table]_[column] ON [table_name] ([column]);
```

### Modified Tables

```sql
-- Add columns to [existing_table]
ALTER TABLE [existing_table]
  ADD COLUMN [column_name] [type] [constraints];
```

### Rails Models

```ruby
# app/models/[model].rb
class [Model] < ApplicationRecord
  belongs_to :[parent]
  has_many :[children], dependent: :destroy

  validates :[field], presence: true
  # [other validations]

  scope :for_account, ->(account) { where([scoping_logic]) }
end
```

### Associations Map

```
[Parent] 1──* [Child] 1──* [Grandchild]
    │
    └── belongs_to [Account] (scoping)
```

### Migration Plan

| Migration | Type | Notes |
|-----------|------|-------|
| Create [table] | DDL | Standard create_table |
| Add index on [table.column] | DDL | `disable_ddl_transaction!` + concurrent |
| Backfill [column] | Data | [Strategy: batch update, background job, etc.] |

### Expected Data Volumes

| Table | Expected Records | Access Frequency | Growth Rate |
|-------|-----------------|------------------|-------------|
| [table] | [estimate] | [reads/writes per day] | [per month] |

---

## 2. API Endpoints

### New Endpoints

#### [METHOD] /api/v1/[path]

**Purpose:** [What this endpoint does]

**Authorization:** [Who can call this, what permissions needed]

**Scoping:** `current_account.[collection].find(params[:id])`

**Request:**
```json
{
  "[resource]": {
    "[field]": "[value]",
    "[field]": "[value]"
  }
}
```

**Response (2XX):**
```json
{
  "[resource]": {
    "id": "01234567-89ab-cdef-0123-456789abcdef",
    "[field]": "[value]",
    "[field]": "[value]",
    "created_at": "2026-02-05T14:30:00Z",
    "updated_at": "2026-02-05T14:30:00Z"
  }
}
```

**Error Response (422):**
```json
{
  "error": "Unprocessable Entity",
  "message": "[Human-readable error message]"
}
```

**Error Response (401):**
```json
{
  "error": "Unauthorized",
  "message": "[Human-readable error message]"
}
```

---

#### [METHOD] /api/v1/[path]

[Repeat for each endpoint]

---

### Modified Endpoints

| Endpoint | Change | Backwards Compatible? |
|----------|--------|----------------------|
| [Existing endpoint] | [What changes] | Yes / No |

### Serializers / Blueprints

```ruby
# app/blueprints/[model]_blueprint.rb
class [Model]Blueprint < Blueprinter::Base
  identifier :id

  fields :[field1], :[field2], :[field3]

  field :created_at do |obj|
    obj.created_at.iso8601
  end

  association :[child], blueprint: [Child]Blueprint
end
```

---

## 3. Backwards Compatibility

### Compatibility Matrix

| Feature / Behavior | Web (current) | iOS (current) | iOS (v[old]) | Android (current) | Android (v[old]) |
|-------------------|:---:|:---:|:---:|:---:|:---:|
| [Behavior 1] | Full | Full | [Impact] | Full | [Impact] |
| [Behavior 2] | Full | Full | [Impact] | Full | [Impact] |

### Old Client Behavior

**iOS v[old]:**
- [What old iOS app sees/doesn't see]
- [Any degraded functionality]
- [Any data that appears differently]

**Android v[old]:**
- [What old Android app sees/doesn't see]
- [Any degraded functionality]

### API Versioning

[Does this change require API versioning? If so, what approach?]

### Data Migration

| Migration | Strategy | Rollback |
|-----------|----------|----------|
| [Existing data change] | [How: batch update, background job] | [How to undo] |

---

## 4. Security Design

### Query Scoping

| Resource | Scoping Chain |
|----------|--------------|
| [Resource] | `current_account.[collection].find(...)` |
| [Nested resource] | `current_account.[parent_collection].find(...)[child_collection]` |

### Authorization

| Action | Permitted Roles | Check |
|--------|----------------|-------|
| [Action 1] | [Admin, Manager, etc.] | [How verified] |
| [Action 2] | [Roles] | [How verified] |

### New Attack Surface

| Vector | Risk | Mitigation |
|--------|------|------------|
| [Vector] | [Risk level] | [How mitigated] |

---

## 5. Export Impact

| Export | Format | Changes | Backwards Compatible? |
|-------|--------|---------|----------------------|
| [Export name] | [PDF/Excel/CSV] | [What changes] | [Yes/No] |

---

## 6. Open Questions for Human Review

| # | Question | Options | Recommendation |
|---|----------|---------|---------------|
| 1 | [Decision needed] | A: [option] / B: [option] | [Agent's recommendation with rationale] |
| 2 | [Decision needed] | [Options] | [Recommendation] |

---

## 7. Alternatives Considered

### [Alternative Approach Name]

**Description:** [What the alternative was]
**Pros:** [Advantages]
**Cons:** [Disadvantages]
**Why rejected:** [Reason]

---

## 8. Summary

### Files to Create
| File | Purpose |
|------|---------|
| `app/models/[model].rb` | [Purpose] |
| `app/controllers/api/v1/[controller].rb` | [Purpose] |
| `app/blueprints/[blueprint].rb` | [Purpose] |
| `db/migrate/[timestamp]_create_[table].rb` | [Purpose] |

### Files to Modify
| File | Changes |
|------|---------|
| `app/models/[existing_model].rb` | Add association |
| `config/routes.rb` | Add new routes |

---

## Approval Checklist

> **This architecture proposal requires human review and approval before the gameplan is generated.**

### Reviewer: [Name]
### Date: [Date]
### Status: [Pending / Approved / Approved with Modifications / Rejected]

#### Must Verify
- [ ] Data model is architecturally sound (tables, columns, relationships, constraints)
- [ ] API design is consistent with existing patterns (envelopes, error format, pagination)
- [ ] Backwards compatibility is handled correctly (compatibility matrix filled out)
- [ ] Security scoping is correct (all queries scoped to account, authorization checked)
- [ ] Migration strategy is safe (concurrent indexes, backfill approach)

#### Should Check
- [ ] Serializer design matches existing conventions
- [ ] Export impact is addressed
- [ ] Open questions are answerable
- [ ] API payloads are complete enough for mobile engineers to build against
- [ ] No conflicts with in-progress work or upcoming changes

#### Notes
[Reviewer notes, modifications requested, or rejection reasons]
