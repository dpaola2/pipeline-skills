---
name: create-pr
description: "Push the implementation branch and create a PR against the default branch with a generated summary from project artifacts."
disable-model-invocation: true
argument-hint: "<project-slug>"
allowed-tools:
  - Read
  - Glob
  - Grep
  - Bash
---

# Create PR

You **push the implementation branch and create a GitHub pull request** against the default branch (from `pipeline.md`) with a summary generated from the project's pipeline artifacts. This is the delivery step after all pipeline stages are complete.

**This skill does not write or modify any files.** It reads project artifacts, generates a PR summary, and runs git/gh commands.

## Inputs

- `projects/$ARGUMENTS/progress.md` — milestone table, commit SHAs, test counts, files summary
- `projects/$ARGUMENTS/qa-plan.md` — manual test scenario count, known limitations
- `projects/$ARGUMENTS/gameplan.md` — project overview, milestone descriptions
- `projects/$ARGUMENTS/prd.md` — project name and level (from header)

## Pre-Flight Checks (MANDATORY)

Run ALL of these checks before doing anything else. If any check fails, **STOP** and report the issue to the user.

First, read `pipeline.md` to determine the primary repository path, branch prefix, and PR base branch.

### Check 1: All Milestones Complete

Read `projects/$ARGUMENTS/progress.md` and check the **Milestone Status** table.

- If ALL milestones are marked **Complete** → proceed.
- If ANY milestone is still **Pending** or **In Progress** → **STOP**:

> "Not all milestones are complete. Remaining: [list pending milestones]. Complete them before creating a PR."

### Check 2: QA Plan Exists

Verify `projects/$ARGUMENTS/qa-plan.md` exists.

- If it exists → proceed.
- If missing → **STOP**:

> "No QA plan found. Run `/stage7-qa-plan $ARGUMENTS` first."

### Check 3: Branch Exists in Primary Repo

In the primary repository (path from `pipeline.md`), verify the project branch exists:

```bash
cd <primary-repo-path> && git branch --list '<branch-prefix>$ARGUMENTS'
```

If the branch does not exist, **STOP**:

> "The branch `<branch-prefix>$ARGUMENTS` does not exist in the primary repository."

### Check 4: Clean Working Tree

```bash
cd <primary-repo-path> && git status --porcelain
```

If there are uncommitted changes, **STOP**:

> "The primary repository has uncommitted changes. Please commit or stash them before creating a PR."

### Check 5: No Existing PR

Check whether a PR already exists for this branch:

```bash
cd <primary-repo-path> && gh pr list --head '<branch-prefix>$ARGUMENTS' --state open --json number,url
```

If a PR already exists, **STOP** and show its URL:

> "A PR already exists for this branch: [URL]. To update the PR description, close the existing PR first or update it manually."

## Step-by-Step Procedure

### 1. Read Project Artifacts

Read these files and extract the data needed for the PR summary:

1. **`projects/$ARGUMENTS/progress.md`** — extract:
   - Milestone status table (milestone names, descriptions, commit SHAs)
   - "Project Complete" section (total commits, test count, files created/modified)

2. **`projects/$ARGUMENTS/qa-plan.md`** — extract:
   - Count of manual test scenarios (QA-NNN entries in Section 4)
   - Key feature areas covered (section headings under Section 4)
   - Known limitations count and list (Section 6)

3. **`projects/$ARGUMENTS/gameplan.md`** — extract:
   - Project overview (first paragraph under "Project Overview" or "Overview")
   - This becomes the PR summary description

4. **`projects/$ARGUMENTS/prd.md`** — extract:
   - Feature name from the document title
   - Project level from the header table

### 2. Generate PR Title

The PR title should be:
- Derived from the feature name in the PRD/gameplan
- Under 70 characters
- Descriptive of what the feature does (not implementation details)

Example: `Add Deficient Line Item Report`

### 3. Generate PR Body

Assemble the PR body using this structure:

```markdown
## Summary

[2-3 sentence description from gameplan project overview. What does this feature do? Who is it for?]

### Milestones

| Milestone | Description | Commit |
|-----------|-------------|--------|
[One row per milestone from progress.md, including QA Test Data if present]

### Test Results

- **[N]** automated tests, **0** failures
- Test files: [comma-separated list of spec files]

### Files Changed

- **[N]** new files ([brief breakdown: migration, model, service, etc.])
- **[N]** modified files ([brief breakdown])

### QA Plan

**[N]** manual test scenarios covering [list key feature areas from qa-plan.md Section 4 headings].

Full QA plan: `projects/[slug]/qa-plan.md` in the agent-pipeline repo.

### Known Limitations

[Bulleted list of the most significant items from qa-plan.md Section 6. Keep it to the top 5-7 items. If none, write "None."]

---

Generated by the Agent Pipeline
```

### 4. Push the Branch

```bash
cd <primary-repo-path> && git push -u origin <branch-prefix>$ARGUMENTS
```

If the push fails, **STOP** and report the error to the user.

### 5. Create the PR

```bash
cd <primary-repo-path> && gh pr create \
  --base <pr-base-branch> \
  --head "<branch-prefix>$ARGUMENTS" \
  --title "[title]" \
  --body "$(cat <<'EOF'
[generated PR body]
EOF
)"
```

Use a HEREDOC for the body to preserve formatting.

## What NOT To Do

- **Do not write or modify any files.** This skill only reads and runs commands.
- **Do not push to the default branch directly.** Always push to the `<branch-prefix>$ARGUMENTS` branch.
- **Do not merge the PR.** Only create it. Human merges after review.
- **Do not force-push.** If the push fails, stop and ask the user.
- **Do not create the PR if one already exists.** Pre-flight Check 5 catches this.
- **Do not include test data credentials in the PR body.** Those are in the QA plan, not the PR.

## When You're Done

Tell the user:
1. The PR URL
2. Summary stats: milestones, test count, files changed
3. **Remind them:** "Share the QA plan (`projects/$ARGUMENTS/qa-plan.md`) with the tester when QA begins."
